# CSV导入功能支持新建数据库 - 测试说明

## 问题描述

之前的CSV导入功能只支持预配置的数据源（chembl33、tcrd6124expr2、login），不能对用户新建的数据库进行上传操作。

## 修复内容

1. **后端修改**：
   - 新增API端点 `/api/database/datasources/databases`
   - 该端点返回所有可用数据库（包括用户创建的数据库）
   - 自动过滤系统数据库，处理权限验证

2. **前端修改**：
   - 更新CsvImporter组件的数据源加载逻辑
   - 使用新API获取所有数据库列表
   - 更新UI标签，将"数据源"改为"目标数据库"

## 测试步骤

### 前置条件

1. 确保系统正常运行
2. 使用管理员或普通用户登录系统

### 测试步骤text

#### 1. 创建新数据库

1. 进入"数据库管理"页面
2. 点击"新建数据库"
3. 创建一个测试数据库，例如：`test_csv_import`
4. 确认数据库创建成功

#### 2. 在新数据库中创建测试表

1. 选择新创建的数据库
2. 创建一个测试表，例如：

   ```sql
   CREATE TABLE test_users (
       id INT AUTO_INCREMENT PRIMARY KEY,
       name VARCHAR(50) NOT NULL,
       email VARCHAR(100),
       age INT,
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

#### 3. 准备测试CSV文件

创建一个名为 `test_users.csv` 的文件：

```csv
name,email,age
张三,zhangsan@example.com,25
李四,lisi@example.com,30
王五,wangwu@example.com,28
赵六,zhaoliu@example.com,35
```

#### 4. 测试CSV导入功能

1. 进入"数据导入"页面
2. 上传准备好的CSV文件
3. **关键验证点**：在"目标数据库"下拉框中，应该能看到：
   - chembl33（ChEMBL 33）
   - tcrd6124expr2（TCRD 6.12.4）
   - test_csv_import（新创建的数据库）
   - 其他用户创建的数据库（如果存在）
4. 选择新创建的数据库 `test_csv_import`
5. 选择目标表 `test_users`
6. 配置CSV解析参数（编码：UTF-8，分隔符：逗号，包含标题行：勾选）
7. 点击"解析文件"

#### 5. 验证数据预览和列映射

1. 确认能正确解析CSV文件并显示4条记录
2. 检查列映射配置：
   - CSV列：name, email, age
   - 数据库列：name, email, age（应该自动匹配）
   - id列不需要映射（自动递增）
3. 点击"验证并继续"
4. 确认数据验证通过

#### 6. 执行导入

1. 选择导入模式（普通模式或事务模式）
2. 点击"开始导入"
3. 确认导入成功，显示：
   - 总记录数：4
   - 成功导入：4
   - 失败记录：0

#### 7. 验证导入结果

1. 回到"数据库管理"页面
2. 选择 `test_csv_import` 数据库
3. 查看 `test_users` 表数据
4. 确认4条记录都已正确导入

#### 8. 测试权限控制（如果适用）

1. 使用普通用户登录
2. 进入CSV导入页面
3. 确认普通用户不能看到login数据库选项
4. 确认可以看到其他数据库选项

## 预期结果

### 成功标准

- ✅ 能在CSV导入页面看到所有可用数据库（包括新建的）
- ✅ 能选择新建的数据库作为导入目标
- ✅ 能正确加载新建数据库中的表列表
- ✅ 能成功导入数据到新建数据库的表中
- ✅ 导入历史记录正确显示数据库名称
- ✅ 权限控制正常工作（普通用户看不到login数据库）

### 界面变化

- "数据源"标签改为"目标数据库"
- 数据库选项包含所有可用数据库，不仅仅是预配置的数据源
- 导入历史记录中的"数据源"列改为"数据库"列

## 故障排除

### 问题1：看不到新建的数据库

**可能原因**：

- 数据库创建失败
- 权限不足
- API调用失败

**解决方法**：

1. 检查数据库是否真的创建成功
2. 检查浏览器控制台错误信息
3. 检查后端日志

### 问题2：选择新数据库后表列表为空

**可能原因**：

- 数据库中没有表
- 权限问题

**解决方法**：

1. 确认数据库中确实有表
2. 检查表名是否正确
3. 检查用户权限

### 问题3：导入失败

**可能原因**：

- 列映射错误
- 数据类型不匹配
- 表结构问题

**解决方法**：

1. 检查列映射配置
2. 确认CSV数据格式正确
3. 检查表结构定义

## 技术细节

### API变化

- 新增端点：`GET /api/database/datasources/databases`
- 返回所有可用数据库列表
- 自动处理权限过滤

### 前端变化

- `CsvImporter.vue`：更新数据源加载逻辑
- `Import.vue`：更新标签文本
- `api.js`：新增API方法

### 数据库支持

- 支持所有用户创建的数据库
- 自动使用默认数据源连接（chembl33）访问用户数据库
- 保持原有的多数据源架构

---

**测试完成后，请确认所有功能正常工作，特别是新建数据库的CSV导入功能。**
