# CSV 导入系统使用指南

## 概述
本系统支持将CSV文件导入到MySQL数据库中，提供了完整的错误处理和诊断功能。

## 🔧 空值处理优化 (新增)

### 问题描述
当CSV文件中包含空字符串时，如果对应的数据库列是数字类型（如 `decimal`, `int`, `bigint` 等），会导致插入失败：
```
Incorrect decimal value: '' for column 'pchembl_value' at row 1
Incorrect integer value: '' for column 'toid' at row 1
```

### 解决方案
系统已自动处理空字符串值：
- **数字类型列**：空字符串自动转换为 `NULL`
- **文本类型列**：保持原始空字符串值

### 支持的数字类型
- `int`, `bigint`, `smallint`, `tinyint`, `mediumint`
- `decimal`, `numeric`
- `float`, `double`
- `real`, `bit`

## 🚨 紧急故障排除

### 快速诊断流程

1. **检查错误信息**
   - 查看具体的错误消息
   - 确认失败的批次和列名

2. **验证数据库连接**
   ```javascript
   // 浏览器控制台运行
   fetch('/api/database/tables/activities/diagnose?dataSource=tzyy')
     .then(response => response.json())
     .then(data => console.log('📊 诊断结果:', data));
   ```

3. **检查表结构**
   ```sql
   USE tzyy;
   DESCRIBE activities;
   ```

4. **验证数据类型匹配**
   ```sql
   SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT
   FROM information_schema.COLUMNS 
   WHERE TABLE_SCHEMA = 'tzyy' AND TABLE_NAME = 'activities';
   ```

5. **检查CSV数据格式**
   - 确认列名匹配
   - 检查数据类型是否正确
   - 验证必填字段是否为空

6. **清理和重试**
   - 清理浏览器缓存
   - 重新选择CSV文件
   - 分批次导入（建议5000条/批次）

### 常见错误模式

#### 1. 数据类型错误
```
❌ Incorrect decimal value: '' for column 'pchembl_value'
✅ 已修复：空字符串自动转换为NULL
```

#### 2. 表不存在
```
❌ Table 'tzyy.activities' doesn't exist
✅ 解决：确认表名和数据库名正确
```

#### 3. 列名不匹配
```
❌ Unknown column 'invalid_column' in 'field list'
✅ 解决：检查CSV列名与数据库列名匹配
```

## 功能概述

本系统的CSV批量导入功能支持将CSV文件中的数据批量导入到数据库表中，具有以下特性：

- 🚀 支持百万级数据批量导入
- 📊 智能列映射和数据验证
- 🔧 分批处理，避免内存溢出
- ⚡ 事务和非事务两种导入模式
- 📈 实时进度跟踪
- 🛡️ 详细的错误报告和处理
- 📝 导入历史记录管理

## 使用步骤

### 1. 准备CSV文件

#### 文件格式要求
- **编码**: 推荐使用UTF-8编码
- **分隔符**: 支持逗号(,)、分号(;)、制表符(\t)等
- **文件大小**: 建议单个文件不超过100MB
- **行数限制**: 单次导入最多支持100万条记录

#### 数据格式要求
- **列标题**: 建议使用第一行作为列标题
- **数据类型**: 确保数据类型与目标表匹配
- **特殊字符**: 包含逗号、换行符的字段需要用引号包围
- **空值处理**: 空值用空字符串表示

### 2. 访问导入功能

1. 登录系统后，点击左侧菜单的"数据导入"
2. 进入CSV导入界面

### 3. 上传和配置

#### 步骤1: 上传CSV文件
1. 点击"选择文件"或拖拽文件到上传区域
2. 文件上传后会显示文件基本信息

#### 步骤2: 配置解析参数
- **编码格式**: 选择文件编码(UTF-8/GBK/GB2312)
- **分隔符**: 选择字段分隔符(逗号/分号/制表符)
- **首行标题**: 选择是否将第一行作为列标题

#### 步骤3: 选择目标
- **目标数据库**: 选择要导入的数据库
- **目标表**: 选择要导入的表

### 4. 数据预览和映射

#### 数据预览
- 系统会显示前10行数据供预览
- 检查数据解析是否正确

#### 列映射配置
- 左侧显示CSV文件的列
- 右侧显示数据库表的列
- 通过下拉菜单设置列映射关系
- 标记为红色的列是必填字段

### 5. 数据验证

- 系统会自动验证数据格式
- 显示验证结果和错误统计
- 必须通过验证才能进行导入

### 6. 执行导入

#### 导入模式选择
- **普通模式**: 分批处理，部分失败不影响其他数据
- **事务模式**: 全部成功或全部失败

#### 开始导入
1. 确认导入信息
2. 点击"开始导入"按钮
3. 查看实时进度和状态

### 7. 查看结果

#### 导入结果
- 总记录数、成功数、失败数
- 导入耗时统计
- 详细错误信息(如有)

#### 导入历史
- 查看历史导入记录
- 支持查看详细信息和错误报告

## 常见问题解决

### 问题1: 导入失败 - localStorage超出限制

**错误信息**: "Failed to execute 'setItem' on 'Storage': Setting the value of 'importHistory' exceeded the quota."

**原因**: 大量错误信息导致浏览器localStorage存储超出限制

**解决方案**:
1. 系统会自动清理过多的历史记录
2. 错误信息会被自动压缩
3. 如果仍然出现问题，可以手动清空导入历史

**预防措施**:
- 分批导入大量数据
- 提前验证数据格式
- 定期清理导入历史

### 问题2: 批量插入完全失败

**错误信息**: "总记录数: 100000, 成功: 0, 失败: 100000"

**可能原因**:
1. 数据库或表不存在
2. 列名映射错误
3. 数据类型不匹配
4. 数据库连接问题

**解决方案**:
1. **确认目标数据库和表**:
   - 检查数据库是否存在
   - 确认表名正确
   - 验证有访问权限

2. **检查列映射**:
   - 确保CSV列名与数据库字段名正确映射
   - 检查必填字段是否都已映射
   - 验证数据类型是否匹配

3. **数据格式检查**:
   - 检查数据是否包含特殊字符
   - 验证数值格式是否正确
   - 确认日期格式是否匹配

### 问题3: 部分数据导入失败

**现象**: 成功导入部分数据，但有失败记录

**处理方法**:
1. 查看详细错误信息
2. 找出失败原因(数据格式、约束冲突等)
3. 修复原始数据后重新导入失败的部分

## 最佳实践

### 数据准备
1. **数据清洗**: 导入前清理数据，去除无效字符
2. **格式统一**: 确保日期、数值格式一致
3. **编码规范**: 统一使用UTF-8编码
4. **测试导入**: 先用小量数据测试

### 导入策略
1. **分批导入**: 大量数据分成多个较小的文件
2. **错误处理**: 预留处理失败数据的时间
3. **备份数据**: 导入前备份目标表数据
4. **监控进度**: 关注导入进度和错误信息

### 性能优化
1. **批处理大小**: 默认5000条/批，可根据系统性能调整
2. **索引管理**: 大量数据导入时考虑暂时禁用索引
3. **连接池**: 确保数据库连接池配置合理
4. **内存管理**: 避免同时导入多个大文件

### 错误处理
1. **日志记录**: 保存详细的导入日志
2. **错误分析**: 分析错误模式，预防类似问题
3. **数据恢复**: 制定数据恢复计划
4. **用户通知**: 及时通知用户导入状态

## 技术参数

### 系统限制
- 单次导入最大记录数: 100万条
- 单个文件大小限制: 100MB
- 批处理大小: 5000条/批
- 导入历史记录: 最多30条

### 支持格式
- CSV文件编码: UTF-8, GBK, GB2312
- 字段分隔符: 逗号, 分号, 制表符
- 文本限定符: 双引号, 单引号

### 性能指标
- 导入速度: 约5000-10000条/秒(视数据复杂度)
- 内存使用: 分批处理，避免内存溢出
- 连接池: 支持并发处理

## 故障排除

### 常见错误代码
1. **E001**: 文件格式不支持
2. **E002**: 文件编码错误
3. **E003**: 数据库连接失败
4. **E004**: 表不存在
5. **E005**: 列映射错误
6. **E006**: 数据类型不匹配
7. **E007**: 约束冲突
8. **E008**: 权限不足

### 调试步骤
1. 检查系统日志
2. 验证数据格式
3. 测试数据库连接
4. 确认权限配置
5. 联系系统管理员

## 更新日志

### v1.2.0 (2024-01-16)
- 修复localStorage超出限制问题
- 改进批量插入错误处理
- 增加数据库和表验证逻辑
- 优化错误信息存储和显示

### v1.1.0 (2024-01-15)
- 支持用户创建的数据库导入
- 增加导入历史记录管理
- 改进进度跟踪和错误报告

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持基本CSV导入功能 