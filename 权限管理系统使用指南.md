# 三级用户权限管理系统使用指南

## 系统概述

本系统实现了一个三级用户权限管理体系：

### 用户角色层级

1. **管理员 (admin)** - 一级用户
   - 最高权限级别
   - 可以创建内部用户
   - 可以为内部用户授权/撤销表写权限
   - 可以访问所有数据库和表
   - 可以使用权限管理界面

2. **内部用户 (internal)** - 二级用户
   - 中等权限级别
   - 不需要注册，由管理员直接添加
   - 可以查看所有数据库和表信息
   - **没有默认写权限**，需要管理员明确授权
   - 获得授权后才能对特定表进行操作和数据导入

3. **普通用户 (guest)** - 三级用户
   - 基础权限级别
   - 需要注册登录
   - **只有读取权限**，可以查看数据库和表
   - **没有任何写操作权限**，无法修改数据或导入数据

## 部署设置

### 1. 数据库表创建

在login数据库中执行 `create_permission_tables.sql` 脚本：

```bash
mysql -u root -p login < create_permission_tables.sql
```

### 2. 创建管理员用户

```sql
INSERT INTO users (name, password, role) VALUES ('admin', 'your_password', 'admin');
```

## 功能使用

### 管理员功能

#### 访问权限管理界面

1. 使用管理员账户登录
2. 在左侧菜单中点击"权限管理"（仅管理员可见）

#### 创建内部用户

1. 在权限管理界面点击"创建内部用户"
2. 输入用户名和密码
3. 点击"创建"完成

#### 授权表写权限

1. 在权限管理界面点击"授权权限"
2. 选择目标内部用户
3. 输入数据库名（如：default）
4. 输入表名（如：users）
5. 可选设置过期时间（留空表示永久有效）
6. 点击"授权"完成

#### 撤销权限

在权限记录列表中，点击对应记录的"撤销"按钮

#### 查看用户权限

点击内部用户列表中的"查看权限"按钮，查看该用户的所有权限记录

### 内部用户使用

1. 使用管理员提供的用户名密码登录（通过管理员登录界面）
2. 可以查看所有数据库和表结构
3. 只能对已授权的表进行写操作（插入、更新、删除、导入数据）
4. 未授权的表只能查看，无法修改

### 普通用户使用

1. 注册新账户（角色固定为guest）
2. 通过用户登录界面登录
3. 只能查看数据库和表信息
4. 无法进行任何写操作

## 权限验证机制

### 表级别权限控制

- 系统对每个表的写操作都进行精确权限验证
- 内部用户需要在`user_table_write_access`表中有对应的有效记录
- 支持权限过期时间设置

### 操作权限矩阵

| 操作类型 | 管理员(admin) | 内部用户(internal) | 普通用户(guest) |
|----------|---------------|-------------------|-----------------|
| 查看数据库/表 | ✅ | ✅ | ✅ |
| 插入数据 | ✅ | 需授权 | ❌ |
| 更新数据 | ✅ | 需授权 | ❌ |
| 删除数据 | ✅ | 需授权 | ❌ |
| 导入数据 | ✅ | 需授权 | ❌ |
| 创建表 | ✅ | ❌ | ❌ |
| 删除表 | ✅ | ❌ | ❌ |
| 权限管理 | ✅ | ❌ | ❌ |

## API 接口

### 权限管理 API

- `POST /api/admin/permissions/grant` - 授权权限
- `POST /api/admin/permissions/revoke` - 撤销权限
- `GET /api/admin/permissions/all` - 获取所有权限记录
- `GET /api/admin/permissions/user/{userId}` - 获取用户权限
- `POST /api/admin/permissions/create-internal-user` - 创建内部用户
- `GET /api/admin/permissions/internal-users` - 获取内部用户列表

### 权限验证

所有写操作API都会进行表级别权限验证：
- 管理员：自动通过
- 内部用户：检查`user_table_write_access`表
- 普通用户：自动拒绝

## 安全特性

1. **最小权限原则**：用户只获得执行其任务所需的最小权限
2. **权限继承**：管理员 > 内部用户 > 普通用户的清晰层级
3. **细粒度控制**：精确到表级别的权限控制
4. **权限过期**：支持临时权限授权
5. **审计日志**：记录所有权限变更操作
6. **前端路由保护**：确保权限管理界面只有管理员可访问

## 数据库设计

### users 表
```sql
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role ENUM('guest', 'internal', 'admin') NOT NULL DEFAULT 'guest',
  INDEX idx_role (role),
  INDEX idx_name (name)
);
```

### user_table_write_access 表
```sql
CREATE TABLE user_table_write_access (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  database_name VARCHAR(100) NOT NULL,
  table_name VARCHAR(100) NOT NULL,
  granted_by BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NULL,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (granted_by) REFERENCES users(id),
  UNIQUE KEY unique_user_table (user_id, database_name, table_name)
);
```

## 故障排除

### 常见问题

1. **权限不足错误**
   - 确认用户角色是否正确
   - 检查是否有对应表的权限记录
   - 验证权限是否已过期

2. **无法访问权限管理界面**
   - 确认用户是否为管理员角色
   - 检查前端路由守卫是否生效

3. **内部用户无法操作数据**
   - 检查`user_table_write_access`表中是否有对应记录
   - 确认权限未过期

### 日志查看

查看后端日志中的权限相关信息：
```bash
tail -f logs/application.log | grep -i permission
```

## 升级说明

从旧版本升级时：
1. 备份现有数据库
2. 执行`create_permission_tables.sql`脚本
3. 重启应用程序
4. 测试权限功能是否正常
