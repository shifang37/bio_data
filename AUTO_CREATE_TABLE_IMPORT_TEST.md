# 自动建表导入功能测试指南

## 功能概述

新增的自动建表导入功能允许用户无需预先创建表结构，系统将根据CSV文件的字段名和数据内容自动推断数据类型并创建表，然后导入数据。

### 主要特性

1. **智能数据类型推断**：根据CSV数据内容自动推断MySQL字段类型
2. **自动表创建**：使用CSV文件名作为表名，自动创建表结构
3. **兼容现有策略**：支持追加和覆盖导入策略
4. **事务支持**：支持事务性和非事务性导入
5. **用户友好**：专为非技术用户设计，简化导入流程

## 数据类型推断规则

系统会分析CSV数据的前100行，根据以下规则推断字段类型：

| 数据特征 | 推断类型 | 示例 |
|---------|---------|------|
| 纯数字（整数） | INT / BIGINT | 123, 456789 |
| 小数 | DECIMAL(10,2) | 123.45, 67.89 |
| 日期格式 | DATETIME | 2024-01-01, 2024-01-01 12:00:00 |
| 短文本（≤255字符） | VARCHAR(动态长度) | 姓名、邮箱等 |
| 长文本（>255字符） | TEXT | 描述、备注等 |
| 空值或混合类型 | VARCHAR(255) | 默认类型 |

## 测试准备

### 1. 准备测试CSV文件

#### 文件1：employees.csv（基础测试）
```csv
name,email,age,salary,hire_date
张三,zhangsan@company.com,25,5000.50,2024-01-15
李四,lisi@company.com,30,6000.00,2024-02-01
王五,wangwu@company.com,28,5500.75,2024-01-20
```

#### 文件2：products.csv（复杂数据类型测试）
```csv
product_name,description,price,in_stock,category_id,created_at
笔记本电脑,高性能办公笔记本电脑，适合商务人士使用,4999.99,1,1,2024-01-01 10:00:00
无线鼠标,人体工学设计无线鼠标,99.50,1,2,2024-01-02 11:30:00
机械键盘,青轴机械键盘，适合游戏和编程,299.00,0,2,2024-01-03 14:15:00
```

#### 文件3：mixed_data.csv（混合数据类型测试）
```csv
id,text_field,number_field,decimal_field,date_field,boolean_field
1,短文本,100,23.45,2024-01-01,1
2,这是一个比较长的文本字段测试数据用来验证VARCHAR和TEXT类型的推断逻辑,200,67.89,2024-02-01,0
3,,300,99.99,2024-03-01,1
```

### 2. 创建测试数据库

确保有一个测试数据库（如果使用用户创建的数据库功能）：
```sql
CREATE DATABASE test_auto_import CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 测试步骤

### 测试1：基础自动建表功能

1. **访问CSV导入页面**
   - 登录系统，点击"数据导入"菜单

2. **上传CSV文件**
   - 上传 `employees.csv` 文件
   - 系统应自动将表名设置为 `employees`

3. **选择导入方式**
   - 选择"自动建表导入"
   - 选择目标数据库

4. **配置解析参数**
   - 编码：UTF-8
   - 分隔符：逗号
   - 包含标题行：是

5. **解析文件并预览**
   - 点击"解析文件"
   - 查看数据预览和字段信息预览表格
   - 验证推断的数据类型是否正确：
     - `name`: VARCHAR(255)
     - `email`: VARCHAR(255)
     - `age`: INT
     - `salary`: DECIMAL(10,2)
     - `hire_date`: DATETIME

6. **执行导入**
   - 选择导入策略（首次建表建议选择追加模式）
   - 选择导入模式（普通模式或事务模式）
   - 点击"开始导入"

**预期结果**：
- 系统成功创建 `employees` 表
- 导入3条记录
- 导入结果显示"已创建新表"

### 测试2：复杂数据类型推断

1. **上传products.csv**
2. **验证字段类型推断**：
   - `product_name`: VARCHAR(255)
   - `description`: TEXT
   - `price`: DECIMAL(10,2)
   - `in_stock`: INT
   - `category_id`: INT
   - `created_at`: DATETIME

3. **执行导入并验证数据完整性**

### 测试3：表已存在的情况

1. **再次上传employees.csv**
2. **选择自动建表导入**
3. **验证系统行为**：
   - 系统检测到表已存在
   - 根据选择的导入策略执行：
     - 追加模式：检测重复数据，只导入新数据
     - 覆盖模式：清空表后重新导入

### 测试4：文件名处理

创建包含特殊字符的文件名进行测试：

#### 文件：test-data@2024.csv
```csv
field1,field2,field3
value1,value2,value3
```

验证系统是否正确将表名转换为 `test_data_2024`

### 测试5：边界情况测试

#### 5.1 空文件测试
- 上传空CSV文件
- 验证错误处理

#### 5.2 只有标题行的文件
```csv
name,email,age
```
- 验证系统是否正确处理

#### 5.3 包含NULL值的文件
```csv
name,email,age
张三,,25
,lisi@test.com,
王五,wangwu@test.com,28
```

#### 5.4 长表名测试
创建超长文件名，验证表名截取逻辑

### 测试6：权限测试

1. **使用不同权限级别的用户测试**
2. **验证数据库写权限检查**
3. **测试跨数据库建表权限**

## 验证方法

### 1. 数据库验证

执行以下SQL验证表结构和数据：

```sql
-- 查看表结构
DESCRIBE employees;

-- 查看数据
SELECT * FROM employees;

-- 验证自增主键
SHOW CREATE TABLE employees;

-- 检查字符集
SELECT TABLE_SCHEMA, TABLE_NAME, TABLE_COLLATION 
FROM information_schema.TABLES 
WHERE TABLE_NAME = 'employees';
```

### 2. 前端验证

- 导入结果页面显示正确信息
- 表创建状态显示
- 数据类型推断准确性
- 错误处理和用户提示

## 性能测试

### 大数据量测试

1. **准备包含10万条记录的CSV文件**
2. **测试自动建表+导入的性能**
3. **监控内存使用情况**
4. **验证批处理逻辑**

### 并发测试

1. **多用户同时进行自动建表导入**
2. **验证表名冲突处理**
3. **测试数据库连接池性能**

## 故障排除

### 常见问题及解决方案

1. **表名冲突**
   - 现象：提示表已存在
   - 解决：修改CSV文件名或选择合适的导入策略

2. **数据类型推断错误**
   - 现象：数据导入失败或类型不匹配
   - 解决：检查CSV数据格式，确保数据一致性

3. **权限不足**
   - 现象：建表失败
   - 解决：确保用户有CREATE TABLE权限

4. **字符编码问题**
   - 现象：中文乱码
   - 解决：确保CSV文件使用UTF-8编码

### 日志检查

查看后端日志关键信息：
- 表创建SQL语句
- 数据类型推断过程
- 导入执行状态
- 错误详细信息

## 新功能优势

1. **降低使用门槛**：不需要SQL知识即可导入数据
2. **提高效率**：无需手动创建表结构
3. **智能化处理**：自动推断最适合的数据类型
4. **错误减少**：避免手动建表的错误
5. **一致性保证**：统一的表创建规范

## 与现有功能对比

| 功能特性 | 传统导入 | 自动建表导入 |
|---------|---------|-------------|
| 前置条件 | 需要预建表 | 无需预建表 |
| 技术要求 | 需要SQL知识 | 无需技术背景 |
| 数据类型 | 手动定义 | 智能推断 |
| 错误风险 | 类型不匹配风险 | 智能处理，风险更低 |
| 适用场景 | 规范化导入 | 快速原型、数据探索 |
| 导入策略 | 支持追加/覆盖 | 支持追加/覆盖 |