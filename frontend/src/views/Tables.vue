<template>
  <div class="database-view">
    <div class="database-layout">
      <!-- Â∑¶‰æßÊï∞ÊçÆÂ∫ìÂØºËà™ -->
      <div class="database-sidebar">
                 <el-card class="sidebar-card" shadow="never">
      <template #header>
             <div class="sidebar-header">
               <div class="sidebar-title">
                 <el-icon><Coin /></el-icon>
                 <span>Êï∞ÊçÆÂ∫ì</span>
               </div>
               <el-button 
                 type="primary" 
                 size="small" 
                 @click="showCreateDatabaseDialog"
                 v-if="canCreateDatabase"
            >
                 <el-icon><Plus /></el-icon>
                 Êñ∞Âª∫
               </el-button>
             </div>
           </template>
          
          <div class="database-list">
            <div
                v-for="db in availableDatabases"
                :key="db.name"
              class="database-item"
              :class="{ active: selectedDatabase === db.name }"
            >
              <div 
                class="database-content"
                @click="selectDatabase(db.name)"
              >
                <div class="database-icon">
                  <el-icon v-if="selectedDatabase === db.name">
                    <FolderOpened />
                  </el-icon>
                  <el-icon v-else>
                    <Folder />
                  </el-icon>
                </div>
                <div class="database-info">
                  <div class="database-name">{{ db.displayName }}</div>
                  <div class="database-desc">{{ db.description }}</div>
                </div>
              </div>
              
              <!-- Âà†Èô§ÊåâÈíÆÔºà‰ªÖÂØπÁî®Êà∑ÂàõÂª∫ÁöÑÊï∞ÊçÆÂ∫ìÊòæÁ§∫Ôºå‰∏î‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅÔºâ -->
              <div 
                v-if="canDeleteDatabase(db) && canCreateDatabase" 
                class="database-actions"
                @click.stop
              >
                <el-button 
                  type="danger" 
                  size="small" 
                  :icon="Delete"
                  circle
                  @click="showDeleteDatabaseDialog(db)"
                  title="Âà†Èô§Êï∞ÊçÆÂ∫ì"
                />
              </div>
            </div>
          </div>
        </el-card>
      </div>

      <!-- Âè≥‰æßÂÜÖÂÆπÂå∫Âüü -->
      <div class="database-content">
        <div class="database-content-layout">
          <!-- Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÂå∫Âüü -->
          <el-card class="database-info-card" v-if="selectedDatabase">
            <template #header>
              <div class="card-header">
                <div class="database-title">
                  <el-icon><Coin /></el-icon>
                  <span>{{ getSelectedDatabaseInfo()?.displayName || selectedDatabase }}</span>
                </div>
                <el-button type="primary" @click="loadTables" :loading="loadingTables">
                  <el-icon><Refresh /></el-icon>
                  Âà∑Êñ∞
                </el-button>
              </div>
            </template>
            
            <!-- ÊùÉÈôêÊèêÁ§∫ -->
            <div v-if="permissionMessage" class="permission-alert">
              <el-alert
                :title="permissionMessage"
                type="warning"
                show-icon
                :closable="false"
                style="margin-bottom: 15px;"
              />
            </div>
            
            <!-- Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÂ±ïÁ§∫ -->
            <div v-if="canAccessCurrentDatabase">
              <el-row :gutter="20" v-if="databaseInfo">
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">ÂΩìÂâçÊï∞ÊçÆÂ∫ì</div>
                    <div style="font-size: 24px; font-weight: bold; color: #303133;">{{ databaseInfo.name || selectedDatabase }}</div>
                  </el-card>
                </el-col>
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">Êï∞ÊçÆË°®ÊÄªÊï∞</div>
                    <div style="font-size: 24px; font-weight: bold; color: #303133;">{{ databaseInfo.tableCount || 0 }}</div>
                  </el-card>
                </el-col>
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">Êï∞ÊçÆÂ∫ìÂ§ßÂ∞è</div>
                    <div style="font-size: 24px; font-weight: bold; color: #303133;">{{ databaseInfo.sizeDisplay || 'N/A' }}</div>
                  </el-card>
                </el-col>
              </el-row>
              
              <!-- Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÂä†ËΩΩ‰∏≠ -->
              <el-row :gutter="20" v-else>
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">ÂΩìÂâçÊï∞ÊçÆÂ∫ì</div>
                    <div style="font-size: 24px; font-weight: bold; color: #303133;">{{ selectedDatabase }}</div>
                  </el-card>
                </el-col>
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">Êï∞ÊçÆË°®ÊÄªÊï∞</div>
                    <div style="font-size: 24px; font-weight: bold; color: #409EFF;">Âä†ËΩΩ‰∏≠...</div>
                  </el-card>
                </el-col>
                <el-col :span="8">
                  <el-card shadow="never" style="text-align: center;">
                    <div style="font-size: 12px; color: #909399; margin-bottom: 8px;">Êï∞ÊçÆÂ∫ìÂ§ßÂ∞è</div>
                    <div style="font-size: 24px; font-weight: bold; color: #409EFF;">Âä†ËΩΩ‰∏≠...</div>
                  </el-card>
                </el-col>
              </el-row>
            </div>
          </el-card>

          <!-- Êï∞ÊçÆË°®ÂàóË°® -->
          <el-card class="tables-card" v-if="selectedDatabase">
            <template #header>
              <div class="card-header">
                <div class="card-title">
                  <span>Êï∞ÊçÆË°®ÂàóË°®</span>
                  <el-button 
                    v-if="canAccessCurrentDatabase && canModifyCurrentDatabase && isUserDatabase(selectedDatabase)"
                    type="success" 
                    size="small" 
                    @click="showCreateTableDialog"
                    style="margin-left: 15px;"
                  >
                    <el-icon><Plus /></el-icon>
                    Êñ∞Âª∫Ë°®
                  </el-button>
                </div>
                <div v-if="canAccessCurrentDatabase" style="display: flex; align-items: center; gap: 10px;">
                  <!-- Â≠óÊÆµÂÄºÊêúÁ¥¢Ê°Ü -->
                  <el-input
                    v-model="fieldSearchQuery"
                    placeholder="ÊåâÂ≠óÊÆµÂÄºÊêúÁ¥¢ÔºàÊô∫ËÉΩÊ®°ÂºèÔºâ..."
                    style="width: 200px;"
                    clearable
                    @keyup.enter="searchTablesByFieldValue"
                  >
                    <template #prefix>
                      <el-icon><Search /></el-icon>
                    </template>
                  </el-input>
                  
                  <!-- ÊêúÁ¥¢Á±ªÂûã‰∏ãÊãâÈÄâÊã©Âô® -->
                  <el-dropdown 
                    @command="handleSearchCommand"
                    :loading="fieldSearching"
                    size="small"
                  >
                    <el-button 
                      type="primary" 
                      size="small"
                      :loading="fieldSearching"
                    >
                      Â≠óÊÆµÊêúÁ¥¢
                      <el-icon class="el-icon--right"><arrow-down /></el-icon>
                    </el-button>
                    <template #dropdown>
                      <el-dropdown-menu>
                        <el-dropdown-item 
                          command="fuzzy"
                          :icon="Search"
                        >
                          Ê®°Á≥äÊêúÁ¥¢
                          <span style="color: #999; font-size: 12px; margin-left: 8px;">(ÂåÖÂê´ÊêúÁ¥¢ÂÄº)</span>
                        </el-dropdown-item>
                        <el-dropdown-item 
                          command="exact"
                          :icon="Aim"
                        >
                          Á≤æÁ°ÆÊêúÁ¥¢
                          <span style="color: #999; font-size: 12px; margin-left: 8px;">(ÂÆåÂÖ®ÂåπÈÖç)</span>
                        </el-dropdown-item>
                      </el-dropdown-menu>
                    </template>
                  </el-dropdown>
                  
                  <!-- Ë°®ÂêçÊêúÁ¥¢Ê°Ü -->
                  <el-input
                    v-model="searchQuery"
                    placeholder="ÊêúÁ¥¢Ë°®Âêç..."
                    style="width: 200px;"
                    clearable
                  >
                    <template #prefix>
                      <el-icon><Search /></el-icon>
                    </template>
                  </el-input>
                </div>
              </div>
            </template>
            
            <!-- Â≠óÊÆµÊêúÁ¥¢ÈîôËØØ‰ø°ÊÅØ -->
                      <div v-if="fieldSearchError" style="margin-bottom: 20px;">
            <el-alert 
              :title="fieldSearchError" 
              type="error" 
              :closable="false"
              show-icon
            />
          </div>

          <!-- ÊêúÁ¥¢ÂäüËÉΩÊèêÁ§∫ -->
          <div v-if="searchDialogs.length > 0" style="margin-bottom: 15px;">
            <el-alert
              title="üí° ÊèêÁ§∫"
              type="info"
              :closable="false"
              show-icon
            >
              <template #default>
                <p style="margin: 0;">ÂΩìÂâç‰øùÁïô‰∫Ü {{ searchDialogs.length }} ‰∏™ÊêúÁ¥¢ÁªìÊûúÂºπÁ™ó„ÄÇÂàáÊç¢Êï∞ÊçÆÂ∫ì‰∏ç‰ºöÂΩ±ÂìçËøô‰∫õÊêúÁ¥¢ÁªìÊûúÔºåÂÆÉ‰ª¨‰ºö‰∏ÄÁõ¥‰øùÁïôÁõ¥Âà∞ÊÇ®ÊâãÂä®ÂÖ≥Èó≠„ÄÇ</p>
              </template>
            </el-alert>
          </div>

            <!-- ÊúâÊùÉÈôêËÆøÈóÆÊó∂ÊòæÁ§∫Ë°®Ê†º -->
            <div v-if="canAccessCurrentDatabase" class="table-container">
              <el-table 
                :data="filteredTableList" 
                style="width: 100%" 
                :max-height="getTableMaxHeight()"
                @row-click="selectTable"
                v-loading="loadingTables"
                element-loading-text="Âä†ËΩΩË°®Êï∞ÊçÆ‰∏≠..."
              >
                <el-table-column prop="TABLE_NAME" label="Ë°®Âêç" width="250" sortable />
                <el-table-column label="Ë°åÊï∞" width="120" sortable>
                  <template #default="scope">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span>{{ getTableRowCount(scope.row.TABLE_NAME) || scope.row.TABLE_ROWS?.toLocaleString() || 'N/A' }}</span>
                      <el-button 
                        size="small" 
                        type="primary" 
                        text
                        @click="refreshTableRowCount(scope.row.TABLE_NAME)"
                        title="Âà∑Êñ∞ÂáÜÁ°ÆË°åÊï∞"
                      >
                        <el-icon><Refresh /></el-icon>
                      </el-button>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column prop="DATA_LENGTH" label="Êï∞ÊçÆÂ§ßÂ∞è" width="120" sortable>
                  <template #default="scope">
                    {{ formatBytes(scope.row.DATA_LENGTH) }}
                  </template>
                </el-table-column>
                <el-table-column prop="CREATE_TIME" label="ÂàõÂª∫Êó∂Èó¥" width="180" sortable>
                  <template #default="scope">
                    {{ formatDate(scope.row.CREATE_TIME) }}
                  </template>
                </el-table-column>
                <el-table-column prop="TABLE_COMMENT" label="Ê≥®Èáä" show-overflow-tooltip />
                <el-table-column label="Êìç‰Ωú" width="350" fixed="right">
                  <template #default="scope">
                    <el-button size="small" @click="viewTableData(scope.row.TABLE_NAME)">
                      Êü•ÁúãÊï∞ÊçÆ
                    </el-button>
                    <el-button size="small" @click="viewTableStructure(scope.row.TABLE_NAME)">
                      Ë°®ÁªìÊûÑ
                    </el-button>
                    <el-button 
                      size="small" 
                      type="success"
                      @click="showExportDialog(scope.row.TABLE_NAME)"
                      :icon="Download"
                    >
                      ÂØºÂá∫
                    </el-button>
                    <el-button 
                      v-if="canModifyCurrentDatabase && isUserDatabase(selectedDatabase)"
                      size="small" 
                      type="danger"
                      @click="confirmDeleteTable(scope.row.TABLE_NAME)"
                    >
                      Âà†Èô§Ë°®
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>
              
              <!-- Á©∫Áä∂ÊÄÅ -->
              <el-empty v-if="!loadingTables && filteredTableList.length === 0" description="Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Ë°®" />
            </div>
            
            <!-- Êó†ÊùÉÈôêËÆøÈóÆÊó∂ÊòæÁ§∫ÊèêÁ§∫ -->
            <div v-else>
              <el-empty description="ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÊ≠§Êï∞ÊçÆÂ∫ì">
                <template #image>
                  <div style="font-size: 60px; color: #f56c6c;">üîí</div>
                </template>
              </el-empty>
            </div>
          </el-card>

          <!-- ËØ∑ÈÄâÊã©Êï∞ÊçÆÂ∫ìÊèêÁ§∫ -->
          <el-card v-else class="welcome-card">
            <el-empty description="ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Êï∞ÊçÆÂ∫ìÊù•Êü•ÁúãÂÖ∂Ë°®ÁªìÊûÑ">
              <template #image>
                <div style="font-size: 60px; color: #409eff;">
                  <el-icon><Coin /></el-icon>
                </div>
              </template>
            </el-empty>
          </el-card>
        </div>
      </div>
    </div>

    <!-- Ë°®ÁªìÊûÑÂØπËØùÊ°Ü -->
    <el-dialog v-model="structureDialogVisible" :title="`Ë°®ÁªìÊûÑ - ${selectedTable}`" width="80%">
      <div style="margin-bottom: 15px;">
        <el-alert
          title="‰øÆÊîπË°®ÁªìÊûÑ"
          description="ÊÇ®ÂèØ‰ª•‰øÆÊîπÂàóÁöÑÊï∞ÊçÆÁ±ªÂûãÊù•Ëß£ÂÜ≥Êï∞ÊçÆËåÉÂõ¥ÈóÆÈ¢ò„ÄÇ‰øÆÊîπÂâçËØ∑Á°Æ‰øùÊï∞ÊçÆÂÆâÂÖ®„ÄÇ"
          type="info"
          :closable="false"
          show-icon
        />
      </div>
      
      <!-- Â§çÂêà‰∏ªÈîÆÊèêÁ§∫ -->
      <div v-if="primaryKeyColumns.length > 1" style="margin-bottom: 15px;">
        <el-alert
          title="Â§çÂêà‰∏ªÈîÆ"
          :description="`Ê≠§Ë°®‰ΩøÁî®Â§çÂêà‰∏ªÈîÆÔºåÂåÖÂê´‰ª•‰∏ãÂàóÔºö${primaryKeyColumns.map(col => col.COLUMN_NAME).join(', ')}`"
          type="warning"
          :closable="false"
          show-icon
        />
      </div>
      
      <el-table :data="tableColumns" style="width: 100%">
        <el-table-column prop="COLUMN_NAME" label="ÂàóÂêç" width="150" />
        <el-table-column prop="DATA_TYPE" label="ÂΩìÂâçÊï∞ÊçÆÁ±ªÂûã" width="120" />
        <el-table-column prop="IS_NULLABLE" label="ÊòØÂê¶ÂèØÁ©∫" width="100">
          <template #default="scope">
            <el-tag :type="scope.row.IS_NULLABLE === 'YES' ? 'success' : 'danger'">
              {{ scope.row.IS_NULLABLE }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="COLUMN_DEFAULT" label="ÈªòËÆ§ÂÄº" width="120" />
        <el-table-column prop="COLUMN_KEY" label="ÈîÆÁ±ªÂûã" width="100">
          <template #default="scope">
            <el-tag v-if="scope.row.COLUMN_KEY === 'PRI'" type="warning">‰∏ªÈîÆ</el-tag>
            <el-tag v-else-if="scope.row.COLUMN_KEY === 'UNI'" type="info">ÂîØ‰∏Ä</el-tag>
            <el-tag v-else-if="scope.row.COLUMN_KEY === 'MUL'" type="success">Á¥¢Âºï</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="EXTRA" label="È¢ùÂ§ñ‰ø°ÊÅØ" width="120" />
        <el-table-column prop="COLUMN_COMMENT" label="Ê≥®Èáä" />
        <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
          <template #default="scope">
            <el-button 
              size="small" 
              type="primary" 
              @click="showModifyColumnDialog(scope.row)"
              :disabled="!canModifyCurrentDatabase"
            >
              ‰øÆÊîπÁ±ªÂûã
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>

    <!-- ‰øÆÊîπÂàóÊï∞ÊçÆÁ±ªÂûãÂØπËØùÊ°Ü -->
    <el-dialog v-model="modifyColumnDialogVisible" :title="`‰øÆÊîπÂàóÊï∞ÊçÆÁ±ªÂûã - ${modifyColumn?.COLUMN_NAME}`" width="600px">
      <el-form :model="modifyColumnForm" label-width="120px" :rules="modifyColumnRules" ref="modifyColumnFormRef">
        <el-form-item label="ÂàóÂêç">
          <el-input v-model="modifyColumnForm.columnName" disabled />
        </el-form-item>
        
        <el-form-item label="ÂΩìÂâçÁ±ªÂûã">
          <el-input v-model="modifyColumnForm.currentType" disabled />
        </el-form-item>
        
        <el-form-item label="Êñ∞Êï∞ÊçÆÁ±ªÂûã" prop="newDataType">
          <el-select v-model="modifyColumnForm.newDataType" placeholder="ÈÄâÊã©Êï∞ÊçÆÁ±ªÂûã" style="width: 100%;">
            <el-option-group
              v-for="group in dataTypeGroups"
              :key="group.category"
              :label="group.category"
            >
              <el-option
                v-for="type in group.types"
                :key="type.name"
                :label="type.displayName"
                :value="type.name"
              >
                <span>{{ type.displayName }}</span>
                <span style="float: right; color: #8492a6; font-size: 12px;">{{ type.name }}</span>
              </el-option>
            </el-option-group>
          </el-select>
        </el-form-item>
        
        <!-- ENUMÂíåSETÁ±ªÂûãÁöÑÂÄºËæìÂÖ• -->
        <el-form-item label="Êûö‰∏æÂÄº" v-if="modifyColumnForm.newDataType === 'ENUM' || modifyColumnForm.newDataType === 'SET'">
          <el-input 
            v-model="modifyColumnForm.newLength" 
            :placeholder="modifyColumnForm.newDataType === 'ENUM' ? 'ËØ∑ËæìÂÖ•Êûö‰∏æÂÄºÔºåÁî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶ÇÔºövalue1,value2,value3' : 'ËØ∑ËæìÂÖ•ÈõÜÂêàÂÄºÔºåÁî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶ÇÔºövalue1,value2,value3'"
            type="textarea"
            :rows="3"
          />
          <div style="margin-top: 5px; color: #909399; font-size: 12px;">
            {{ modifyColumnForm.newDataType === 'ENUM' ? 'Êûö‰∏æÁ±ªÂûãÂè™ËÉΩÈÄâÊã©ÂÖ∂‰∏≠‰∏Ä‰∏™ÂÄº' : 'ÈõÜÂêàÁ±ªÂûãÂèØ‰ª•ÈÄâÊã©Â§ö‰∏™ÂÄºÁöÑÁªÑÂêà' }}
          </div>
        </el-form-item>
        
        <!-- ÂÖ∂‰ªñÁ±ªÂûãÁöÑÈïøÂ∫¶ËæìÂÖ• -->
        <el-form-item label="ÈïøÂ∫¶" v-if="needsLength(modifyColumnForm.newDataType) && modifyColumnForm.newDataType !== 'ENUM' && modifyColumnForm.newDataType !== 'SET'">
          <el-input 
            v-model="modifyColumnForm.newLength" 
            placeholder="ÈïøÂ∫¶"
            type="number"
            min="1"
          />
        </el-form-item>
        
        <el-form-item label="Â∞èÊï∞‰Ωç" v-if="needsDecimals(modifyColumnForm.newDataType)">
          <el-input 
            v-model="modifyColumnForm.newDecimals" 
            placeholder="Â∞èÊï∞‰Ωç"
            type="number"
            min="0"
            max="30"
          />
        </el-form-item>
        
        <el-form-item>
          <el-alert
            title="Ê≥®ÊÑè‰∫ãÈ°π"
            type="warning"
            :closable="false"
            show-icon
          >
            <template #default>
              <p style="margin: 0;">1. ‰øÆÊîπÊï∞ÊçÆÁ±ªÂûãÂèØËÉΩ‰ºöÂΩ±ÂìçÁé∞ÊúâÊï∞ÊçÆ</p>
              <p style="margin: 0;">2. Âª∫ËÆÆÂÖàÂ§á‰ªΩÈáçË¶ÅÊï∞ÊçÆ</p>
              <p style="margin: 0;">3. ÂØπ‰∫éÊï¥Êï∞Á±ªÂûãÔºåÂª∫ËÆÆ‰ΩøÁî®BIGINTÈÅøÂÖçËåÉÂõ¥ÈóÆÈ¢ò</p>
            </template>
          </el-alert>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="modifyColumnDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="confirmModifyColumn" :loading="modifyingColumn">
          Á°ÆËÆ§‰øÆÊîπ
        </el-button>
      </template>
    </el-dialog>

    <!-- Ë°®Êï∞ÊçÆÂØπËØùÊ°Ü -->
    <el-dialog 
      v-model="dataDialogVisible" 
      :title="fieldSearchResult.searchValue ? `Ë°®Êï∞ÊçÆ - ${selectedTable} (ÊêúÁ¥¢ÂÄº: ${fieldSearchResult.searchValue})` : `Ë°®Êï∞ÊçÆ - ${selectedTable}`" 
      width="90%"
    >
      <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <el-text type="info">
            ÊØèÈ°µÊòæÁ§∫Ôºö
          </el-text>
          <el-select v-model="pagination.pageSize" @change="changePageSize" style="width: 80px; margin: 0 10px;">
            <el-option label="10" :value="10" />
            <el-option label="20" :value="20" />
            <el-option label="50" :value="50" />
            <el-option label="100" :value="100" />
          </el-select>
          <el-text type="info">
            Êù°ÔºåÂÖ± {{ pagination.totalCount }} Êù°ËÆ∞ÂΩï
          </el-text>
        </div>
        <div>
          <el-button type="primary" @click="loadTableDataWithPagination" :loading="tableDataLoading">
            Âà∑Êñ∞Êï∞ÊçÆ
          </el-button>
          <el-button 
            v-if="canModifyCurrentDatabase"
            type="success" 
            @click="showAddDataDialog" 
            style="margin-left: 10px;"
          >
            Êñ∞Â¢ûÊï∞ÊçÆ
          </el-button>
        </div>
      </div>
      
              <el-table 
        :data="tableData" 
        style="width: 100%" 
        v-loading="tableDataLoading"
        element-loading-text="Âä†ËΩΩ‰∏≠..."
      >
        <el-table-column 
          v-for="column in Object.keys(tableData[0] || {})" 
          :key="column"
          :prop="column" 
          :label="column"
          :width="getColumnWidth(column)"
          show-overflow-tooltip
        >
          <template #default="scope">
            <span 
              v-if="fieldSearchResult.searchValue && cellContainsSearchValue(scope.row[column], fieldSearchResult.searchValue)" 
              style="background-color: #fff2e8; padding: 2px 4px; border-radius: 3px; color: #e6a23c; font-weight: bold;"
            >
              {{ scope.row[column] }}
            </span>
            <span v-else>{{ scope.row[column] }}</span>
          </template>
        </el-table-column>
        <el-table-column 
          v-if="tableData.length > 0 && canModifyCurrentDatabase" 
          label="Êìç‰Ωú" 
          width="170" 
          fixed="right"
          align="center"
        >
          <template #default="scope">
            <div class="table-actions">
              <el-button 
                size="small" 
                type="primary" 
                @click="editRow(scope.row)"
                :icon="Edit"
                class="action-btn"
              >
                ÁºñËæë
              </el-button>
              <el-button 
                size="small" 
                type="danger" 
                @click="confirmDeleteRow(scope.row)"
                :icon="Delete"
                class="action-btn"
              >
                Âà†Èô§
              </el-button>
            </div>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
      <div style="margin-top: 20px; display: flex; justify-content: center;">
        <el-pagination
          v-model:current-page="pagination.currentPage"
          v-model:page-size="pagination.pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :small="false"
          :disabled="tableDataLoading"
          :background="true"
          layout="total, sizes, prev, pager, next, jumper"
          :total="pagination.totalCount"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-dialog>

    <!-- Êñ∞Â¢ûÊï∞ÊçÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="addDataDialogVisible" :title="`Êñ∞Â¢ûÊï∞ÊçÆ - ${selectedTable}`" width="70%">
      <!-- ‰∏ªÈîÆÂÄºÊèêÁ§∫ -->
      <el-alert 
        v-if="hasPrimaryKey"
        title="ÊèêÁ§∫ÔºöÊ≠§Ë°®Êúâ‰∏ªÈîÆÂ≠óÊÆµÔºåËØ∑Á°Æ‰øùËæìÂÖ•ÁöÑÂÄºÊòØÂîØ‰∏ÄÁöÑ"
        type="warning"
        :closable="false"
        style="margin-bottom: 20px;"
      />
      
      <el-form :model="newRowData" label-width="120px">
        <el-form-item 
          v-for="column in tableColumns" 
          :key="column.COLUMN_NAME"
          :label="column.COLUMN_NAME"
          :required="column.IS_NULLABLE === 'NO' && !column.EXTRA.includes('auto_increment')"
        >
          <div style="display: flex; align-items: center; gap: 10px;">
            <!-- ENUMÁ±ªÂûã‰ΩøÁî®‰∏ãÊãâÈÄâÊã© -->
            <el-select 
              v-if="isEnumType(column)"
              v-model="newRowData[column.COLUMN_NAME]"
              :placeholder="getColumnPlaceholder(column)"
              :disabled="column.EXTRA.includes('auto_increment')"
              style="flex: 1; min-width: 200px;"
              clearable
              filterable
              :popper-append-to-body="false"
            >
              <el-option
                v-for="value in getEnumValues(column)"
                :key="value"
                :label="value"
                :value="value"
              >
                <span style="font-weight: 500;">{{ value }}</span>
              </el-option>
            </el-select>
            <!-- ÂÖ∂‰ªñÁ±ªÂûã‰ΩøÁî®ËæìÂÖ•Ê°Ü -->
            <el-input 
              v-else
              v-model="newRowData[column.COLUMN_NAME]"
              :placeholder="getColumnPlaceholder(column)"
              :disabled="column.EXTRA.includes('auto_increment')"
              style="flex: 1;"
            />
            <el-tag size="small" :type="getColumnTagType(column)">
              {{ column.DATA_TYPE }}
            </el-tag>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            {{ getColumnDescription(column) }}
          </div>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="addDataDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitNewData" :loading="submitting">
          Êèê‰∫§
        </el-button>
      </template>
    </el-dialog>

    <!-- ÁºñËæëÊï∞ÊçÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="editDataDialogVisible" :title="`ÁºñËæëÊï∞ÊçÆ - ${selectedTable}`" width="70%">
      <!-- ‰∏ªÈîÆÊèêÁ§∫ -->
      <el-alert 
        title="Ê≥®ÊÑèÔºö‰∏ªÈîÆÂ≠óÊÆµ‰∏çËÉΩ‰øÆÊîπ"
        type="info"
        :closable="false"
        style="margin-bottom: 20px;"
      />
      
      <el-form :model="editRowData" label-width="120px">
        <el-form-item 
          v-for="column in tableColumns" 
          :key="column.COLUMN_NAME"
          :label="column.COLUMN_NAME"
        >
          <div style="display: flex; align-items: center; gap: 10px;">
            <!-- ENUMÁ±ªÂûã‰ΩøÁî®‰∏ãÊãâÈÄâÊã© -->
            <el-select 
              v-if="isEnumType(column)"
              v-model="editRowData[column.COLUMN_NAME]"
              :placeholder="getColumnPlaceholder(column)"
              :disabled="column.COLUMN_KEY === 'PRI' || column.EXTRA.includes('auto_increment')"
              style="flex: 1; min-width: 200px;"
              clearable
              filterable
              :popper-append-to-body="false"
            >
              <el-option
                v-for="value in getEnumValues(column)"
                :key="value"
                :label="value"
                :value="value"
              >
                <span style="font-weight: 500;">{{ value }}</span>
              </el-option>
            </el-select>
            <!-- ÂÖ∂‰ªñÁ±ªÂûã‰ΩøÁî®ËæìÂÖ•Ê°Ü -->
            <el-input 
              v-else
              v-model="editRowData[column.COLUMN_NAME]"
              :placeholder="getColumnPlaceholder(column)"
              :disabled="column.COLUMN_KEY === 'PRI' || column.EXTRA.includes('auto_increment')"
              style="flex: 1;"
            />
            <el-tag size="small" :type="getColumnTagType(column)">
              {{ column.DATA_TYPE }}
            </el-tag>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            {{ getColumnDescription(column) }}
          </div>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="editDataDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitEditData" :loading="submitting">
          ‰øùÂ≠ò‰øÆÊîπ
        </el-button>
      </template>
    </el-dialog>

    <!-- Êñ∞Âª∫Êï∞ÊçÆÂ∫ìÂØπËØùÊ°Ü -->
    <el-dialog v-model="createDatabaseDialogVisible" title="Êñ∞Âª∫Êï∞ÊçÆÂ∫ì" width="600px">
      <el-form :model="newDatabaseForm" label-width="120px" :rules="databaseRules" ref="databaseFormRef">
        <el-form-item label="Êï∞ÊçÆÂ∫ìÂêçÁß∞" prop="databaseName">
          <el-input 
            v-model="newDatabaseForm.databaseName"
            placeholder="ËØ∑ËæìÂÖ•Êï∞ÊçÆÂ∫ìÂêçÁß∞Ôºà‰ªÖÊîØÊåÅÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ"
            maxlength="64"
            show-word-limit
          />
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Êï∞ÊçÆÂ∫ìÂêçÁß∞Âè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫øÔºåÈïøÂ∫¶‰∏çË∂ÖËøá64‰∏™Â≠óÁ¨¶
  </div>
        </el-form-item>
        
        <el-form-item label="Â≠óÁ¨¶ÈõÜ" prop="charset">
          <el-select v-model="newDatabaseForm.charset" placeholder="ÈÄâÊã©Â≠óÁ¨¶ÈõÜ" style="width: 100%;">
            <el-option label="utf8ÔºàÊé®ËçêÔºâ" value="utf8" />
            <el-option label="utf8mb4" value="utf8mb4" />
            <el-option label="latin1" value="latin1" />
            <el-option label="gbk" value="gbk" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="ÊéíÂ∫èËßÑÂàô" prop="collation">
          <el-select v-model="newDatabaseForm.collation" placeholder="ÈÄâÊã©ÊéíÂ∫èËßÑÂàô" style="width: 100%;">
            <el-option label="utf8_general_ciÔºàÊé®ËçêÔºâ" value="utf8_general_ci" />
            <el-option label="utf8_unicode_ci" value="utf8_unicode_ci" />
            <el-option label="utf8mb4_unicode_ci" value="utf8mb4_unicode_ci" />
            <el-option label="utf8mb4_general_ci" value="utf8mb4_general_ci" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="Êï∞ÊçÆÂ∫ìÊèèËø∞">
          <el-input 
            v-model="newDatabaseForm.description"
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•Êï∞ÊçÆÂ∫ìÁöÑÁî®ÈÄîÊèèËø∞ÔºàÂèØÈÄâÔºâ"
            maxlength="200"
            show-word-limit
          />
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            ÊèèËø∞Ëøô‰∏™Êï∞ÊçÆÂ∫ìÁöÑÁî®ÈÄîÔºå‰æø‰∫éÂêéÁª≠ÁÆ°ÁêÜ
          </div>
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="createDatabaseDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="createDatabase" :loading="creatingDatabase">
          ÂàõÂª∫Êï∞ÊçÆÂ∫ì
        </el-button>
      </template>
    </el-dialog>

    <!-- Âà†Èô§Êï∞ÊçÆÂ∫ìÁ°ÆËÆ§ÂØπËØùÊ°Ü -->
    <el-dialog v-model="deleteDatabaseDialogVisible" title="Âà†Èô§Êï∞ÊçÆÂ∫ì" width="500px">
      <div style="padding: 20px 0;">
        <el-alert
          title="Ë≠¶Âëä"
          type="warning"
          :closable="false"
          show-icon
          style="margin-bottom: 20px;"
        >
          <template #default>
            <p>Âà†Èô§Êï∞ÊçÆÂ∫ìÊòØ‰∏Ä‰∏™<strong style="color: #e6a23c;">‰∏çÂèØÈÄÜÊìç‰Ωú</strong>ÔºåÂ∞Ü‰ºöÔºö</p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Ê∞∏‰πÖÂà†Èô§Êï∞ÊçÆÂ∫ì <strong>{{ databaseToDelete?.name }}</strong></li>
              <li>Âà†Èô§ËØ•Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊâÄÊúâË°®ÂíåÊï∞ÊçÆ</li>
              <li>Êó†Ê≥ïÊÅ¢Â§çÂ∑≤Âà†Èô§ÁöÑÊï∞ÊçÆ</li>
            </ul>
          </template>
        </el-alert>
        
        <p style="margin-bottom: 15px;">
          ËØ∑ËæìÂÖ•Êï∞ÊçÆÂ∫ìÂêçÁß∞ <strong style="color: #f56c6c;">{{ databaseToDelete?.name }}</strong> Êù•Á°ÆËÆ§Âà†Èô§Ôºö
        </p>
        
        <el-input
          v-model="deleteConfirmText"
          placeholder="ËØ∑ËæìÂÖ•Êï∞ÊçÆÂ∫ìÂêçÁß∞"
          style="margin-bottom: 15px;"
          @keyup.enter="confirmDeleteDatabase"
        />
        
        <p style="font-size: 14px; color: #666;">
          <strong>Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÔºö</strong><br>
          ÂêçÁß∞Ôºö{{ databaseToDelete?.displayName }}<br>
          ÊèèËø∞Ôºö{{ databaseToDelete?.description }}
        </p>
      </div>
      
      <template #footer>
        <el-button @click="cancelDeleteDatabase">ÂèñÊ∂à</el-button>
        <el-button 
          type="danger" 
          @click="confirmDeleteDatabase"
          :loading="deletingDatabase"
          :disabled="deleteConfirmText !== databaseToDelete?.name"
        >
          Á°ÆËÆ§Âà†Èô§
        </el-button>
             </template>
     </el-dialog>

    <!-- Ë°®ËÆæËÆ°Âô®ÂØπËØùÊ°Ü -->
    <el-dialog v-model="createTableDialogVisible" title="Ë°®ËÆæËÆ°Âô®" width="90%" :close-on-click-modal="false">
      <div class="table-designer">
        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <el-card class="basic-info-card" shadow="never">
          <template #header>
            <div style="font-weight: 600;">Âü∫Êú¨‰ø°ÊÅØ</div>
          </template>
          
          <el-form :model="tableDesign" label-width="100px" :rules="tableRules" ref="tableFormRef">
            <el-row :gutter="20">
              <el-col :span="12">
                <el-form-item label="Ë°®Âêç" prop="tableName">
                  <el-input 
                    v-model="tableDesign.tableName"
                    placeholder="ËØ∑ËæìÂÖ•Ë°®ÂêçÔºàÂ¶ÇÔºöuser_infoÔºâ"
                    maxlength="64"
                    show-word-limit
                  />
                  <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    Ë°®ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºå‰∏çËÉΩ‰ª•Êï∞Â≠óÂºÄÂ§¥
                  </div>
                </el-form-item>
              </el-col>
              <el-col :span="12">
                <el-form-item label="Êï∞ÊçÆÂ∫ì">
                  <el-input v-model="selectedDatabase" disabled />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item label="Ë°®Ê≥®Èáä">
              <el-input 
                v-model="tableDesign.tableComment"
                type="textarea"
                :rows="2"
                placeholder="ËØ∑ËæìÂÖ•Ë°®ÁöÑÁî®ÈÄîËØ¥ÊòéÔºàÂèØÈÄâÔºâ"
                maxlength="200"
                show-word-limit
              />
            </el-form-item>
          </el-form>
        </el-card>

        <!-- ÂàóËÆæËÆ° -->
        <el-card class="columns-card" shadow="never" style="margin-top: 20px;">
          <template #header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 600;">ÂàóËÆæËÆ°</span>
              <el-button type="primary" size="small" @click="addColumn">
                <el-icon><Plus /></el-icon>
                Ê∑ªÂä†Âàó
              </el-button>
            </div>
          </template>
          
          <div v-if="tableDesign.columns.length === 0" class="empty-columns">
            <el-empty description="ËØ∑Ê∑ªÂä†Ëá≥Â∞ë‰∏Ä‰∏™Âàó">
              <el-button type="primary" @click="addColumn">Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Âàó</el-button>
            </el-empty>
          </div>
          
          <div v-else class="columns-editor">
            <el-table :data="tableDesign.columns" style="width: 100%">
              <el-table-column label="ÂàóÂêç" width="150">
                <template #default="scope">
                  <el-input 
                    v-model="scope.row.name"
                    placeholder="ÂàóÂêç"
                    size="small"
                    @input="validateColumnName(scope.row)"
                  />
                  <div v-if="scope.row.nameError" style="color: #f56c6c; font-size: 12px; margin-top: 2px;">
                    {{ scope.row.nameError }}
                  </div>
                </template>
              </el-table-column>
              
              <el-table-column label="Êï∞ÊçÆÁ±ªÂûã" width="130">
                <template #default="scope">
                  <el-select 
                    v-model="scope.row.dataType"
                    placeholder="ÈÄâÊã©Á±ªÂûã"
                    size="small"
                    style="width: 100%;"
                    @change="onDataTypeChange(scope.row)"
                  >
                    <el-option-group
                      v-for="group in groupedDataTypes"
                      :key="group.category"
                      :label="group.category"
                    >
                      <el-option
                        v-for="type in group.types"
                        :key="type.name"
                        :label="type.displayName"
                        :value="type.name"
                      >
                        <span>{{ type.displayName }}</span>
                        <span style="float: right; color: #8492a6; font-size: 12px;">{{ type.name }}</span>
                      </el-option>
                    </el-option-group>
                  </el-select>
                </template>
              </el-table-column>
              
              <el-table-column label="ÈïøÂ∫¶" width="80">
                <template #default="scope">
                  <el-input 
                    v-model="scope.row.length"
                    placeholder="ÈïøÂ∫¶"
                    size="small"
                    type="number"
                    :disabled="!needsLength(scope.row.dataType)"
                  />
                </template>
              </el-table-column>
              
              <el-table-column label="Â∞èÊï∞‰Ωç" width="80">
                <template #default="scope">
                  <el-input 
                    v-model="scope.row.decimals"
                    placeholder="Â∞èÊï∞‰Ωç"
                    size="small"
                    type="number"
                    :disabled="!needsDecimals(scope.row.dataType)"
                  />
                </template>
              </el-table-column>
              
              <el-table-column label="Á∫¶Êùü" width="200">
                <template #default="scope">
                  <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <el-checkbox v-model="scope.row.isPrimary" size="small" @change="onPrimaryKeyChange(scope.row)">
                      ‰∏ªÈîÆ
                    </el-checkbox>
                    <el-checkbox v-model="scope.row.isNotNull" size="small">
                      ÈùûÁ©∫
                    </el-checkbox>
                    <el-checkbox v-model="scope.row.isAutoIncrement" size="small" :disabled="!canAutoIncrement(scope.row)">
                      Ëá™Â¢û
                    </el-checkbox>
                    <el-checkbox v-model="scope.row.isForeignKey" size="small" @change="onForeignKeyChange(scope.row)">
                      Â§ñÈîÆ
                    </el-checkbox>
                  </div>
                </template>
              </el-table-column>
              
              <!-- Â§ñÈîÆÈÖçÁΩÆÂàó -->
              <el-table-column label="Â§ñÈîÆÈÖçÁΩÆ" width="300" v-if="hasAnyForeignKey">
                <template #default="scope">
                  <div v-if="scope.row.isForeignKey" style="display: flex; flex-direction: column; gap: 5px;">
                    <el-select 
                      v-model="scope.row.referenceTable"
                      placeholder="ÈÄâÊã©ÂºïÁî®Ë°®"
                      size="small"
                      style="width: 100%;"
                      @change="onReferenceTableChange(scope.row)"
                      clearable
                      filterable
                    >
                      <el-option
                        v-for="table in availableTables"
                        :key="table"
                        :label="table"
                        :value="table"
                      />
                    </el-select>
                    
                    <el-select 
                      v-model="scope.row.referenceColumn"
                      placeholder="ÈÄâÊã©ÂºïÁî®Âàó"
                      size="small"
                      style="width: 100%;"
                      :disabled="!scope.row.referenceTable"
                      clearable
                      filterable
                      @change="onReferenceColumnChange(scope.row)"
                    >
                      <el-option
                        v-for="column in getTableColumns(scope.row.referenceTable)"
                        :key="column.name"
                        :label="column.label"
                        :value="column.name"
                      />
                    </el-select>
                    
                    <div style="display: flex; gap: 3px;">
                      <el-select v-model="scope.row.onUpdate" size="small" style="flex: 1;">
                        <template #prefix>Êõ¥Êñ∞:</template>
                        <el-option label="RESTRICT" value="RESTRICT"/>
                        <el-option label="CASCADE" value="CASCADE"/>
                        <el-option label="SET NULL" value="SET NULL"/>
                        <el-option label="NO ACTION" value="NO ACTION"/>
                      </el-select>
                      
                      <el-select v-model="scope.row.onDelete" size="small" style="flex: 1;">
                        <template #prefix>Âà†Èô§:</template>
                        <el-option label="RESTRICT" value="RESTRICT"/>
                        <el-option label="CASCADE" value="CASCADE"/>
                        <el-option label="SET NULL" value="SET NULL"/>
                        <el-option label="NO ACTION" value="NO ACTION"/>
                      </el-select>
                    </div>
                  </div>
                </template>
              </el-table-column>
              
              <el-table-column label="ÈªòËÆ§ÂÄº" width="120">
                <template #default="scope">
                  <el-input 
                    v-model="scope.row.defaultValue"
                    placeholder="ÈªòËÆ§ÂÄº"
                    size="small"
                    :disabled="scope.row.isAutoIncrement"
                  />
                </template>
              </el-table-column>
              
              <el-table-column label="Ê≥®Èáä" min-width="120">
                <template #default="scope">
                  <el-input 
                    v-model="scope.row.comment"
                    placeholder="ÂàóÊ≥®Èáä"
                    size="small"
                  />
                </template>
              </el-table-column>
              
              <el-table-column label="Êìç‰Ωú" width="100" fixed="right">
                <template #default="scope">
                  <div style="display: flex; gap: 5px;">
                    <el-button 
                      size="small" 
                      type="danger" 
                      :icon="Delete"
                      @click="removeColumn(scope.$index)"
                      circle
                    />
                    <el-button 
                      v-if="scope.$index > 0"
                      size="small" 
                      @click="moveColumnUp(scope.$index)"
                      circle
                    >
                      ‚Üë
                    </el-button>
                    <el-button 
                      v-if="scope.$index < tableDesign.columns.length - 1"
                      size="small" 
                      @click="moveColumnDown(scope.$index)"
                      circle
                    >
                      ‚Üì
                    </el-button>
                  </div>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </el-card>

        <!-- SQL È¢ÑËßà -->
        <el-card class="sql-preview-card" shadow="never" style="margin-top: 20px;">
          <template #header>
            <div style="font-weight: 600;">SQL È¢ÑËßà</div>
          </template>
          
          <el-input
            v-model="generatedSQL"
            type="textarea"
            :rows="8"
            readonly
            style="font-family: 'Monaco', 'Consolas', monospace;"
          />
        </el-card>
      </div>
      
      <template #footer>
        <el-button @click="cancelCreateTable">ÂèñÊ∂à</el-button>
        <el-button @click="previewSQL" :disabled="!canGenerateSQL">È¢ÑËßà SQL</el-button>
        <el-button type="primary" @click="confirmCreateTable" :loading="creatingTable" :disabled="!canCreateTable">
          ÂàõÂª∫Ë°®
        </el-button>
      </template>
    </el-dialog>

    <!-- Â≠óÊÆµÊêúÁ¥¢ÁªìÊûúÂºπÁ™ó -->
    <el-dialog 
      v-model="fieldSearchResultDialogVisible" 
      :title="`Â≠óÊÆµÂÄºÊêúÁ¥¢ÁªìÊûú - ÂÖ±ÊâæÂà∞ ${fieldSearchResult.totalCount || 0} ‰∏™ÂåπÈÖçÁöÑË°®`" 
      width="90%"
      draggable
      :close-on-click-modal="false"
    >
      <div v-if="fieldSearchResult.tables && fieldSearchResult.tables.length > 0">
        <div style="margin-bottom: 15px;">
          <el-alert
            :title="`ÊêúÁ¥¢ÂÄºÔºö'${fieldSearchResult.searchValue}' | ÂåπÈÖçË°®Êï∞Ôºö${fieldSearchResult.totalCount}`"
            type="success"
            :closable="false"
            show-icon
          />
        </div>
        
        <el-table 
          :data="fieldSearchResult.tables" 
          style="width: 100%" 
          :max-height="500"
          stripe
        >
          <el-table-column prop="TABLE_NAME" label="Ë°®Âêç" width="250" sortable />
          <el-table-column prop="MATCH_COUNT" label="ÂåπÈÖçËÆ∞ÂΩïÊï∞" width="150">
            <template #default="scope">
              <el-tag type="warning">{{ scope.row.MATCH_COUNT }}</el-tag>
              <el-tag v-if="scope.row.IS_COMPLETE" type="success" size="small" style="margin-left: 5px;">
                ÂÆåÊï¥
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="TABLE_ROWS" label="Ë°®ÊÄªË°åÊï∞" width="120">
            <template #default="scope">
              {{ scope.row.TABLE_ROWS?.toLocaleString() || 'N/A' }}
            </template>
          </el-table-column>
          <el-table-column prop="DATA_LENGTH" label="Êï∞ÊçÆÂ§ßÂ∞è" width="120">
            <template #default="scope">
              {{ formatBytes(scope.row.DATA_LENGTH) }}
            </template>
          </el-table-column>
          <el-table-column prop="CREATE_TIME" label="ÂàõÂª∫Êó∂Èó¥" width="180">
            <template #default="scope">
              {{ formatDate(scope.row.CREATE_TIME) }}
            </template>
          </el-table-column>
          <el-table-column prop="TABLE_COMMENT" label="Ê≥®Èáä" show-overflow-tooltip />
          <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
            <template #default="scope">
              <el-button size="small" @click="viewSearchResultData(scope.row.TABLE_NAME)">
                Êü•ÁúãÊï∞ÊçÆ
              </el-button>
              <el-button size="small" @click="viewTableStructure(scope.row.TABLE_NAME)">
                Ë°®ÁªìÊûÑ
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </div>
      
      <el-empty v-else description="Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑË°®">
        <template #image>
          <div style="font-size: 60px; color: #409eff;">
            <el-icon><Search /></el-icon>
          </div>
        </template>
      </el-empty>
      
      <template #footer>
        <div style="text-align: right;">
          <el-button @click="clearFieldSearch">Ê∏ÖÁ©∫ÊêúÁ¥¢</el-button>
          <el-button type="primary" @click="fieldSearchResultDialogVisible = false">ÂÖ≥Èó≠</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- Â§ö‰∏™Â≠óÊÆµÊêúÁ¥¢ÁªìÊûúÂºπÁ™ó -->
    <div v-for="dialog in searchDialogs" :key="dialog.id">
      <!-- ÊúÄÂ∞èÂåñÁä∂ÊÄÅÊòæÁ§∫ -->
      <div 
        v-if="dialog.minimized" 
        class="minimized-dialog" 
        @click="restoreDialog(dialog.id)"
        :style="{ 
          bottom: `${getMinimizedDialogPosition(dialog.id)}px`,
          right: '20px',
          borderLeftColor: getDatabaseColor(dialog.result.dataSource),
          borderLeftWidth: '4px'
        }"
        :title="`ÁÇπÂáªÂ±ïÂºÄÊêúÁ¥¢ÁªìÊûú | ÊêúÁ¥¢ÂÄº: ${dialog.searchValue} | Êï∞ÊçÆÂ∫ì: ${dialog.result.dataSource || 'Êú™Áü•'} | ÂåπÈÖçË°®Êï∞: ${dialog.result.totalCount}`"
      >
        <div class="minimized-content">
          <el-icon><Search /></el-icon>
          <span class="search-value">{{ dialog.searchValue }}</span>
          <span class="search-result-database-info">[{{ dialog.result.dataSource || 'Êú™Áü•' }}]</span>
          <span class="match-count">{{ dialog.result.totalCount }}</span>
        </div>
        <el-button 
          type="danger" 
          size="small" 
          circle 
          @click.stop="closeDialog(dialog.id)"
          class="close-btn"
          title="ÂÖ≥Èó≠Ê≠§ÊêúÁ¥¢ÁªìÊûú"
        >
          <el-icon><Delete /></el-icon>
        </el-button>
      </div>

      <!-- Ê≠£Â∏∏Áä∂ÊÄÅÂºπÁ™ó -->
      <el-dialog 
        v-if="!dialog.minimized"
        v-model="dialog.visible" 
        :title="`Â≠óÊÆµÂÄºÊêúÁ¥¢ÁªìÊûú - '${dialog.searchValue}' (${dialog.result.totalCount || 0} ‰∏™ÂåπÈÖçÁöÑË°®)`" 
        width="90%"
        draggable
        :close-on-click-modal="false"
        @close="closeDialog(dialog.id)"
      >
        <template #header="{ titleId, titleClass }">
          <div class="dialog-header">
            <h4 :id="titleId" :class="titleClass">
              Â≠óÊÆµÂÄºÊêúÁ¥¢ÁªìÊûú - '{{ dialog.searchValue }}' ({{ dialog.result.totalCount || 0 }} ‰∏™ÂåπÈÖçÁöÑË°®)
            </h4>
            <div class="dialog-controls">
              <el-button 
                class="minimize-btn"
                size="small" 
                @click="minimizeDialog(dialog.id)"
                title="ÊúÄÂ∞èÂåñ"
              >
                <el-icon><Minus /></el-icon>
              </el-button>
            </div>
          </div>
        </template>

        <div v-if="dialog.result.tables && dialog.result.tables.length > 0">
          <div style="margin-bottom: 15px;">
            <el-alert
              :title="`ÊêúÁ¥¢ÂÄºÔºö'${dialog.searchValue}' | ÂåπÈÖçË°®Êï∞Ôºö${dialog.result.totalCount}`"
              type="success"
              :closable="false"
              show-icon
            />
          </div>
          
          <el-table 
            :data="dialog.result.tables" 
            style="width: 100%" 
            :max-height="500"
            stripe
          >
            <el-table-column prop="TABLE_NAME" label="Ë°®Âêç" width="250" sortable />
            <el-table-column prop="MATCH_COUNT" label="ÂåπÈÖçËÆ∞ÂΩïÊï∞" width="150">
              <template #default="scope">
                <el-tag type="warning">{{ scope.row.MATCH_COUNT }}</el-tag>
                <el-tag v-if="scope.row.IS_COMPLETE" type="success" size="small" style="margin-left: 5px;">
                  ÂÆåÊï¥
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="TABLE_ROWS" label="Ë°®ÊÄªË°åÊï∞" width="120">
              <template #default="scope">
                {{ scope.row.TABLE_ROWS?.toLocaleString() || 'N/A' }}
              </template>
            </el-table-column>
            <el-table-column prop="DATA_LENGTH" label="Êï∞ÊçÆÂ§ßÂ∞è" width="120">
              <template #default="scope">
                {{ formatBytes(scope.row.DATA_LENGTH) }}
              </template>
            </el-table-column>
            <el-table-column prop="CREATE_TIME" label="ÂàõÂª∫Êó∂Èó¥" width="180">
              <template #default="scope">
                {{ formatDate(scope.row.CREATE_TIME) }}
              </template>
            </el-table-column>
            <el-table-column prop="TABLE_COMMENT" label="Ê≥®Èáä" show-overflow-tooltip />
            <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
              <template #default="scope">
                <el-button size="small" @click="viewSearchResultData(scope.row.TABLE_NAME, dialog.searchValue)">
                  Êü•ÁúãÊï∞ÊçÆ
                </el-button>
                <el-button size="small" @click="viewTableStructure(scope.row.TABLE_NAME)">
                  Ë°®ÁªìÊûÑ
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
        
        <el-empty v-else description="Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑË°®">
          <template #image>
            <div style="font-size: 60px; color: #409eff;">
              <el-icon><Search /></el-icon>
            </div>
          </template>
        </el-empty>
        
        <template #footer>
          <div style="text-align: right;">
            <el-button @click="clearSingleSearch(dialog.id)">Ê∏ÖÁ©∫Ê≠§ÊêúÁ¥¢</el-button>
            <el-button @click="clearAllSearches">Ê∏ÖÁ©∫ÊâÄÊúâÊêúÁ¥¢</el-button>
            <el-button type="primary" @click="closeDialog(dialog.id)">ÂÖ≥Èó≠</el-button>
          </div>
        </template>
      </el-dialog>
    </div>

    <!-- ÊêúÁ¥¢ËøõÂ∫¶ÂºπÁ™ó -->
    <el-dialog 
      v-model="searchProgressDialogVisible" 
      title="Â≠óÊÆµÂÄºÊêúÁ¥¢ËøõÂ∫¶" 
      width="600px"
      :close-on-click-modal="false"
      :show-close="false"
      center
    >
      <div class="search-progress-content">
        <div class="progress-header">
          <el-icon class="spinning-icon"><Loading /></el-icon>
          <span class="progress-title">Ê≠£Âú®ÊêúÁ¥¢Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑË°®...</span>
        </div>
        
        <div class="progress-info">
          <div class="search-info">
            <p><strong>ÊêúÁ¥¢ÂÄºÔºö</strong>{{ currentSearchValue }}</p>
            <p><strong>Êï∞ÊçÆÂ∫ìÔºö</strong>{{ getSelectedDatabaseInfo()?.displayName || selectedDatabase }}</p>
            <p><strong>ÊêúÁ¥¢Ê®°ÂºèÔºö</strong>
              <el-tag 
                type="primary" 
                size="small"
              >
                Êô∫ËÉΩÊ®°Âºè
              </el-tag>
              <span style="color: #666; font-size: 12px; margin-left: 8px;">
                (Ê†πÊçÆÊêúÁ¥¢ÂÜÖÂÆπËá™Âä®Âà§Êñ≠)
              </span>
            </p>
            <p><strong>ÊêúÁ¥¢Á±ªÂûãÔºö</strong>
              <el-tag 
                :type="currentSearchType === 'fuzzy' ? 'success' : 'warning'" 
                size="small"
              >
                {{ currentSearchType === 'fuzzy' ? 'Ê®°Á≥äÊêúÁ¥¢' : 'Á≤æÁ°ÆÊêúÁ¥¢' }}
              </el-tag>
              <span style="color: #666; font-size: 12px; margin-left: 8px;">
                {{ currentSearchType === 'fuzzy' ? '(ÂåÖÂê´ÊêúÁ¥¢ÂÄº)' : '(ÂÆåÂÖ®ÂåπÈÖç)' }}
              </span>
            </p>
          </div>
          
          <div class="progress-details">
            <el-progress 
              :percentage="searchProgressPercentage" 
              :stroke-width="8"
              status="warning"
              striped
              striped-flow
            />
            <div class="progress-text">
              <span class="current-progress">{{ searchProgressText }}</span>
              <span class="time-info">Â∑≤Áî®Êó∂Ôºö{{ formatElapsedTime(searchElapsedTime) }}</span>
            </div>
          </div>
          
          <div v-if="currentSearchingTable" class="current-table">
            <p><strong>ÂΩìÂâçÊêúÁ¥¢Ë°®Ôºö</strong>{{ currentSearchingTable }}</p>
          </div>
          
          <div v-if="foundTablesCount > 0" class="found-info">
            <el-tag type="success">Â∑≤ÊâæÂà∞ {{ foundTablesCount }} ‰∏™ÂåπÈÖçÁöÑË°®</el-tag>
          </div>
        </div>
      </div>
      
      <template #footer>
        <div style="text-align: center;">
          <el-button @click="cancelSearch" type="danger" :loading="cancelling">
            ÂèñÊ∂àÊêúÁ¥¢
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- ÂØºÂá∫ÂØπËØùÊ°Ü -->
    <ExportDialog
      :visible="exportDialogVisible"
      :table-name="exportTableName"
      :data-source="selectedDatabase"
      @close="closeExportDialog"
    />
  </div>
</template>

<script>
import { ref, onMounted, onUnmounted, computed, onActivated, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Delete, Edit, Search, Coin, Folder, FolderOpened, Refresh, Plus, Minus, Loading, ArrowDown, Aim, Download } from '@element-plus/icons-vue'
import api, { userState, checkPermission, databaseApi } from '../utils/api'
import searchDialogsState from '../utils/searchDialogsStore'
import { useRoute } from 'vue-router'
import ExportDialog from '../components/ExportDialog.vue'

export default {
  name: 'Tables',
  components: {
    Delete,
    Edit,
    Search,
    Coin,
    Folder,
    FolderOpened,
    Refresh,
    Plus,
    Minus,
    Loading,
    ArrowDown,
    Aim,
    Download,
    ExportDialog
  },
  setup() {
    const route = useRoute()
    const tableList = ref([])
    const selectedTable = ref('')
    const structureDialogVisible = ref(false)
    // ÁºìÂ≠òÂáÜÁ°ÆÁöÑË°®Ë°åÊï∞ - ‰ΩøÁî®ÊåÅ‰πÖÂåñÂ≠òÂÇ®
    const tableRowCounts = ref(new Map())
    const dataDialogVisible = ref(false)
    const addDataDialogVisible = ref(false)
    const editDataDialogVisible = ref(false)
    const tableColumns = ref([])
    const tableData = ref([])
    const dataLimit = ref(100)
    const newRowData = ref({})
    const editRowData = ref({})
    const originalRowData = ref({})
    const submitting = ref(false)
    const hasPrimaryKey = ref(false)
    const tableDataLoading = ref(false)
    const searchQuery = ref('')
    const loadingTables = ref(false)
    const databaseInfo = ref(null)
          const selectedDatabase = ref('login')
    const availableDatabases = ref([])
    
    // Â≠óÊÆµÂÄºÊêúÁ¥¢Áõ∏ÂÖ≥ÁöÑÂìçÂ∫îÂºèÂèòÈáè
    const fieldSearchQuery = ref('')
    const searchMode = ref('auto') // ÊêúÁ¥¢Ê®°ÂºèÔºöauto, text_only, numeric_only, all
    const currentSearchType = ref('fuzzy') // ÂΩìÂâçÊêúÁ¥¢Á±ªÂûãÔºöfuzzy, exact
    const fieldSearching = ref(false)
    const fieldSearchResult = ref({})
    const fieldSearchError = ref('')
    const fieldSearchResultDialogVisible = ref(false)
    
    // ÂØºÂá∫Áõ∏ÂÖ≥Áä∂ÊÄÅ
    const exportDialogVisible = ref(false)
    const exportTableName = ref('')
    
    // Â§öÂºπÁ™óÁÆ°ÁêÜ - ‰ΩøÁî®ÂÖ®Â±ÄÁä∂ÊÄÅ
    const searchDialogs = computed(() => searchDialogsState.searchDialogs)
    const nextDialogId = computed(() => searchDialogsState.nextDialogId)
    
    // ÊêúÁ¥¢ËøõÂ∫¶Áõ∏ÂÖ≥
    const searchProgressDialogVisible = ref(false)
    const currentSearchValue = ref('')
    const searchProgressPercentage = ref(0)
    const searchProgressText = ref('')
    const currentSearchingTable = ref('')
    const foundTablesCount = ref(0)
    const totalTablesCount = ref(0)
    const searchStartTime = ref(0)
    const searchElapsedTime = ref(0)
    const searchTimer = ref(null)
    const cancelling = ref(false)
    const currentSearchAbortController = ref(null)
    
    // Êñ∞Âª∫Êï∞ÊçÆÂ∫ìÁõ∏ÂÖ≥
    const createDatabaseDialogVisible = ref(false)
    const creatingDatabase = ref(false)
    const databaseFormRef = ref(null)
    const newDatabaseForm = ref({
      databaseName: '',
      charset: 'utf8',
      collation: 'utf8_general_ci',
      description: ''
    })
    
    // Âà†Èô§Êï∞ÊçÆÂ∫ìÁõ∏ÂÖ≥
    const deleteDatabaseDialogVisible = ref(false)
    const deletingDatabase = ref(false)
    const databaseToDelete = ref(null)
    const deleteConfirmText = ref('')
    
    // Ë°®ËÆæËÆ°Âô®Áõ∏ÂÖ≥
    const createTableDialogVisible = ref(false)
    const creatingTable = ref(false)
    const tableFormRef = ref(null)
    const availableDataTypes = ref([])
    const tableDesign = ref({
      tableName: '',
      tableComment: '',
      columns: []
    })
    const generatedSQL = ref('')
    
    // Êï∞ÊçÆÊõ¥Êñ∞Ê£ÄÊµãÁõ∏ÂÖ≥
    const lastDataUpdateTime = ref(null)
    const shouldRefreshOnActivate = ref(false)
    const updatedTables = ref(new Set()) // ËÆ∞ÂΩïÂì™‰∫õË°®Ë¢´Êõ¥Êñ∞‰∫Ü
    
    // Ë°®Ë°åÊï∞Áõ∏ÂÖ≥ÂáΩÊï∞
    const getTableRowCountCacheKey = (dataSource, tableName) => {
      return `table_row_count_${dataSource}_${tableName}`
    }
    
    const loadTableRowCountFromCache = (dataSource, tableName) => {
      const key = getTableRowCountCacheKey(dataSource, tableName)
      const cached = localStorage.getItem(key)
      if (cached) {
        try {
          const data = JSON.parse(cached)
          if (data && data.rowCount !== undefined) {
            // Êñ∞Ê†ºÂºèÁºìÂ≠ò
            tableRowCounts.value.set(tableName, data.rowCount)
            return data.rowCount
          }
        } catch (e) {
          // Â∞ùËØïÊóßÊ†ºÂºèÁºìÂ≠ò
          const rowCount = parseInt(cached)
          if (!isNaN(rowCount)) {
            tableRowCounts.value.set(tableName, rowCount)
            return rowCount
          }
        }
      }
      return null
    }
    
    const saveTableRowCountToCache = (dataSource, tableName, rowCount) => {
      const key = getTableRowCountCacheKey(dataSource, tableName)
      const cacheData = {
        rowCount: rowCount,
        timestamp: Date.now()
      }
      localStorage.setItem(key, JSON.stringify(cacheData))
      tableRowCounts.value.set(tableName, rowCount)
    }
    
    const cleanExpiredRowCountCache = () => {
      // Ê∏ÖÁêÜË∂ÖËøá7Â§©ÁöÑÁºìÂ≠ò
      const expireTime = 7 * 24 * 60 * 60 * 1000 // 7Â§©
      const now = Date.now()
      
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('table_row_count_')) {
          try {
            const data = JSON.parse(localStorage.getItem(key))
            if (data && data.timestamp && (now - data.timestamp > expireTime)) {
              localStorage.removeItem(key)
            }
          } catch (e) {
            // ÊóßÊ†ºÂºèÁºìÂ≠òÔºåÂà†Èô§
            localStorage.removeItem(key)
          }
        }
      })
    }
    
    const getTableRowCount = (tableName) => {
      // ÂÖàÊ£ÄÊü•ÂÜÖÂ≠òÁºìÂ≠ò
      let rowCount = tableRowCounts.value.get(tableName)
      if (rowCount) {
        return rowCount.toLocaleString()
      }
      
      // ÂÜçÊ£ÄÊü•localStorageÁºìÂ≠ò
      rowCount = loadTableRowCountFromCache(selectedDatabase.value, tableName)
      if (rowCount) {
        return rowCount.toLocaleString()
      }
      
      return null
    }
    
    const refreshTableRowCount = async (tableName) => {
      try {
        const userInfo = userState.getUserInfo()
        const response = await databaseApi.getTableRowCount(
          tableName, 
          selectedDatabase.value, 
          userInfo.userId, 
          userInfo.userType
        )
        saveTableRowCountToCache(selectedDatabase.value, tableName, response.data.rowCount)
        ElMessage.success(`Â∑≤Âà∑Êñ∞Ë°® ${tableName} ÁöÑË°åÊï∞`)
      } catch (error) {
        console.error('Ëé∑ÂèñË°®Ë°åÊï∞Â§±Ë¥•:', error)
        ElMessage.error('Ëé∑ÂèñË°®Ë°åÊï∞Â§±Ë¥•: ' + (error.response?.data?.error || error.message))
      }
    }
    
    const updateTableRowCount = async (tableName) => {
      // ÈùôÈªòÊõ¥Êñ∞Ë°®Ë°åÊï∞ÔºåÁî®‰∫éÊï∞ÊçÆÂèòÊõ¥ÂêéÁöÑËá™Âä®Êõ¥Êñ∞
      try {
        const userInfo = userState.getUserInfo()
        const response = await databaseApi.getTableRowCount(
          tableName, 
          selectedDatabase.value, 
          userInfo.userId, 
          userInfo.userType
        )
        saveTableRowCountToCache(selectedDatabase.value, tableName, response.data.rowCount)
      } catch (error) {
        console.warn('Ëá™Âä®Êõ¥Êñ∞Ë°®Ë°åÊï∞Â§±Ë¥•:', error)
      }
    }
    
    // Â§ñÈîÆÁõ∏ÂÖ≥ÂèòÈáè
    const availableTables = ref([])
    const referencedTableColumns = ref({})
    
    // ÊùÉÈôêÁõ∏ÂÖ≥
    const canAccessCurrentDatabase = ref(true)
    const canModifyCurrentDatabase = ref(true)
    const canCreateDatabase = ref(false)
    const permissionMessage = ref('')
    
    // ‰øÆÊîπË°®ÁªìÊûÑÁõ∏ÂÖ≥
    const modifyColumnDialogVisible = ref(false)
    const modifyingColumn = ref(false)
    const modifyColumnFormRef = ref(null)
    const modifyColumn = ref(null)
    const modifyColumnForm = ref({
      columnName: '',
      currentType: '',
      newDataType: '',
      newLength: '',
      newDecimals: ''
    })
    
         // ‰∏ªÈîÆÂàóËÆ°ÁÆóÂ±ûÊÄß
    const primaryKeyColumns = computed(() => {
      return tableColumns.value.filter(col => col.COLUMN_KEY === 'PRI')
    })

    // Êï∞ÊçÆÁ±ªÂûãÂàÜÁªÑÔºàÁî®‰∫é‰øÆÊîπË°®ÁªìÊûÑÔºâ
     const dataTypeGroups = computed(() => {
       const groups = {}
       
       // Â¶ÇÊûúAPIÊï∞ÊçÆ‰∏∫Á©∫Ôºå‰ΩøÁî®Â§áÁî®Êï∞ÊçÆÁ±ªÂûã
       let dataTypes = availableDataTypes.value
       if (!dataTypes || dataTypes.length === 0) {
         dataTypes = [
           { name: 'TINYINT', displayName: 'Êï¥Êï∞', category: 'Êï∞ÂÄº' },
           { name: 'SMALLINT', displayName: 'Êï¥Êï∞', category: 'Êï∞ÂÄº' },
           { name: 'MEDIUMINT', displayName: 'Êï¥Êï∞', category: 'Êï∞ÂÄº' },
           { name: 'INT', displayName: 'Êï¥Êï∞', category: 'Êï∞ÂÄº' },
           { name: 'BIGINT', displayName: 'Êï¥Êï∞', category: 'Êï∞ÂÄº' },
           { name: 'DECIMAL', displayName: 'Â∞èÊï∞', category: 'Êï∞ÂÄº' },
           { name: 'FLOAT', displayName: 'Â∞èÊï∞', category: 'Êï∞ÂÄº' },
           { name: 'DOUBLE', displayName: 'Â∞èÊï∞', category: 'Êï∞ÂÄº' },
           { name: 'CHAR', displayName: 'Â≠óÁ¨¶', category: 'Â≠óÁ¨¶‰∏≤' },
           { name: 'VARCHAR', displayName: 'Â≠óÁ¨¶', category: 'Â≠óÁ¨¶‰∏≤' },
           { name: 'TEXT', displayName: 'ÊñáÊú¨', category: 'Â≠óÁ¨¶‰∏≤' },
           { name: 'LONGTEXT', displayName: 'ÊñáÊú¨', category: 'Â≠óÁ¨¶‰∏≤' },
           { name: 'DATE', displayName: 'Êó•Êúü', category: 'Êó•ÊúüÊó∂Èó¥' },
           { name: 'DATETIME', displayName: 'Êó•ÊúüÊó∂Èó¥', category: 'Êó•ÊúüÊó∂Èó¥' },
           { name: 'TIMESTAMP', displayName: 'Êó∂Èó¥Êà≥', category: 'Êó•ÊúüÊó∂Èó¥' },
           { name: 'JSON', displayName: 'JSON', category: 'ÂÖ∂‰ªñ' }
         ]
       }
       
       dataTypes.forEach(type => {
         if (!groups[type.category]) {
           groups[type.category] = {
             category: type.category,
             types: []
           }
         }
         groups[type.category].types.push(type)
       })
       
       return Object.values(groups)
     })
    
    // Ë°®ÂçïÈ™åËØÅËßÑÂàô
    const databaseRules = {
      databaseName: [
        { required: true, message: 'ËØ∑ËæìÂÖ•Êï∞ÊçÆÂ∫ìÂêçÁß∞', trigger: 'blur' },
        { 
          pattern: /^[a-zA-Z0-9_]+$/, 
          message: 'Êï∞ÊçÆÂ∫ìÂêçÁß∞Âè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫ø', 
          trigger: 'blur' 
        },
        { min: 1, max: 64, message: 'Êï∞ÊçÆÂ∫ìÂêçÁß∞ÈïøÂ∫¶Âú®1Âà∞64‰∏™Â≠óÁ¨¶', trigger: 'blur' }
      ],
      charset: [
        { required: true, message: 'ËØ∑ÈÄâÊã©Â≠óÁ¨¶ÈõÜ', trigger: 'change' }
      ],
      collation: [
        { required: true, message: 'ËØ∑ÈÄâÊã©ÊéíÂ∫èËßÑÂàô', trigger: 'change' }
      ]
    }
    
    // Ë°®ËÆæËÆ°È™åËØÅËßÑÂàô
    const tableRules = {
      tableName: [
        { required: true, message: 'ËØ∑ËæìÂÖ•Ë°®Âêç', trigger: 'blur' },
        { 
          pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/, 
          message: 'Ë°®ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºå‰∏çËÉΩ‰ª•Êï∞Â≠óÂºÄÂ§¥', 
          trigger: 'blur' 
        },
        { min: 1, max: 64, message: 'Ë°®ÂêçÈïøÂ∫¶Âú®1Âà∞64‰∏™Â≠óÁ¨¶', trigger: 'blur' }
      ]
    }
    
    // ‰øÆÊîπË°®ÁªìÊûÑÈ™åËØÅËßÑÂàô
    const modifyColumnRules = {
      newDataType: [
        { required: true, message: 'ËØ∑ÈÄâÊã©Êñ∞ÁöÑÊï∞ÊçÆÁ±ªÂûã', trigger: 'change' }
      ]
    }
    
    // ÊùÉÈôêÊ£ÄÊü•ÂáΩÊï∞
    const checkDatabasePermission = (database, operation = 'read') => {
      const permission = checkPermission(database, operation)
      if (!permission.allowed) {
        return {
          allowed: false,
          message: permission.reason
        }
      }
      return { allowed: true }
    }
    
    // Ê£ÄÊü•Êï∞ÊçÆÊõ¥Êñ∞
    const checkDataUpdate = () => {
      try {
        const storedUpdateTime = localStorage.getItem('lastDataUpdateTime')
        if (storedUpdateTime) {
          const storedTime = new Date(storedUpdateTime).getTime()
          const currentTime = new Date().getTime()
          
          // Â¶ÇÊûúÂ≠òÂÇ®ÁöÑÊõ¥Êñ∞Êó∂Èó¥ÊØîÂΩìÂâçÁªÑ‰ª∂ÁöÑÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥Êñ∞ÔºåÂàôÈúÄË¶ÅÂà∑Êñ∞
          if (!lastDataUpdateTime.value || storedTime > lastDataUpdateTime.value) {
            lastDataUpdateTime.value = storedTime
            return true
          }
        }
        return false
      } catch (error) {
        console.error('Ê£ÄÊü•Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•:', error)
        return false
      }
    }
    
    // Ê†áËÆ∞Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞
    const markDataUpdated = () => {
      try {
        const currentTime = new Date().toISOString()
        localStorage.setItem('lastDataUpdateTime', currentTime)
        lastDataUpdateTime.value = new Date(currentTime).getTime()
      } catch (error) {
        console.error('Ê†áËÆ∞Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•:', error)
      }
    }
    
    // Ê†áËÆ∞ÁâπÂÆöË°®Â∑≤Êõ¥Êñ∞
    const markTableUpdated = (tableName) => {
      updatedTables.value.add(tableName)
    }
    

    
    // Êõ¥Êñ∞ÊùÉÈôêÁä∂ÊÄÅ
    const updatePermissionState = () => {
      const readPermission = checkDatabasePermission(selectedDatabase.value, 'read')
      const writePermission = checkDatabasePermission(selectedDatabase.value, 'write')
      
      canAccessCurrentDatabase.value = readPermission.allowed
      canModifyCurrentDatabase.value = writePermission.allowed
      
      // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÂàõÂª∫Êï∞ÊçÆÂ∫ìÔºàÂè™ÊúâÁÆ°ÁêÜÂëòÂèØ‰ª•Ôºâ
      const userInfo = userState.getUserInfo()
      canCreateDatabase.value = userInfo.userType === 'admin'
      
      if (!readPermission.allowed) {
        permissionMessage.value = readPermission.message
      } else if (!writePermission.allowed) {
        permissionMessage.value = 'ÊÇ®Âè™ÊúâÊü•ÁúãÊùÉÈôêÔºåÊó†Ê≥ï‰øÆÊîπÊï∞ÊçÆ'
      } else {
        permissionMessage.value = ''
      }
    }
    
    // ÂàÜÈ°µÁõ∏ÂÖ≥
    const pagination = ref({
      currentPage: 1,
      pageSize: 20,
      totalCount: 0,
      totalPages: 0
    })

    const loadTables = async (showMessage = true) => {
      try {
        loadingTables.value = true
        console.log('ÂºÄÂßãÂä†ËΩΩË°®ÂàóË°®ÔºåÊï∞ÊçÆÂ∫ì:', selectedDatabase.value)
        
        // Ê£ÄÊü•ÊùÉÈôê
        const permission = checkDatabasePermission(selectedDatabase.value, 'read')
        if (!permission.allowed) {
          console.warn('Êó†ÊùÉÈôêËÆøÈóÆÊï∞ÊçÆÂ∫ì:', permission.message)
          tableList.value = []
          if (showMessage) {
            ElMessage.warning(`Êó†ÊùÉÈôêËÆøÈóÆÊï∞ÊçÆÂ∫ì: ${permission.message}`)
          }
          return
        }
        
        console.log('ÊùÉÈôêÊ£ÄÊü•ÈÄöËøáÔºåÂèëËµ∑APIËØ∑Ê±Ç...')
        const response = await api.get('/api/database/tables', {
          params: {
            dataSource: selectedDatabase.value
          }
        })
        
        console.log('APIËØ∑Ê±ÇÊàêÂäüÔºåËé∑ÂèñÂà∞Ë°®Êï∞ÊçÆ:', response.data?.length || 0, '‰∏™Ë°®')
        tableList.value = response.data
        
        // Âä†ËΩΩÁºìÂ≠òÁöÑË°®Ë°åÊï∞
        if (response.data && Array.isArray(response.data)) {
          response.data.forEach(table => {
            loadTableRowCountFromCache(selectedDatabase.value, table.TABLE_NAME)
          })
        }
        
        // ÂºÇÊ≠•Âä†ËΩΩÊï∞ÊçÆÂ∫ìÁªüËÆ°‰ø°ÊÅØ
        loadDatabaseInfo()
        
        // Âè™Âú®Áî®Êà∑‰∏ªÂä®Âà∑Êñ∞Êó∂ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        if (showMessage) {
          ElMessage.success(`Â∑≤Âà∑Êñ∞Êï∞ÊçÆÂ∫ì ${selectedDatabase.value}ÔºåÂÖ± ${response.data?.length || 0} ‰∏™Ë°®`)
        }
      } catch (error) {
        console.error('Âä†ËΩΩË°®ÂàóË°®Â§±Ë¥•:', error)
        const errorMsg = error.response?.data?.error || error.message
        
        // Â§ÑÁêÜÊùÉÈôêÈîôËØØ - ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÁªôÁî®Êà∑
        if (error.response?.status === 403) {
          console.warn('ÊùÉÈôê‰∏çË∂≥Ôºö' + errorMsg)
          tableList.value = []
          if (showMessage) {
            ElMessage.error('ÊùÉÈôê‰∏çË∂≥: ' + errorMsg)
          }
        } else if (error.response?.status === 401) {
          if (showMessage) {
            ElMessage.error('Áî®Êà∑Êú™ÁôªÂΩïÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï')
          }
        } else {
          if (showMessage) {
            ElMessage.error('Âä†ËΩΩË°®ÂàóË°®Â§±Ë¥•: ' + errorMsg)
          }
        }
      } finally {
        loadingTables.value = false
        console.log('Ë°®ÂàóË°®Âä†ËΩΩÂÆåÊàê')
      }
    }

    const selectTable = (row) => {
      selectedTable.value = row.TABLE_NAME
    }

    const viewTableStructure = async (tableName) => {
      try {
        selectedTable.value = tableName
        const response = await api.get(`/api/database/tables/${tableName}/columns`, {
          params: {
            dataSource: selectedDatabase.value
          }
        })
        tableColumns.value = response.data
        structureDialogVisible.value = true
      } catch (error) {
        console.error('Âä†ËΩΩË°®ÁªìÊûÑÂ§±Ë¥•:', error)
      }
    }

    const viewTableData = async (tableName) => {
      selectedTable.value = tableName
      dataDialogVisible.value = true
      
      // Á´ãÂç≥Ê∏ÖÁ©∫Ë°®Êï∞ÊçÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      tableData.value = []
      tableDataLoading.value = true
      
      // ÈáçÁΩÆÂàÜÈ°µÁä∂ÊÄÅ
      pagination.value.currentPage = 1
      pagination.value.pageSize = 20
      pagination.value.totalCount = 0
      pagination.value.totalPages = 0
      
      // Ê∏ÖÁ©∫ÊêúÁ¥¢ÁªìÊûúÁä∂ÊÄÅ
      fieldSearchResult.value = {}
      
      // ÂêåÊó∂Ëé∑ÂèñË°®ÁªìÊûÑÔºàÂà†Èô§ÂäüËÉΩÈúÄË¶Å‰∏ªÈîÆ‰ø°ÊÅØÔºâ
      try {
        const response = await api.get(`/api/database/tables/${tableName}/columns`, {
          params: {
            dataSource: selectedDatabase.value
          }
        })
        tableColumns.value = response.data
      } catch (error) {
        console.error('Ëé∑ÂèñË°®ÁªìÊûÑÂ§±Ë¥•:', error)
      }
      
      await loadTableDataWithPagination()
    }

    // ÊòæÁ§∫ÂØºÂá∫ÂØπËØùÊ°Ü
    const showExportDialog = (tableName) => {
      exportTableName.value = tableName
      exportDialogVisible.value = true
    }

    // ÂÖ≥Èó≠ÂØºÂá∫ÂØπËØùÊ°Ü
    const closeExportDialog = () => {
      exportDialogVisible.value = false
      exportTableName.value = ''
    }

    const loadTableData = async () => {
      try {
        const response = await api.get(`/api/database/tables/${selectedTable.value}/data?limit=${dataLimit.value}`)
        tableData.value = response.data
      } catch (error) {
        console.error('Âä†ËΩΩË°®Êï∞ÊçÆÂ§±Ë¥•:', error)
      }
    }

    // ÂàÜÈ°µÂä†ËΩΩË°®Êï∞ÊçÆ
    const loadTableDataWithPagination = async () => {
      try {
        // Á´ãÂç≥Ê∏ÖÁ©∫Ë°®Êï∞ÊçÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        tableData.value = []
        tableDataLoading.value = true
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆ
        if (fieldSearchResult.value && fieldSearchResult.value.searchValue) {
          // Âä†ËΩΩÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆÔºàÊîØÊåÅÂàÜÈ°µÔºâ
          await loadSearchResultDataWithPagination()
        } else {
          // Âä†ËΩΩÊôÆÈÄöË°®Êï∞ÊçÆ
          const response = await api.get(`/api/database/tables/${selectedTable.value}/data/page`, {
            params: {
              page: pagination.value.currentPage,
              size: pagination.value.pageSize,
              dataSource: selectedDatabase.value
            }
          })
          
          const result = response.data
          
          // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ‰ø°ÊÅØ
          if (result.error) {
            ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + result.error)
            return
          }
          
          tableData.value = result.data || []
          pagination.value.totalCount = result.totalCount || 0
          pagination.value.totalPages = result.totalPages || 0
          pagination.value.currentPage = result.currentPage || 1
          pagination.value.pageSize = result.pageSize || 20
        }
        
      } catch (error) {
        console.error('Âä†ËΩΩË°®Êï∞ÊçÆÂ§±Ë¥•:', error)
        const errorMsg = error.response?.data?.error || error.message
        
        // Â§ÑÁêÜË∂ÖÊó∂ÈîôËØØ
        if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
          ElMessage.error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï')
        } else if (errorMsg.includes('ËøûÊé•') || errorMsg.includes('network') || errorMsg.includes('Network')) {
          ElMessage.error('ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅÂêéÈáçËØï')
        } else {
          ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + errorMsg)
        }
        
        // ÈáçÁΩÆÊï∞ÊçÆ
        tableData.value = []
        pagination.value.totalCount = 0
        pagination.value.totalPages = 0
      } finally {
        tableDataLoading.value = false
      }
    }

    // ÂàÜÈ°µÂä†ËΩΩÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆ
    const loadSearchResultDataWithPagination = async () => {
      const userInfo = userState.getUserInfo()
      if (!userInfo.userId || !userInfo.userType) {
        throw new Error('Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂä†ËΩΩÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆ')
      }
      
      const response = await api.get('/api/database/search/data-by-value', {
        params: {
          tableName: selectedTable.value,
          searchValue: fieldSearchResult.value.searchValue,
          dataSource: selectedDatabase.value,
          page: pagination.value.currentPage,
          size: pagination.value.pageSize,
          userId: userInfo.userId,
          userType: userInfo.userType,
          searchMode: 'auto',
          searchType: currentSearchType.value || 'fuzzy'
        },
        timeout: 600000 // 10ÂàÜÈíüË∂ÖÊó∂
      })
      
      const searchData = response.data
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ‰ø°ÊÅØ
      if (searchData.error) {
        ElMessage.error('Âä†ËΩΩÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆÂ§±Ë¥•: ' + searchData.error)
        return
      }
      
      tableData.value = searchData.data || []
      pagination.value.totalCount = searchData.totalCount || 0
      pagination.value.totalPages = searchData.totalPages || Math.ceil((searchData.totalCount || 0) / pagination.value.pageSize)
      pagination.value.currentPage = searchData.currentPage || pagination.value.currentPage
      pagination.value.pageSize = searchData.pageSize || pagination.value.pageSize
    }

    // ÂàÜÈ°µ‰∫ã‰ª∂Â§ÑÁêÜ
    const handleSizeChange = (newSize) => {
      pagination.value.pageSize = newSize
      pagination.value.currentPage = 1
      loadTableDataWithPagination()
    }

    const handleCurrentChange = (newPage) => {
      pagination.value.currentPage = newPage
      loadTableDataWithPagination()
    }

    const changePageSize = () => {
      pagination.value.currentPage = 1
      loadTableDataWithPagination()
    }

    // Â≠óÊÆµÂÄºÊêúÁ¥¢Áõ∏ÂÖ≥ÊñπÊ≥ï
    const handleSearchCommand = (command) => {
      // command ‰∏∫ 'fuzzy' Êàñ 'exact'
      searchTablesByFieldValue(command)
    }

    const searchTablesByFieldValue = async (searchType = 'fuzzy') => {
      if (!fieldSearchQuery.value.trim()) {
        fieldSearchError.value = 'ÊêúÁ¥¢ÂÄº‰∏çËÉΩ‰∏∫Á©∫'
        return
      }

      // Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ
      const userInfo = userState.getUserInfo()
      if (!userInfo.userId || !userInfo.userType) {
        fieldSearchError.value = 'ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçËøõË°åÊêúÁ¥¢'
        return
      }

      // Êõ¥Êñ∞ÂΩìÂâçÊêúÁ¥¢Á±ªÂûã
      currentSearchType.value = searchType

      // Á´ãÂç≥ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó
      showSearchProgressDialog(fieldSearchQuery.value.trim())

      fieldSearching.value = true
      fieldSearchError.value = ''
      fieldSearchResult.value = {}

      try {
        // ‰ΩøÁî®SSEÊé•Êî∂ÂÆûÊó∂ËøõÂ∫¶ÔºåÈªòËÆ§‰ΩøÁî®Êô∫ËÉΩÊ®°Âºè
        await startRealTimeSearch(fieldSearchQuery.value, selectedDatabase.value, userInfo.userId, userInfo.userType, 'auto', searchType)
      } catch (error) {
        closeSearchProgressDialog()
        
        // Â¶ÇÊûúÊòØÁî®Êà∑ÂèñÊ∂àÁöÑËØ∑Ê±ÇÔºå‰∏çÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (error.message && error.message.includes('canceled')) {
          ElMessage.info('ÊêúÁ¥¢Â∑≤ÂèñÊ∂à')
          return
        }
        
        fieldSearchError.value = error.message || 'Â≠óÊÆµÂÄºÊêúÁ¥¢Â§±Ë¥•'
        ElMessage.error(fieldSearchError.value)
      } finally {
        fieldSearching.value = false
      }
    }

    // ÂàõÂª∫Êñ∞ÁöÑÊêúÁ¥¢ÂºπÁ™ó
    const createNewSearchDialog = (searchValue, result) => {
      return searchDialogsState.addSearchDialog(searchValue, result)
    }

    // ÊúÄÂ∞èÂåñÂºπÁ™ó
    const minimizeDialog = (dialogId) => {
      searchDialogsState.minimizeDialog(dialogId)
    }

    // ÊÅ¢Â§çÂºπÁ™ó
    const restoreDialog = (dialogId) => {
      searchDialogsState.restoreDialog(dialogId)
    }

    // ÂÖ≥Èó≠ÂºπÁ™ó
    const closeDialog = (dialogId) => {
      searchDialogsState.closeDialog(dialogId)
    }

    // Ê∏ÖÁ©∫Âçï‰∏™ÊêúÁ¥¢
    const clearSingleSearch = (dialogId) => {
      searchDialogsState.clearSingleSearch(dialogId)
    }

    // Ê∏ÖÁ©∫ÊâÄÊúâÊêúÁ¥¢
    const clearAllSearches = () => {
      searchDialogsState.clearAllSearches()
    }

    // Ê∏ÖÁ©∫ÁâπÂÆöÊï∞ÊçÆÂ∫ìÁöÑÊêúÁ¥¢ÁªìÊûú
    const clearSearchesByDatabase = (databaseName) => {
      searchDialogsState.clearSearchesByDatabase(databaseName)
    }

    // ÊêúÁ¥¢ËøõÂ∫¶Áõ∏ÂÖ≥ÊñπÊ≥ï
    const showSearchProgressDialog = (searchValue) => {
      currentSearchValue.value = searchValue
      searchProgressDialogVisible.value = true
      searchProgressPercentage.value = 0
      searchProgressText.value = 'ÂáÜÂ§áÂºÄÂßãÊêúÁ¥¢...'
      currentSearchingTable.value = ''
      foundTablesCount.value = 0
      totalTablesCount.value = 0
      searchStartTime.value = Date.now()
      searchElapsedTime.value = 0
      cancelling.value = false
      
      // ÂêØÂä®ËÆ°Êó∂Âô®
      startElapsedTimeTimer()
    }

    const closeSearchProgressDialog = () => {
      searchProgressDialogVisible.value = false
      stopElapsedTimeTimer()
      if (searchTimer.value) {
        clearTimeout(searchTimer.value)
        searchTimer.value = null
      }
    }

    // SSEÂÆûÊó∂ÊêúÁ¥¢ÊñπÊ≥ï
    const startRealTimeSearch = (searchValue, dataSource, userId, userType, searchMode = 'auto', searchType = 'fuzzy') => {
      return new Promise((resolve, reject) => {
        const baseUrl = api.defaults.baseURL || ''
        const url = `${baseUrl}/api/database/search/tables-by-value-progress?` + new URLSearchParams({
          searchValue,
          dataSource,
          userId: userId.toString(),
          userType,
          searchMode,
          searchType
        })

        const eventSource = new EventSource(url)
        currentSearchAbortController.value = { eventSource }
        let searchResult = null
        let isCompleted = false // Ê∑ªÂä†Ê†áÂøóÊù•Ë∑üË∏™ÊòØÂê¶Ê≠£Â∏∏ÂÆåÊàê

        // ÁõëÂê¨ÂêÑÁßç‰∫ã‰ª∂
        eventSource.addEventListener('start', (event) => {
          const data = JSON.parse(event.data)
          console.log('ÊêúÁ¥¢ÂºÄÂßã:', data)
          searchProgressText.value = 'Ê≠£Âú®ÂáÜÂ§áÊêúÁ¥¢...'
        })

        eventSource.addEventListener('total', (event) => {
          const data = JSON.parse(event.data)
          totalTablesCount.value = data.totalTables
          console.log('ÊÄªË°®Êï∞:', data.totalTables)
        })

        eventSource.addEventListener('progress', (event) => {
          const data = JSON.parse(event.data)
          currentSearchingTable.value = data.currentTable
          searchProgressPercentage.value = data.percentage
          searchProgressText.value = `${data.searchedCount}/${data.totalCount}`
          foundTablesCount.value = data.foundCount
          
          console.log('ÊêúÁ¥¢ËøõÂ∫¶:', data)
        })

        eventSource.addEventListener('found', (event) => {
          const data = JSON.parse(event.data)
          foundTablesCount.value = data.foundCount
          console.log('ÊâæÂà∞ÂåπÈÖçË°®:', data.table.TABLE_NAME)
        })

        eventSource.addEventListener('complete', (event) => {
          const data = JSON.parse(event.data)
          console.log('ÊêúÁ¥¢ÂÆåÊàê:', data)
          
          isCompleted = true // Ê†áËÆ∞‰∏∫Ê≠£Â∏∏ÂÆåÊàê
          
          searchProgressText.value = `${data.searchedCount}/${data.searchedCount}`
          searchProgressPercentage.value = 100
          currentSearchingTable.value = 'ÊêúÁ¥¢ÂÆåÊàê'
          foundTablesCount.value = data.foundCount
          
          // ‰øùÂ≠òÊêúÁ¥¢ÁªìÊûú
          searchResult = data
          fieldSearchResult.value = data
          
          // ÂÖ≥Èó≠ËøõÂ∫¶ÂºπÁ™ó
          setTimeout(() => {
            closeSearchProgressDialog()
            
            // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
            if (data.tables && data.tables.length > 0) {
              createNewSearchDialog(searchValue, data)
            } else {
              ElMessage.info('Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´ËØ•ÂÄºÁöÑË°®')
            }
            
            eventSource.close()
            resolve(searchResult)
          }, 1000)
        })

        eventSource.addEventListener('error', (event) => {
          console.error('SSEÈîôËØØ:', event)
          const data = JSON.parse(event.data)
          eventSource.close()
          reject(new Error(data.message || 'ÊêúÁ¥¢ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ'))
        })

        eventSource.addEventListener('timeout', (event) => {
          const data = JSON.parse(event.data)
          console.warn('ÊêúÁ¥¢Ë∂ÖÊó∂:', data)
          ElMessage.warning(`ÊêúÁ¥¢Ë∂ÖÊó∂ÔºåÂ∑≤ÊêúÁ¥¢ ${data.searchedCount} ‰∏™Ë°®ÔºåÊâæÂà∞ ${data.foundCount} ‰∏™ÂåπÈÖçË°®`)
          eventSource.close()
          resolve(searchResult)
        })

        eventSource.addEventListener('table_error', (event) => {
          const data = JSON.parse(event.data)
          console.warn('Ë°®ÊêúÁ¥¢ÈîôËØØ:', data)
        })

        eventSource.onerror = () => {
          // Âè™ÊúâÂú®ÈùûÊ≠£Â∏∏ÂÆåÊàêÁöÑÊÉÖÂÜµ‰∏ãÊâçÊä•ÂëäÈîôËØØ
          if (!isCompleted) {
            console.error('EventSourceËøûÊé•ÈîôËØØ')
            eventSource.close()
            reject(new Error('ÁΩëÁªúËøûÊé•ÈîôËØØÔºåËØ∑ÈáçËØï'))
          }
        }
      })
    }

    const startElapsedTimeTimer = () => {
      const timer = setInterval(() => {
        if (!searchProgressDialogVisible.value) {
          clearInterval(timer)
          return
        }
        searchElapsedTime.value = Date.now() - searchStartTime.value
      }, 1000)
    }

    const stopElapsedTimeTimer = () => {
      // ËÆ°Êó∂Âô®‰ºöÂú®‰∏ãÊ¨°Êõ¥Êñ∞Êó∂Ëá™Âä®ÂÅúÊ≠¢
    }

    const formatElapsedTime = (ms) => {
      const seconds = Math.floor(ms / 1000)
      const minutes = Math.floor(seconds / 60)
      const remainingSeconds = seconds % 60
      
      if (minutes > 0) {
        return `${minutes}ÂàÜ${remainingSeconds}Áßí`
      } else {
        return `${remainingSeconds}Áßí`
      }
    }

    const cancelSearch = () => {
      cancelling.value = true
      
      // ÂÖ≥Èó≠SSEËøûÊé•
      if (currentSearchAbortController.value && currentSearchAbortController.value.eventSource) {
        currentSearchAbortController.value.eventSource.close()
        currentSearchAbortController.value = null
      }
      
      // ÂÖ≥Èó≠ËøõÂ∫¶ÂºπÁ™ó
      closeSearchProgressDialog()
      
      // ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
      fieldSearching.value = false
      ElMessage.info('ÊêúÁ¥¢Â∑≤ÂèñÊ∂à')
    }

    const viewSearchResultData = async (tableName, searchValue = null) => {
      // Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ
      const userInfo = userState.getUserInfo()
      if (!userInfo.userId || !userInfo.userType) {
        console.error('Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÊü•ÁúãË°®Êï∞ÊçÆ')
        return
      }

      try {
        selectedTable.value = tableName
        dataDialogVisible.value = true
        
        // Á´ãÂç≥Ê∏ÖÁ©∫Ë°®Êï∞ÊçÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        tableData.value = []
        tableDataLoading.value = true
        
        // ÈáçÁΩÆÂàÜÈ°µÁä∂ÊÄÅ
        pagination.value.currentPage = 1
        pagination.value.pageSize = 20
        pagination.value.totalCount = 0
        pagination.value.totalPages = 0
        
        // Ëé∑ÂèñË°®ÁªìÊûÑ
        const structureResponse = await api.get(`/api/database/tables/${tableName}/columns`, {
          params: {
            dataSource: selectedDatabase.value
          }
        })
        tableColumns.value = structureResponse.data

        // Â¶ÇÊûúÊúâÊêúÁ¥¢ÂÄºÔºåËé∑ÂèñÂåÖÂê´ÊêúÁ¥¢ÂÄºÁöÑÊï∞ÊçÆ
        if (searchValue) {
          // ËÆæÁΩÆÊêúÁ¥¢ÁªìÊûúÁî®‰∫éÈ´ò‰∫ÆÊòæÁ§∫
          fieldSearchResult.value = { searchValue: searchValue }
          
          // ‰ΩøÁî®ÂàÜÈ°µÂä†ËΩΩÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆ
          await loadTableDataWithPagination()
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÊêúÁ¥¢ÂÄºÔºåÂä†ËΩΩÊôÆÈÄöË°®Êï∞ÊçÆ
          fieldSearchResult.value = {}
          await loadTableDataWithPagination()
        }
        
      } catch (error) {
        console.error('Êü•ÁúãÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆÂ§±Ë¥•:', error)
        ElMessage.error('Êü•ÁúãÊêúÁ¥¢ÁªìÊûúÊï∞ÊçÆÂ§±Ë¥•: ' + (error.response?.data?.error || error.message))
        
        // ÂèëÁîüÈîôËØØÊó∂‰πüË¶ÅÂÖ≥Èó≠Âä†ËΩΩÁä∂ÊÄÅ
        tableDataLoading.value = false
        tableData.value = []
      }
    }

    const clearFieldSearch = () => {
      fieldSearchQuery.value = ''
      fieldSearchResult.value = {}
      fieldSearchError.value = ''
      fieldSearchResultDialogVisible.value = false
    }

    // Âà§Êñ≠ÂçïÂÖÉÊ†ºÂÄºÊòØÂê¶ÂåÖÂê´ÊêúÁ¥¢ÂÄº
    const cellContainsSearchValue = (cellValue, searchValue) => {
      if (!cellValue || !searchValue) return false
      
      const cellStr = String(cellValue).toLowerCase()
      const searchStr = String(searchValue).toLowerCase()
      
      // Ê†πÊçÆÂΩìÂâçÊêúÁ¥¢Á±ªÂûãÂÜ≥ÂÆöÂåπÈÖçÈÄªËæë
      if (currentSearchType.value === 'exact') {
        // Á≤æÁ°ÆÊêúÁ¥¢ÔºöÂÆåÂÖ®ÂåπÈÖç
        return cellStr === searchStr
      } else {
        // Ê®°Á≥äÊêúÁ¥¢ÔºöÂåÖÂê´ÂåπÈÖçÔºà‰ΩøÁî®ÂéüÊù•ÁöÑÁÆÄÂçïÂåÖÂê´ÈÄªËæëÔºâ
        return cellStr.includes(searchStr)
      }
    }

    const formatBytes = (bytes) => {
      if (!bytes) return '0 B'
      const k = 1024
      const sizes = ['B', 'KB', 'MB', 'GB']
      const i = Math.floor(Math.log(bytes) / Math.log(k))
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
    }

    const formatDate = (dateStr) => {
      if (!dateStr) return 'N/A'
      
      try {
        const date = new Date(dateStr)
        if (isNaN(date.getTime())) {
          return 'N/A'
        }
        return date.toLocaleString('zh-CN')
      } catch (error) {
        console.warn('Êó•ÊúüÊ†ºÂºèÂåñÂ§±Ë¥•:', dateStr, error)
        return 'N/A'
      }
    }

    const getColumnWidth = (columnName) => {
      // Ê†πÊçÆÂàóÂêçÈïøÂ∫¶ÂíåÊï∞ÊçÆÁ±ªÂûãË∞ÉÊï¥ÂàóÂÆΩ
      const baseWidth = Math.max(columnName.length * 10, 100)
      return Math.min(baseWidth, 200)
    }
    
    const showAddDataDialog = async () => {
      // Ê£ÄÊü•ÂÜôÂÖ•ÊùÉÈôê
      const permission = checkDatabasePermission(selectedDatabase.value, 'write')
      if (!permission.allowed) {
        ElMessage.error(permission.message)
        return
      }
      
      try {
        // ÂÖàËé∑ÂèñË°®ÁªìÊûÑ
        const response = await api.get(`/api/database/tables/${selectedTable.value}/columns`, {
          params: {
            dataSource: selectedDatabase.value
          }
        })
        tableColumns.value = response.data
        
        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰∏ªÈîÆ
        hasPrimaryKey.value = tableColumns.value.some(col => col.COLUMN_KEY === 'PRI')
        
        // ÂàùÂßãÂåñÊñ∞Ë°åÊï∞ÊçÆ
        newRowData.value = {}
        tableColumns.value.forEach(column => {
          if (column.COLUMN_DEFAULT !== null) {
            newRowData.value[column.COLUMN_NAME] = column.COLUMN_DEFAULT
          } else {
            newRowData.value[column.COLUMN_NAME] = ''
          }
        })
        
        addDataDialogVisible.value = true
      } catch (error) {
        console.error('Ëé∑ÂèñË°®ÁªìÊûÑÂ§±Ë¥•:', error)
        ElMessage.error('Ëé∑ÂèñË°®ÁªìÊûÑÂ§±Ë¥•')
      }
    }

    const submitNewData = async () => {
      try {
        submitting.value = true
        
        // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
        const requiredFields = tableColumns.value.filter(col => 
          col.IS_NULLABLE === 'NO' && !col.EXTRA.includes('auto_increment')
        )
        
        for (const field of requiredFields) {
          const value = newRowData.value[field.COLUMN_NAME]
          if (!value || value.toString().trim() === '') {
            ElMessage.error(`Â≠óÊÆµ ${field.COLUMN_NAME} ÊòØÂøÖÂ°´È°π`)
            return
          }
        }
        
        // ËøáÊª§ÊéâÁ©∫ÂÄºÂíåËá™Â¢ûÂ≠óÊÆµ
        const dataToSubmit = {}
        tableColumns.value.forEach(column => {
          const value = newRowData.value[column.COLUMN_NAME]
          if (!column.EXTRA.includes('auto_increment') && value !== '' && value !== null) {
            dataToSubmit[column.COLUMN_NAME] = value
          }
        })

        const response = await api.post(`/api/database/tables/${selectedTable.value}/data`, {
          dataSource: selectedDatabase.value,
          data: dataToSubmit
        })
        
        if (response.data.success) {
          ElMessage.success(response.data.message)
          addDataDialogVisible.value = false
          // Ê†áËÆ∞Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞
          markDataUpdated()
          // Ê†áËÆ∞ÂΩìÂâçË°®Â∑≤Êõ¥Êñ∞
          markTableUpdated(selectedTable.value)
          // Êõ¥Êñ∞ÂΩìÂâçË°®ÁöÑË°åÊï∞
          await updateTableRowCount(selectedTable.value)
          // Âà∑Êñ∞Ë°®Êï∞ÊçÆ
          await loadTableDataWithPagination()
        } else {
          ElMessage.error(response.data.error || 'Êï∞ÊçÆÊèíÂÖ•Â§±Ë¥•')
        }
      } catch (error) {
        const errorMsg = error.response?.data?.error || error.message
        
        // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØ‰ø°ÊÅØ
        let friendlyMessage = 'Êï∞ÊçÆÊèíÂÖ•Â§±Ë¥•'
        
        if (errorMsg) {
          if (errorMsg.includes('Êï∞ÊçÆÈáçÂ§ç') || errorMsg.includes('‰∏ªÈîÆÈáçÂ§ç')) {
            friendlyMessage = errorMsg // ÂêéÁ´ØÂ∑≤ÁªèÊèê‰æõ‰∫ÜÂèãÂ•ΩÁöÑÈîôËØØ‰ø°ÊÅØ
          } else if (errorMsg.includes('ÂøÖÂ°´Â≠óÊÆµÁº∫Â§±') || errorMsg.includes('cannot be null')) {
            friendlyMessage = errorMsg.includes('ÂøÖÂ°´Â≠óÊÆµÁº∫Â§±') ? errorMsg : 'ÂøÖÂ°´Â≠óÊÆµ‰∏çËÉΩ‰∏∫Á©∫ÔºåËØ∑Ê£ÄÊü•Ë°®Âçï'
          } else if (errorMsg.includes('Êï∞ÊçÆÈïøÂ∫¶Ë∂ÖÈôê') || errorMsg.includes('Data too long')) {
            friendlyMessage = errorMsg.includes('Êï∞ÊçÆÈïøÂ∫¶Ë∂ÖÈôê') ? errorMsg : 'ËæìÂÖ•ÁöÑÊï∞ÊçÆËøáÈïøÔºåËØ∑Áº©Áü≠ÂÜÖÂÆπ'
          } else if (errorMsg.includes('Â§ñÈîÆÁ∫¶ÊùüÂ§±Ë¥•')) {
            friendlyMessage = errorMsg
          } else if (errorMsg.includes('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ')) {
            friendlyMessage = errorMsg
          } else if (errorMsg.includes('ÊùÉÈôê‰∏çË∂≥')) {
            friendlyMessage = 'ÊùÉÈôê‰∏çË∂≥ÔºöÊÇ®Ê≤°ÊúâÂêëÊ≠§Ë°®ÊèíÂÖ•Êï∞ÊçÆÁöÑÊùÉÈôê'
          } else if (errorMsg.includes('Ë°®‰∏çÂ≠òÂú®')) {
            friendlyMessage = 'ÁõÆÊ†áË°®‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï'
          } else if (errorMsg.includes('ËøûÊé•Â§±Ë¥•') || errorMsg.includes('timeout')) {
            friendlyMessage = 'Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï'
          } else if (errorMsg.includes('Duplicate entry')) {
            // Â§ÑÁêÜÂéüÂßãÁöÑMySQLÈîôËØØ‰ø°ÊÅØ
            const match = errorMsg.match(/Duplicate entry '(.+?)' for key '(.+?)'/);
            if (match) {
              const keyName = match[2].replace(/^.*\./, ''); // ÁßªÈô§Ë°®ÂêçÂâçÁºÄ
              friendlyMessage = `Êï∞ÊçÆÈáçÂ§çÔºö${keyName === 'PRIMARY' ? '‰∏ªÈîÆ' : `Â≠óÊÆµ '${keyName}'`} ÁöÑÂÄº "${match[1]}" Â∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑÂÄº`
            } else {
              friendlyMessage = 'Êï∞ÊçÆÈáçÂ§çÔºöËØ•ËÆ∞ÂΩïÂ∑≤Â≠òÂú®ÔºåËØ∑Ê£ÄÊü•‰∏ªÈîÆÊàñÂîØ‰∏ÄÂ≠óÊÆµÁöÑÂÄº'
            }
          } else {
            friendlyMessage = 'Êï∞ÊçÆÊèíÂÖ•Â§±Ë¥•Ôºö' + errorMsg
          }
        }
        
        ElMessage.error(friendlyMessage)
      } finally {
        submitting.value = false
      }
    }

    const getColumnPlaceholder = (column) => {
      if (column.EXTRA.includes('auto_increment')) {
        return 'Ëá™Âä®ÁîüÊàê'
      }
      if (column.COLUMN_KEY === 'PRI') {
        return '‰∏ªÈîÆÔºà‰∏çÂèØ‰øÆÊîπÔºâ'
      }
      if (column.COLUMN_DEFAULT !== null) {
        return `ÈªòËÆ§ÂÄº: ${column.COLUMN_DEFAULT}`
      }
      if (column.IS_NULLABLE === 'YES') {
        return 'ÂèØÈÄâÂ°´'
      }
      return 'ÂøÖÂ°´'
    }

    const getColumnTagType = (column) => {
      if (column.COLUMN_KEY === 'PRI') return 'warning'
      if (column.EXTRA.includes('auto_increment')) return 'info'
      if (column.IS_NULLABLE === 'NO') return 'danger'
      return 'success'
    }

    const getColumnDescription = (column) => {
      let desc = []
      if (column.COLUMN_KEY === 'PRI') desc.push('‰∏ªÈîÆ')
      if (column.EXTRA.includes('auto_increment')) desc.push('Ëá™Âä®ÈÄíÂ¢û')
      if (column.IS_NULLABLE === 'NO') desc.push('ÂøÖÂ°´')
      if (column.COLUMN_COMMENT) desc.push(column.COLUMN_COMMENT)
      return desc.join(' | ')
    }

    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ENUMÁ±ªÂûã
    const isEnumType = (column) => {
      return column.DATA_TYPE.toLowerCase() === 'enum'
    }

    // ‰ªéENUMÂ≠óÊÆµÂÆö‰πâ‰∏≠ÊèêÂèñÂèØÈÄâÂÄº
    const getEnumValues = (column) => {
      if (!isEnumType(column)) return []
      
      // ‰ªéCOLUMN_TYPE‰∏≠ÊèêÂèñENUMÂÄºÔºåÊ†ºÂºèÂ¶ÇÔºöenum('value1','value2','value3')
      const columnType = column.COLUMN_TYPE || ''
      const match = columnType.match(/enum\((.*?)\)/i)
      
      if (match) {
        // ÊèêÂèñÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπÔºåÁÑ∂ÂêéÂàÜÂâ≤Âπ∂Ê∏ÖÁêÜÂºïÂè∑
        const valuesStr = match[1]
        const values = valuesStr.split(',').map(value => {
          // ÁßªÈô§ÂâçÂêéÁöÑÂºïÂè∑ÂíåÁ©∫Ê†º
          return value.trim().replace(/^['"]|['"]$/g, '')
        }).filter(value => value.length > 0) // ËøáÊª§Á©∫ÂÄº
        
        return values
      }
      
      return []
    }

    const confirmDeleteRow = async (row) => {
      // Ê£ÄÊü•ÂÜôÂÖ•ÊùÉÈôê
      const permission = checkDatabasePermission(selectedDatabase.value, 'write')
      if (!permission.allowed) {
        ElMessage.error(permission.message)
        return
      }
      
      try {
        // Ëé∑Âèñ‰∏ªÈîÆÂ≠óÊÆµÔºåÁî®‰∫éÊûÑÂª∫Âà†Èô§Êù°‰ª∂
        const primaryKeys = tableColumns.value.filter(col => col.COLUMN_KEY === 'PRI')
        
        if (primaryKeys.length === 0) {
          ElMessage.warning('Ê≠§Ë°®Ê≤°Êúâ‰∏ªÈîÆÔºåÊó†Ê≥ïÂÆâÂÖ®Âà†Èô§Êï∞ÊçÆ')
          return
        }

        // ÊûÑÂª∫ÊòæÁ§∫ÁöÑ‰∏ªÈîÆÂÄº‰ø°ÊÅØ
        const keyInfo = primaryKeys.map(pk => `${pk.COLUMN_NAME}: ${row[pk.COLUMN_NAME]}`).join(', ')
        
        const result = await ElMessageBox.confirm(
          `Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êï∞ÊçÆÂêóÔºü\n‰∏ªÈîÆ: ${keyInfo}`,
          'Á°ÆËÆ§Âà†Èô§',
          {
            confirmButtonText: 'Á°ÆÂÆöÂà†Èô§',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning',
            dangerouslyUseHTMLString: false
          }
        )

        if (result === 'confirm') {
          await deleteRow(row)
        }
      } catch (error) {
        // Áî®Êà∑ÂèñÊ∂àÂà†Èô§Ôºå‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
        if (error !== 'cancel') {
          console.error('Âà†Èô§Á°ÆËÆ§Âá∫Èîô:', error)
        }
      }
    }

    const deleteRow = async (row) => {
      try {
        // ÊûÑÂª∫Âà†Èô§Êù°‰ª∂Ôºà‰ΩøÁî®‰∏ªÈîÆÔºâ
        const primaryKeys = tableColumns.value.filter(col => col.COLUMN_KEY === 'PRI')
        const whereConditions = {}
        
        primaryKeys.forEach(pk => {
          whereConditions[pk.COLUMN_NAME] = row[pk.COLUMN_NAME]
        })

        const response = await api.delete(`/api/database/tables/${selectedTable.value}/data`, {
          data: {
            dataSource: selectedDatabase.value,
            whereConditions: whereConditions
          }
        })
        
        if (response.data.success) {
          ElMessage.success(response.data.message)
          // Ê†áËÆ∞Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞
          markDataUpdated()
          // Ê†áËÆ∞ÂΩìÂâçË°®Â∑≤Êõ¥Êñ∞
          markTableUpdated(selectedTable.value)
          // Êõ¥Êñ∞ÂΩìÂâçË°®ÁöÑË°åÊï∞
          await updateTableRowCount(selectedTable.value)
          // Âà∑Êñ∞Ë°®Êï∞ÊçÆ
          await loadTableDataWithPagination()
        } else {
          ElMessage.warning(response.data.message || 'Âà†Èô§Â§±Ë¥•')
        }
      } catch (error) {
        const errorMsg = error.response?.data?.error || error.message
        ElMessage.error('Âà†Èô§Â§±Ë¥•: ' + errorMsg)
      }
    }

    const editRow = (row) => {
      // Ê£ÄÊü•ÂÜôÂÖ•ÊùÉÈôê
      const permission = checkDatabasePermission(selectedDatabase.value, 'write')
      if (!permission.allowed) {
        ElMessage.error(permission.message)
        return
      }
      
      // Ê∑±Êã∑Ë¥ùÂéüÂßãÊï∞ÊçÆ
      originalRowData.value = JSON.parse(JSON.stringify(row))
      editRowData.value = JSON.parse(JSON.stringify(row))
      editDataDialogVisible.value = true
    }

    const submitEditData = async () => {
      try {
        submitting.value = true
        
        // Ëé∑Âèñ‰∏ªÈîÆÂ≠óÊÆµÔºåÁî®‰∫éÊûÑÂª∫WHEREÊù°‰ª∂
        const primaryKeys = tableColumns.value.filter(col => col.COLUMN_KEY === 'PRI')
        
        if (primaryKeys.length === 0) {
          ElMessage.warning('Ê≠§Ë°®Ê≤°Êúâ‰∏ªÈîÆÔºåÊó†Ê≥ïÊõ¥Êñ∞Êï∞ÊçÆ')
          return
        }

        // ÊûÑÂª∫WHEREÊù°‰ª∂Ôºà‰ΩøÁî®‰∏ªÈîÆÔºâ
        const whereConditions = {}
        primaryKeys.forEach(pk => {
          whereConditions[pk.COLUMN_NAME] = originalRowData.value[pk.COLUMN_NAME]
        })

        // ÊâæÂá∫‰øÆÊîπÁöÑÂ≠óÊÆµ
        const updateData = {}
        for (const column of tableColumns.value) {
          const columnName = column.COLUMN_NAME
          const originalValue = originalRowData.value[columnName]
          const newValue = editRowData.value[columnName]
          
          // Ë∑≥Ëøá‰∏ªÈîÆÂíåËá™Â¢ûÂ≠óÊÆµ
          if (column.COLUMN_KEY === 'PRI' || column.EXTRA.includes('auto_increment')) {
            continue
          }
          
          // Ê£ÄÊü•ÂÄºÊòØÂê¶ÊúâÂèòÂåñ
          if (originalValue !== newValue) {
            updateData[columnName] = newValue
          }
        }

        // Â¶ÇÊûúÊ≤°Êúâ‰øÆÊîπ‰ªª‰ΩïÂ≠óÊÆµ
        if (Object.keys(updateData).length === 0) {
          ElMessage.info('Ê≤°ÊúâÊï∞ÊçÆË¢´‰øÆÊîπ')
          editDataDialogVisible.value = false
          return
        }

        const response = await api.put(`/api/database/tables/${selectedTable.value}/data`, {
          dataSource: selectedDatabase.value,
          updateData: updateData,
          whereConditions: whereConditions
        })
        
        if (response.data.success) {
          ElMessage.success(response.data.message)
          editDataDialogVisible.value = false
          // Ê†áËÆ∞Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞
          markDataUpdated()
          // Ê†áËÆ∞ÂΩìÂâçË°®Â∑≤Êõ¥Êñ∞
          markTableUpdated(selectedTable.value)
          // Êõ¥Êñ∞ÂΩìÂâçË°®ÁöÑË°åÊï∞
          await updateTableRowCount(selectedTable.value)
          // Âà∑Êñ∞Ë°®Êï∞ÊçÆ
          await loadTableDataWithPagination()
        } else {
          ElMessage.warning(response.data.message || 'Êõ¥Êñ∞Â§±Ë¥•')
        }
      } catch (error) {
        const errorMsg = error.response?.data?.error || error.message
        
        // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØ‰ø°ÊÅØ
        let friendlyMessage = 'Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•'
        
        if (errorMsg) {
          if (errorMsg.includes('Êï∞ÊçÆÈáçÂ§ç') || errorMsg.includes('‰∏ªÈîÆÈáçÂ§ç')) {
            friendlyMessage = errorMsg // ÂêéÁ´ØÂ∑≤ÁªèÊèê‰æõ‰∫ÜÂèãÂ•ΩÁöÑÈîôËØØ‰ø°ÊÅØ
          } else if (errorMsg.includes('ÂøÖÂ°´Â≠óÊÆµÁº∫Â§±') || errorMsg.includes('cannot be null')) {
            friendlyMessage = errorMsg.includes('ÂøÖÂ°´Â≠óÊÆµÁº∫Â§±') ? errorMsg : 'ÂøÖÂ°´Â≠óÊÆµ‰∏çËÉΩ‰∏∫Á©∫ÔºåËØ∑Ê£ÄÊü•Ë°®Âçï'
          } else if (errorMsg.includes('Êï∞ÊçÆÈïøÂ∫¶Ë∂ÖÈôê') || errorMsg.includes('Data too long')) {
            friendlyMessage = errorMsg.includes('Êï∞ÊçÆÈïøÂ∫¶Ë∂ÖÈôê') ? errorMsg : 'ËæìÂÖ•ÁöÑÊï∞ÊçÆËøáÈïøÔºåËØ∑Áº©Áü≠ÂÜÖÂÆπ'
          } else if (errorMsg.includes('Â§ñÈîÆÁ∫¶ÊùüÂ§±Ë¥•')) {
            friendlyMessage = errorMsg + 'ÔºåÊó†Ê≥ïÊõ¥Êñ∞Ê≠§ËÆ∞ÂΩï'
          } else if (errorMsg.includes('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ')) {
            friendlyMessage = errorMsg
          } else if (errorMsg.includes('ÊùÉÈôê‰∏çË∂≥')) {
            friendlyMessage = 'ÊùÉÈôê‰∏çË∂≥ÔºöÊÇ®Ê≤°Êúâ‰øÆÊîπÊ≠§Ë°®Êï∞ÊçÆÁöÑÊùÉÈôê'
          } else if (errorMsg.includes('Duplicate entry')) {
            // Â§ÑÁêÜÂéüÂßãÁöÑMySQLÈîôËØØ‰ø°ÊÅØ
            const match = errorMsg.match(/Duplicate entry '(.+?)' for key '(.+?)'/);
            if (match) {
              const keyName = match[2].replace(/^.*\./, ''); // ÁßªÈô§Ë°®ÂêçÂâçÁºÄ
              friendlyMessage = `Êï∞ÊçÆÈáçÂ§çÔºö${keyName === 'PRIMARY' ? '‰∏ªÈîÆ' : `Â≠óÊÆµ '${keyName}'`} ÁöÑÂÄº "${match[1]}" Â∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑÂÄº`
            } else {
              friendlyMessage = 'Êï∞ÊçÆÈáçÂ§çÔºöËØ•ÂÄºÂ∑≤Â≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂîØ‰∏ÄÂ≠óÊÆµÁöÑÂÄº'
            }
          } else {
            friendlyMessage = 'Êï∞ÊçÆÊõ¥Êñ∞Â§±Ë¥•Ôºö' + errorMsg
          }
        }
        
        ElMessage.error(friendlyMessage)
      } finally {
        submitting.value = false
      }
    }

          const switchDatabase = () => {
        // ÂÆûÁé∞ÂàáÊç¢Êï∞ÊçÆÂ∫ìÁöÑÈÄªËæë
        console.log('ÂàáÊç¢Âà∞Êï∞ÊçÆÂ∫ì:', selectedDatabase.value)
        
        // Ê∏ÖÁ©∫ÂΩìÂâçÈ°µÈù¢ÁöÑÂ≠óÊÆµÊêúÁ¥¢ÁªìÊûúÔºà‰∏çÂΩ±ÂìçÊúÄÂ∞èÂåñÁöÑÊêúÁ¥¢ÂºπÁ™óÔºâ
        clearFieldSearch()
        
        // Ê∏ÖÁ©∫ÂÜÖÂ≠ò‰∏≠ÁöÑË°®Ë°åÊï∞ÁºìÂ≠òÔºàlocalStorageÁºìÂ≠ò‰øùÊåÅÔºâ
        tableRowCounts.value.clear()
        
        // ÈáçÁΩÆÊï∞ÊçÆÂ∫ì‰ø°ÊÅØ
        databaseInfo.value = null
        
        // Êõ¥Êñ∞ÊùÉÈôêÁä∂ÊÄÅ
        updatePermissionState()
        
        // Â¶ÇÊûúÊúâËÆøÈóÆÊùÉÈôêÔºåÂàôÂä†ËΩΩÊï∞ÊçÆ
        if (canAccessCurrentDatabase.value) {
          loadTables(false) // ÂàáÊç¢Êï∞ÊçÆÂ∫ìÊó∂‰∏çÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
          loadDatabaseInfo()
        } else {
          // Ê∏ÖÁ©∫Ë°®ÂàóË°®
          tableList.value = []
          databaseInfo.value = null
        }
        
        console.log('ÂàáÊç¢Êï∞ÊçÆÂ∫ìÂÆåÊàêÔºå‰øùÁïô‰∫Ü', searchDialogsState.searchDialogs.length, '‰∏™ÊêúÁ¥¢ÁªìÊûúÂºπÁ™ó')
    }
    
    // ÊòæÁ§∫Êñ∞Âª∫Êï∞ÊçÆÂ∫ìÂØπËØùÊ°Ü
    const showCreateDatabaseDialog = () => {
      // ÈáçÁΩÆË°®Âçï
      newDatabaseForm.value = {
        databaseName: '',
        charset: 'utf8',
        collation: 'utf8_general_ci',
        description: ''
      }
      createDatabaseDialogVisible.value = true
    }
    
    // ÂàõÂª∫Êï∞ÊçÆÂ∫ì
    const createDatabase = async () => {
      if (!databaseFormRef.value) return
      
      try {
        // Ë°®ÂçïÈ™åËØÅ
        const valid = await databaseFormRef.value.validate()
        if (!valid) return
        
        creatingDatabase.value = true
        
        const userInfo = userState.getUserInfo()
        const requestData = {
          ...newDatabaseForm.value,
          userId: userInfo.userId,
          userType: userInfo.userType
        }
        
        const response = await api.post('/api/database/create', requestData)
        
        if (response.data.success) {
          ElMessage.success(response.data.message)
          createDatabaseDialogVisible.value = false
          
          // Â∞ÜÊñ∞ÂàõÂª∫ÁöÑÊï∞ÊçÆÂ∫ìÊ∑ªÂä†Âà∞Êú¨Âú∞Êï∞ÊçÆÂ∫ìÂàóË°®
          const newDatabase = {
            name: response.data.databaseName,
            displayName: response.data.databaseName,
            description: response.data.description || 'Áî®Êà∑ÂàõÂª∫ÁöÑÊï∞ÊçÆÂ∫ì',
            type: response.data.type || 'mysql',
            status: response.data.status || 'active',
            charset: response.data.charset,
            collation: response.data.collation
          }
          
          // Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ìÂàóË°®ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®ÁöÑËØùÔºâ
          const existingIndex = availableDatabases.value.findIndex(db => db.name === newDatabase.name)
          if (existingIndex === -1) {
            availableDatabases.value.push(newDatabase)
          } else {
            availableDatabases.value[existingIndex] = newDatabase
          }
          
          // ÂàáÊç¢Âà∞Êñ∞ÂàõÂª∫ÁöÑÊï∞ÊçÆÂ∫ì
          selectedDatabase.value = newDatabase.name
          switchDatabase()
          
          // Âú®ÂêéÂè∞Âà∑Êñ∞Êï∞ÊçÆÂ∫ìÂàóË°®‰ª•Ëé∑ÂèñÊúÄÊñ∞‰ø°ÊÅØ
          loadAvailableDatabases().catch(err => {
            console.warn('ÂêéÂè∞Âà∑Êñ∞Êï∞ÊçÆÂ∫ìÂàóË°®Â§±Ë¥•:', err)
          })
        } else {
          ElMessage.error(response.data.error || 'ÂàõÂª∫Êï∞ÊçÆÂ∫ìÂ§±Ë¥•')
        }
        
      } catch (error) {
        console.error('ÂàõÂª∫Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error)
        const errorMsg = error.response?.data?.error || error.message
        ElMessage.error('ÂàõÂª∫Êï∞ÊçÆÂ∫ìÂ§±Ë¥•: ' + errorMsg)
      } finally {
        creatingDatabase.value = false
      }
    }
    
    // Ê£ÄÊü•Êï∞ÊçÆÂ∫ìÊòØÂê¶ÂèØ‰ª•Âà†Èô§ÔºàÂè™ÊúâÁî®Êà∑ÂàõÂª∫ÁöÑÊï∞ÊçÆÂ∫ìÂèØ‰ª•Âà†Èô§Ôºâ
    const canDeleteDatabase = (database) => {
              const systemDatabases = ['login', 'information_schema', 'mysql', 'performance_schema', 'sys']
      return !systemDatabases.includes(database.name.toLowerCase())
    }
    
    // ÊòæÁ§∫Âà†Èô§Êï∞ÊçÆÂ∫ìÁ°ÆËÆ§ÂØπËØùÊ°Ü
    const showDeleteDatabaseDialog = (database) => {
      databaseToDelete.value = database
      deleteConfirmText.value = ''
      deleteDatabaseDialogVisible.value = true
    }
    
    // ÂèñÊ∂àÂà†Èô§Êï∞ÊçÆÂ∫ì
    const cancelDeleteDatabase = () => {
      databaseToDelete.value = null
      deleteConfirmText.value = ''
      deleteDatabaseDialogVisible.value = false
    }
    
    // Á°ÆËÆ§Âà†Èô§Êï∞ÊçÆÂ∫ì
    const confirmDeleteDatabase = async () => {
      if (!databaseToDelete.value || deleteConfirmText.value !== databaseToDelete.value.name) {
        ElMessage.error('ËØ∑Ê≠£Á°ÆËæìÂÖ•Êï∞ÊçÆÂ∫ìÂêçÁß∞‰ª•Á°ÆËÆ§Âà†Èô§')
        return
      }
      
      try {
        deletingDatabase.value = true
        
        const userInfo = userState.getUserInfo()
        const requestData = {
          databaseName: databaseToDelete.value.name,
                      dataSource: 'login', // ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÊ∫ê
          userId: userInfo.userId,
          userType: userInfo.userType
        }
        
        const response = await api.delete('/api/database/drop', {
          data: requestData
        })
        
        if (response.data.success) {
          ElMessage.success(response.data.message)
          
          // ‰ªéÊú¨Âú∞Êï∞ÊçÆÂ∫ìÂàóË°®‰∏≠ÁßªÈô§Â∑≤Âà†Èô§ÁöÑÊï∞ÊçÆÂ∫ì
          const index = availableDatabases.value.findIndex(db => db.name === databaseToDelete.value.name)
          if (index !== -1) {
            availableDatabases.value.splice(index, 1)
          }
          
          // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØË¢´Âà†Èô§ÁöÑÊï∞ÊçÆÂ∫ìÔºåÂàáÊç¢Âà∞ÈªòËÆ§Êï∞ÊçÆÂ∫ì
          if (selectedDatabase.value === databaseToDelete.value.name) {
            selectedDatabase.value = 'login'
            switchDatabase()
          }
          
          // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
          cancelDeleteDatabase()
          
          // Âú®ÂêéÂè∞Âà∑Êñ∞Êï∞ÊçÆÂ∫ìÂàóË°®
          loadAvailableDatabases().catch(err => {
            console.warn('ÂêéÂè∞Âà∑Êñ∞Êï∞ÊçÆÂ∫ìÂàóË°®Â§±Ë¥•:', err)
          })
        } else {
          ElMessage.error(response.data.error || 'Âà†Èô§Êï∞ÊçÆÂ∫ìÂ§±Ë¥•')
        }
        
      } catch (error) {
        console.error('Âà†Èô§Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error)
        const errorMsg = error.response?.data?.error || error.message
        ElMessage.error('Âà†Èô§Êï∞ÊçÆÂ∫ìÂ§±Ë¥•: ' + errorMsg)
      } finally {
        deletingDatabase.value = false
             }
     }
     
     // =============================================================================
     // Ë°®ËÆæËÆ°Âô®Áõ∏ÂÖ≥ÊñπÊ≥ï
     // =============================================================================
     
     // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áî®Êà∑Êï∞ÊçÆÂ∫ì
     const isUserDatabase = (databaseName) => {
               // Âè™ÊéíÈô§ÁúüÊ≠£ÁöÑMySQLÁ≥ªÁªüÊï∞ÊçÆÂ∫ìÔºåÂÖÅËÆ∏‰∏öÂä°Êï∞ÊçÆÂ∫ìÂàõÂª∫Ë°®
       const systemDatabases = ['information_schema', 'mysql', 'performance_schema', 'sys']
       return !systemDatabases.includes(databaseName.toLowerCase())
     }
     
     // ÊòæÁ§∫Ë°®ËÆæËÆ°Âô®ÂØπËØùÊ°Ü
     const showCreateTableDialog = () => {
       // ÈáçÁΩÆË°®ËÆæËÆ°
       tableDesign.value = {
         tableName: '',
         tableComment: '',
         columns: []
       }
       generatedSQL.value = ''
       
       // Âä†ËΩΩÊï∞ÊçÆÁ±ªÂûã
       loadDataTypes()
       
       // ÊòæÁ§∫ÂØπËØùÊ°Ü
       createTableDialogVisible.value = true
     }
     
     // Âä†ËΩΩÊï∞ÊçÆÁ±ªÂûãÂàóË°®
     const loadDataTypes = async () => {
       try {
         const response = await api.get('/api/database/data-types')
         availableDataTypes.value = response.data
       } catch (error) {
         console.error('Âä†ËΩΩÊï∞ÊçÆÁ±ªÂûãÂ§±Ë¥•:', error)
         ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÁ±ªÂûãÂ§±Ë¥•: ' + error.message)
       }
     }
     
     // ÊåâÁ±ªÂà´ÂàÜÁªÑÁöÑÊï∞ÊçÆÁ±ªÂûã
     const groupedDataTypes = computed(() => {
       const groups = {}
       availableDataTypes.value.forEach(type => {
         if (!groups[type.category]) {
           groups[type.category] = {
             category: type.category,
             types: []
           }
         }
         groups[type.category].types.push(type)
       })
       return Object.values(groups)
     })
     
     // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïÂ§ñÈîÆÂàó
     const hasAnyForeignKey = computed(() => {
       return tableDesign.value.columns.some(col => col.isForeignKey)
     })
     
     // Ê∑ªÂä†Êñ∞Âàó
     const addColumn = () => {
       const newColumn = {
         name: '',
         dataType: 'VARCHAR',
         length: 255,
         decimals: null,
         isPrimary: false,
         isNotNull: false,
         isAutoIncrement: false,
         defaultValue: '',
         comment: '',
         nameError: '',
         // Â§ñÈîÆÁõ∏ÂÖ≥Â≠óÊÆµ
         isForeignKey: false,
         referenceTable: '',
         referenceColumn: '',
         onUpdate: 'RESTRICT',
         onDelete: 'CASCADE'
       }
       
       // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÂàóÔºåÈªòËÆ§ËÆæ‰∏∫‰∏ªÈîÆÂíåËá™Â¢û
       if (tableDesign.value.columns.length === 0) {
         newColumn.name = 'id'
         newColumn.dataType = 'INT'
         newColumn.length = 11
         newColumn.isPrimary = true
         newColumn.isNotNull = true
         newColumn.isAutoIncrement = true
         newColumn.comment = '‰∏ªÈîÆID'
       }
       
       tableDesign.value.columns.push(newColumn)
       updateSQL()
     }
     
     // Âà†Èô§Âàó
     const removeColumn = (index) => {
       tableDesign.value.columns.splice(index, 1)
       updateSQL()
     }
     
     // ÁßªÂä®Âàó‰ΩçÁΩÆ
     const moveColumnUp = (index) => {
       if (index > 0) {
         const temp = tableDesign.value.columns[index]
         tableDesign.value.columns[index] = tableDesign.value.columns[index - 1]
         tableDesign.value.columns[index - 1] = temp
         updateSQL()
       }
     }
     
     const moveColumnDown = (index) => {
       if (index < tableDesign.value.columns.length - 1) {
         const temp = tableDesign.value.columns[index]
         tableDesign.value.columns[index] = tableDesign.value.columns[index + 1]
         tableDesign.value.columns[index + 1] = temp
         updateSQL()
       }
     }
     
     // È™åËØÅÂàóÂêç
     const validateColumnName = (column) => {
       const name = column.name.trim()
       
       if (!name) {
         column.nameError = 'ÂàóÂêç‰∏çËÉΩ‰∏∫Á©∫'
         return false
       }
       
       if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(name)) {
         column.nameError = 'ÂàóÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºå‰∏çËÉΩ‰ª•Êï∞Â≠óÂºÄÂ§¥'
         return false
       }
       
       if (name.length > 64) {
         column.nameError = 'ÂàóÂêçÈïøÂ∫¶‰∏çËÉΩË∂ÖËøá64‰∏™Â≠óÁ¨¶'
         return false
       }
       
       // Ê£ÄÊü•ÈáçÂ§çÂàóÂêç
       const duplicateCount = tableDesign.value.columns.filter(col => col.name.trim() === name).length
       if (duplicateCount > 1) {
         column.nameError = 'ÂàóÂêç‰∏çËÉΩÈáçÂ§ç'
         return false
       }
       
       column.nameError = ''
       updateSQL()
       return true
     }
     
     // Êï∞ÊçÆÁ±ªÂûãÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
     const onDataTypeChange = (column) => {
       const dataType = availableDataTypes.value.find(type => type.name === column.dataType)
       if (dataType) {
         // ËÆæÁΩÆÈªòËÆ§ÈïøÂ∫¶
         if (dataType.needsLength) {
           if (column.dataType === 'VARCHAR') {
             column.length = 255
           } else if (column.dataType === 'INT') {
             column.length = 11
           } else if (column.dataType === 'DECIMAL') {
             column.length = 10
             column.decimals = 2
           }
         } else {
           column.length = null
           column.decimals = null
         }
         
         // Ëá™Â¢ûÂè™ËÉΩÁî®‰∫éÊï¥Êï∞Á±ªÂûã
         if (!canAutoIncrement(column)) {
           column.isAutoIncrement = false
         }
       }
       updateSQL()
     }
     
     // ‰∏ªÈîÆÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
     const onPrimaryKeyChange = (column) => {
       if (column.isPrimary) {
         // ËÆæ‰∏∫‰∏ªÈîÆÊó∂ÔºåËá™Âä®ËÆæ‰∏∫ÈùûÁ©∫
         column.isNotNull = true
         // ÂèñÊ∂àÂÖ∂‰ªñÂàóÁöÑ‰∏ªÈîÆ
         tableDesign.value.columns.forEach(col => {
           if (col !== column) {
             col.isPrimary = false
           }
         })
       }
       updateSQL()
     }
     
     // Ê£ÄÊü•Êï∞ÊçÆÁ±ªÂûãÊòØÂê¶ÈúÄË¶ÅÈïøÂ∫¶
     const needsLength = (dataType) => {
       const type = availableDataTypes.value.find(t => t.name === dataType)
       return type ? type.needsLength : false
     }
     
     // Ê£ÄÊü•Êï∞ÊçÆÁ±ªÂûãÊòØÂê¶ÈúÄË¶ÅÂ∞èÊï∞‰Ωç
     const needsDecimals = (dataType) => {
       const type = availableDataTypes.value.find(t => t.name === dataType)
       return type ? type.needsDecimals : false
     }
     
     // Ê£ÄÊü•ÂàóÊòØÂê¶ÂèØ‰ª•ËÆæÁΩÆËá™Â¢û
     const canAutoIncrement = (column) => {
       const integerTypes = ['TINYINT', 'SMALLINT', 'MEDIUMINT', 'INT', 'BIGINT']
       return integerTypes.includes(column.dataType) && column.isPrimary
     }
     
     // Â§ñÈîÆÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
     const onForeignKeyChange = (column) => {
       if (!column.isForeignKey) {
         // ÂèñÊ∂àÂ§ñÈîÆÊó∂Ê∏ÖÁ©∫Áõ∏ÂÖ≥Â≠óÊÆµ
         column.referenceTable = ''
         column.referenceColumn = ''
         column.onUpdate = 'RESTRICT'
         column.onDelete = 'CASCADE'
       } else {
         // ËÆæ‰∏∫Â§ñÈîÆÊó∂ÔºåÂä†ËΩΩÂèØÁî®Ë°®ÂàóË°®
         loadAvailableTables()
       }
       updateSQL()
     }
     
     // ÂºïÁî®Ë°®ÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
     const onReferenceTableChange = (column) => {
       // Ê∏ÖÁ©∫ÂºïÁî®Âàó
       column.referenceColumn = ''
       
       // Âä†ËΩΩÂºïÁî®Ë°®ÁöÑÂàó
       if (column.referenceTable && column.referenceTable.trim()) {
         loadTableColumns(column.referenceTable)
       }
       
       updateSQL()
     }
     
     // ÂºïÁî®ÂàóÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
     const onReferenceColumnChange = (column) => {
       // Ê£ÄÊü•Êï∞ÊçÆÁ±ªÂûãÂåπÈÖç
       if (column.referenceTable && column.referenceColumn) {
         validateDataTypeMatch(column)
       }
       updateSQL()
     }
     
     // È™åËØÅÊï∞ÊçÆÁ±ªÂûãÂåπÈÖç
     const validateDataTypeMatch = (column) => {
       if (!column.referenceTable || !column.referenceColumn) return
       
       const referencedColumns = getTableColumns(column.referenceTable)
       const referencedColumn = referencedColumns.find(col => col.name === column.referenceColumn)
       
       if (referencedColumn) {
         const currentType = column.dataType.toUpperCase()
         const refType = referencedColumn.type.toUpperCase()
         
         // ÁÆÄÂçïÁöÑÊï∞ÊçÆÁ±ªÂûãÂåπÈÖçÊ£ÄÊü•
         const isCompatible = checkDataTypeCompatibility(currentType, refType, column.length)
         
         if (!isCompatible) {
           ElMessage.warning({
             message: `Êï∞ÊçÆÁ±ªÂûãÂèØËÉΩ‰∏çÂåπÈÖçÔºöÂΩìÂâçÂàóÁ±ªÂûã‰∏∫ ${currentType}ÔºåÂºïÁî®ÂàóÁ±ªÂûã‰∏∫ ${refType}„ÄÇÂª∫ËÆÆ‰øùÊåÅÊï∞ÊçÆÁ±ªÂûã‰∏ÄËá¥‰ª•ÈÅøÂÖçÂàõÂª∫Â§±Ë¥•„ÄÇ`,
             duration: 5000
           })
         }
       }
     }
     
     // Ê£ÄÊü•Êï∞ÊçÆÁ±ªÂûãÂÖºÂÆπÊÄß
     const checkDataTypeCompatibility = (currentType, refType, currentLength) => {
       // Ê†áÂáÜÂåñÊï∞ÊçÆÁ±ªÂûã‰ª•‰æøÊØîËæÉ
       const normalizeType = (type) => {
         if (!type) return ''
         
         const upperType = type.toUpperCase()
         
         // ÂØπ‰∫éÊï∞ÂÄºÁ±ªÂûãÔºåÁßªÈô§ÊòæÁ§∫ÂÆΩÂ∫¶ (Â¶Ç INT(11) -> INT)
         const numericTypes = ['TINYINT', 'SMALLINT', 'MEDIUMINT', 'INT', 'BIGINT']
         for (const numType of numericTypes) {
           if (upperType.startsWith(numType)) {
             return numType
           }
         }
         
         // ÂØπ‰∫éÂ≠óÁ¨¶Á±ªÂûãÔºå‰øùÁïô‰ΩÜÊ†áÂáÜÂåñÊ†ºÂºè
         if (upperType.startsWith('VARCHAR')) {
           return 'VARCHAR'
         }
         if (upperType.startsWith('CHAR')) {
           return 'CHAR'
         }
         
         // ÁßªÈô§Êã¨Âè∑‰∏≠ÁöÑÂÜÖÂÆπËé∑ÂèñÂü∫Á°ÄÁ±ªÂûã
         const baseType = upperType.split('(')[0]
         return baseType
       }
       
       const normalizedCurrent = normalizeType(currentType)
       const normalizedRef = normalizeType(refType)
       
       // Ê†áÂáÜÂåñÂêéÁöÑÁ±ªÂûãÂåπÈÖç
       if (normalizedCurrent === normalizedRef) return true
       
       // INT Á≥ªÂàóÁöÑÂÖºÂÆπÊÄßÊ£ÄÊü•ÔºàËôΩÁÑ∂‰∏çÂª∫ËÆÆÊ∑∑Áî®Ôºâ
       const intTypes = ['TINYINT', 'SMALLINT', 'MEDIUMINT', 'INT', 'BIGINT']
       if (intTypes.includes(normalizedCurrent) && intTypes.includes(normalizedRef)) {
         return true // Êï∞ÂÄºÁ±ªÂûã‰πãÈó¥ÂÖºÂÆπÔºå‰ΩÜÂª∫ËÆÆ‰øùÊåÅ‰∏ÄËá¥
       }
       
       return false // ÂÖ∂‰ªñÊÉÖÂÜµÈúÄË¶ÅÂÆåÂÖ®ÂåπÈÖç
     }
     
     // Ëé∑ÂèñÂºïÁî®Ë°®ÁöÑÂàóÂàóË°®
     const getTableColumns = (tableName) => {
       if (!tableName) {
         return []
       }
       
                const columns = referencedTableColumns.value[tableName]
         if (!columns || !Array.isArray(columns)) {
           return []
         }
         
         return columns
     }
     
     // Âä†ËΩΩÂèØÁî®Ë°®ÂàóË°®
     const loadAvailableTables = async () => {
       try {
         const userInfo = userState.getUserInfo()
         // ‰ΩøÁî®‰∏ìÈó®ÁöÑAPIÂáΩÊï∞
         const response = await databaseApi.getAllTables(
           selectedDatabase.value,
           userInfo.userId,
           userInfo.userType
         )
         
         if (response.data && Array.isArray(response.data)) {
           // ÊèêÂèñË°®ÂêçÔºåÊîØÊåÅÂ§öÁßçÊï∞ÊçÆÊ†ºÂºè
           availableTables.value = response.data.map(table => {
             if (typeof table === 'string') {
               return table
             } else if (table && typeof table === 'object') {
               return table.TABLE_NAME || table.tableName || table.name || ''
             }
             return ''
           }).filter(name => name.trim()) // ËøáÊª§Á©∫Â≠óÁ¨¶‰∏≤
         }
       } catch (error) {
         console.error('Âä†ËΩΩË°®ÂàóË°®Â§±Ë¥•:', error)
         availableTables.value = []
       }
     }
     
          // Âä†ËΩΩÊåáÂÆöË°®ÁöÑÂàó‰ø°ÊÅØ
     const loadTableColumns = async (tableName) => {
       try {
         const userInfo = userState.getUserInfo()
         // ‰ΩøÁî®‰∏ìÈó®ÁöÑAPIÂáΩÊï∞
         const response = await databaseApi.getTableColumns(
           tableName,
           selectedDatabase.value,
           userInfo.userId,
           userInfo.userType
         )
         
         if (response.data && Array.isArray(response.data)) {
           // Â§ÑÁêÜËøîÂõûÁöÑÂàóÊï∞ÊçÆ
           referencedTableColumns.value[tableName] = response.data.map(col => ({
             name: col.COLUMN_NAME || col.name,
             type: col.DATA_TYPE || col.type,
             label: `${col.COLUMN_NAME || col.name} (${col.DATA_TYPE || col.type})`
           }))
         } else {
           referencedTableColumns.value[tableName] = []
         }
       } catch (error) {
         console.error(`Âä†ËΩΩË°® ${tableName} ÁöÑÂàó‰ø°ÊÅØÂ§±Ë¥•:`, error)
         referencedTableColumns.value[tableName] = []
       }
     }
     
     // Êõ¥Êñ∞SQLÈ¢ÑËßà
     const updateSQL = () => {
       if (!canGenerateSQL.value) {
         generatedSQL.value = '-- ËØ∑Â°´ÂÜôË°®ÂêçÂíåËá≥Â∞ë‰∏Ä‰∏™Âàó'
         return
       }
       
       try {
         generatedSQL.value = generateCreateTableSQL()
       } catch (error) {
         generatedSQL.value = '-- SQLÁîüÊàêÈîôËØØ: ' + error.message
       }
     }
     
     // ÁîüÊàêCREATE TABLE SQL
     const generateCreateTableSQL = () => {
       const tableName = tableDesign.value.tableName.trim()
       const database = selectedDatabase.value
       const comment = tableDesign.value.tableComment.trim()
       
       let sql = `CREATE TABLE \`${database}\`.\`${tableName}\` (\n`
       
       // ÂàóÂÆö‰πâ
       const columnDefs = []
       const primaryKeys = []
       
       tableDesign.value.columns.forEach(column => {
         if (!column.name.trim() || !column.dataType) return
         
         let columnDef = `  \`${column.name}\` ${column.dataType.toUpperCase()}`
         
         // ÈïøÂ∫¶ÂíåÁ≤æÂ∫¶
         if (needsLength(column.dataType) && column.length) {
           columnDef += `(${column.length}`
           if (needsDecimals(column.dataType) && column.decimals) {
             columnDef += `,${column.decimals}`
           }
           columnDef += ')'
         }
         
         // NOT NULL
         if (column.isNotNull) {
           columnDef += ' NOT NULL'
         }
         
         // AUTO_INCREMENT
         if (column.isAutoIncrement) {
           columnDef += ' AUTO_INCREMENT'
         }
         
         // ÈªòËÆ§ÂÄº
         if (column.defaultValue && column.defaultValue.trim() && !column.isAutoIncrement) {
           const defaultValue = column.defaultValue.trim()
           const stringTypes = ['CHAR', 'VARCHAR', 'TEXT', 'TINYTEXT', 'MEDIUMTEXT', 'LONGTEXT', 'JSON', 'ENUM', 'SET']
           if (stringTypes.includes(column.dataType.toUpperCase())) {
             columnDef += ` DEFAULT '${defaultValue.replace(/'/g, "\\'")}'`
           } else {
             columnDef += ` DEFAULT ${defaultValue}`
           }
         }
         
         // Ê≥®Èáä
         if (column.comment && column.comment.trim()) {
           columnDef += ` COMMENT '${column.comment.trim().replace(/'/g, "\\'")}'`
         }
         
         columnDefs.push(columnDef)
         
         // Êî∂ÈõÜ‰∏ªÈîÆ
         if (column.isPrimary) {
           primaryKeys.push(column.name)
         }
       })
       
       sql += columnDefs.join(',\n')
       
       // ‰∏ªÈîÆÁ∫¶Êùü
       if (primaryKeys.length > 0) {
         sql += ',\n  PRIMARY KEY (' + primaryKeys.map(key => `\`${key}\``).join(', ') + ')'
       }
       
       // Â§ñÈîÆÁ∫¶Êùü
       const foreignKeys = []
       tableDesign.value.columns.forEach(column => {
         if (column.isForeignKey && column.referenceTable && column.referenceColumn) {
           const constraintName = `fk_${tableName}_${column.name}`
           let foreignKeyDef = `  CONSTRAINT \`${constraintName}\` FOREIGN KEY (\`${column.name}\`) `
           foreignKeyDef += `REFERENCES \`${database}\`.\`${column.referenceTable}\` (\`${column.referenceColumn}\`)`
           
           if (column.onUpdate && column.onUpdate !== 'RESTRICT') {
             foreignKeyDef += ` ON UPDATE ${column.onUpdate}`
           }
           if (column.onDelete && column.onDelete !== 'RESTRICT') {
             foreignKeyDef += ` ON DELETE ${column.onDelete}`
           }
           
           foreignKeys.push(foreignKeyDef)
         }
       })
       
       if (foreignKeys.length > 0) {
         sql += ',\n' + foreignKeys.join(',\n')
       }
       
       sql += '\n) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci'
       
       // Ë°®Ê≥®Èáä
       if (comment) {
         sql += ` COMMENT='${comment.replace(/'/g, "\\'")}'`
       }
       
       sql += ';'
       
       return sql
     }
     
     // È¢ÑËßàSQL
     const previewSQL = () => {
       updateSQL()
       ElMessage.success('SQLÂ∑≤Êõ¥Êñ∞')
     }
     
     // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÁîüÊàêSQL
     const canGenerateSQL = computed(() => {
       return tableDesign.value.tableName.trim() && 
              tableDesign.value.columns.length > 0 &&
              tableDesign.value.columns.some(col => col.name.trim() && col.dataType)
     })
     
     // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÂàõÂª∫Ë°®
     const canCreateTable = computed(() => {
       if (!canGenerateSQL.value) return false
       
       // Ê£ÄÊü•Ë°®ÂêçÊòØÂê¶ÊúâÊïà
       const tableName = tableDesign.value.tableName.trim()
       if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(tableName)) return false
       
       // Ê£ÄÊü•ÊâÄÊúâÂàóÂêçÊòØÂê¶ÊúâÊïà‰∏îÊó†ÈáçÂ§ç
       const columnNames = new Set()
       for (const column of tableDesign.value.columns) {
         const name = column.name.trim()
         if (!name || !/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(name)) return false
         if (columnNames.has(name)) return false
         columnNames.add(name)
       }
       
       return true
     })
     
     // Á°ÆËÆ§ÂàõÂª∫Ë°®
     const confirmCreateTable = async () => {
       if (!canCreateTable.value) {
         ElMessage.error('Ë°®ËÆæËÆ°‰∏çÂÆåÊï¥ÔºåËØ∑Ê£ÄÊü•')
         return
       }
       
       try {
         // Ë°®ÂçïÈ™åËØÅ
         if (tableFormRef.value) {
           const valid = await tableFormRef.value.validate()
           if (!valid) return
         }
         
         creatingTable.value = true
         
         const userInfo = userState.getUserInfo()
         const requestData = {
           tableName: tableDesign.value.tableName.trim(),
           tableComment: tableDesign.value.tableComment.trim(),
           databaseName: selectedDatabase.value,
                       dataSource: 'login',
           columns: tableDesign.value.columns.map(col => ({
             name: col.name.trim(),
             dataType: col.dataType,
             length: col.length,
             decimals: col.decimals,
             isPrimary: col.isPrimary,
             isNotNull: col.isNotNull,
             isAutoIncrement: col.isAutoIncrement,
             defaultValue: col.defaultValue ? col.defaultValue.trim() : null,
             comment: col.comment ? col.comment.trim() : null,
             // Â§ñÈîÆÁõ∏ÂÖ≥Â≠óÊÆµ
             isForeignKey: col.isForeignKey,
             referenceTable: col.referenceTable || null,
             referenceColumn: col.referenceColumn || null,
             onUpdate: col.onUpdate || 'RESTRICT',
             onDelete: col.onDelete || 'CASCADE'
           })).filter(col => col.name && col.dataType),
           userId: userInfo.userId,
           userType: userInfo.userType
         }
         
         const response = await api.post('/api/database/tables/create', requestData)
         
         if (response.data.success) {
           ElMessage.success(response.data.message)
           createTableDialogVisible.value = false
           
           // Âà∑Êñ∞Ë°®ÂàóË°®
           await loadTables(false)
         } else {
           ElMessage.error(response.data.error || 'ÂàõÂª∫Ë°®Â§±Ë¥•')
         }
         
       } catch (error) {
         console.error('ÂàõÂª∫Ë°®Â§±Ë¥•:', error)
         const errorMsg = error.response?.data?.error || error.message
         
         // Êèê‰æõÊõ¥ÂèãÂ•ΩÁöÑÈîôËØØ‰ø°ÊÅØ
         let friendlyMessage = 'ÂàõÂª∫Ë°®Â§±Ë¥•'
         
         if (errorMsg) {
           if (errorMsg.includes('Â§ñÈîÆÁ∫¶ÊùüÂàõÂª∫Â§±Ë¥•') || errorMsg.includes('Êï∞ÊçÆÁ±ªÂûã') || errorMsg.includes('‰∏çÂåπÈÖç')) {
             friendlyMessage = 'Â§ñÈîÆËÆæÁΩÆÊúâËØØÔºö' + errorMsg
           } else if (errorMsg.includes('Ë°®Â∑≤Â≠òÂú®')) {
             friendlyMessage = 'Ë°®ÂêçÂ∑≤Ë¢´‰ΩøÁî®ÔºåËØ∑Êõ¥Êç¢ÂÖ∂‰ªñË°®Âêç'
           } else if (errorMsg.includes('ÂàóÂêçÈáçÂ§ç')) {
             friendlyMessage = 'Â≠òÂú®ÈáçÂ§çÁöÑÂàóÂêçÔºåËØ∑Ê£ÄÊü•Âπ∂‰øÆÊîπ'
           } else if (errorMsg.includes('ÊùÉÈôê')) {
             friendlyMessage = 'ÊùÉÈôê‰∏çË∂≥ÔºåÊó†Ê≥ïÂàõÂª∫Ë°®'
           } else if (errorMsg.includes('‰∏çÂ≠òÂú®')) {
             friendlyMessage = 'ÂºïÁî®ÁöÑË°®ÊàñÂàó‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•Â§ñÈîÆËÆæÁΩÆ'
           } else if (errorMsg.includes('Ë∂ÖÈôê') || errorMsg.includes('too long')) {
             friendlyMessage = 'Â≠óÊÆµÈïøÂ∫¶ËÆæÁΩÆËøáÂ§ßÔºåËØ∑ÈÄÇÂΩìË∞ÉÊï¥'
           } else {
             friendlyMessage = 'ÂàõÂª∫Ë°®Â§±Ë¥•Ôºö' + errorMsg
           }
         }
         
         ElMessage.error(friendlyMessage)
       } finally {
         creatingTable.value = false
       }
     }
     
     // ÂèñÊ∂àÂàõÂª∫Ë°®
     const cancelCreateTable = () => {
       createTableDialogVisible.value = false
       tableDesign.value = {
         tableName: '',
         tableComment: '',
         columns: []
       }
       generatedSQL.value = ''
     }
      
      // Â∑¶‰æßÊï∞ÊçÆÂ∫ìÈÄâÊã©ÊñπÊ≥ï
      const selectDatabase = (databaseName) => {
        selectedDatabase.value = databaseName
        switchDatabase()
      }
      
      // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠Êï∞ÊçÆÂ∫ìÁöÑ‰ø°ÊÅØ
          const getSelectedDatabaseInfo = () => {
      return availableDatabases.value.find(db => db.name === selectedDatabase.value)
    }

    // ‰∏∫‰∏çÂêåÊï∞ÊçÆÂ∫ìÂàÜÈÖçÈ¢úËâ≤
    const getDatabaseColor = (dataSource) => {
      if (!dataSource) return '#dcdfe6'
      
      const colors = [
        '#409eff', // ËìùËâ≤
        '#67c23a', // ÁªøËâ≤  
        '#e6a23c', // Ê©ôËâ≤
        '#f56c6c', // Á∫¢Ëâ≤
        '#909399', // ÁÅ∞Ëâ≤
        '#9b59b6', // Á¥´Ëâ≤
        '#17a2b8', // ÈùíËâ≤
        '#fd7e14'  // Ê∑±Ê©ôËâ≤
      ]
      
      // Ê†πÊçÆÊï∞ÊçÆÂ∫ìÂêçÁß∞ÁîüÊàê‰∏Ä‰∏™Á®≥ÂÆöÁöÑÈ¢úËâ≤Á¥¢Âºï
      let hash = 0
      for (let i = 0; i < dataSource.length; i++) {
        hash = ((hash << 5) - hash) + dataSource.charCodeAt(i)
        hash = hash & hash // ËΩ¨Êç¢‰∏∫32‰ΩçÊï¥Êï∞
      }
      
      return colors[Math.abs(hash) % colors.length]
    }
      
      // Âä®ÊÄÅËÆ°ÁÆóË°®Ê†ºÊúÄÂ§ßÈ´òÂ∫¶
      const tableMaxHeight = ref(450)
      
      const getTableMaxHeight = () => {
        return tableMaxHeight.value
      }
      
      const updateTableHeight = () => {
        // Âü∫‰∫éËßÜÂè£È´òÂ∫¶ËÆ°ÁÆóÔºåÂáèÂéªÂ§¥ÈÉ®„ÄÅÂØºËà™„ÄÅÂç°ÁâáÊ†áÈ¢òÁ≠âÈ´òÂ∫¶
        const baseHeight = window.innerHeight - 380 // 380pxÊòØÂÖ∂‰ªñÂÖÉÁ¥†ÁöÑÂ§ßÊ¶ÇÈ´òÂ∫¶
        tableMaxHeight.value = Math.max(baseHeight, 300) // ÊúÄÂ∞èÈ´òÂ∫¶300px
      }

      const loadDatabaseInfo = async () => {
        try {
          console.log('ÂºÄÂßãÂä†ËΩΩÊï∞ÊçÆÂ∫ì‰ø°ÊÅØ:', selectedDatabase.value)
          const response = await api.get(`/api/database/info?database=${selectedDatabase.value}`)
          databaseInfo.value = {
            name: selectedDatabase.value,
            tableCount: response.data.tableCount || 0,
            sizeDisplay: formatBytes(response.data.totalSize || 0)
          }
          console.log('Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÂä†ËΩΩÊàêÂäü:', databaseInfo.value)
        } catch (error) {
          console.error('Âä†ËΩΩÊï∞ÊçÆÂ∫ì‰ø°ÊÅØÂ§±Ë¥•:', error)
          // ËÆæÁΩÆÈªòËÆ§ÂÄºÔºå‰ΩøÁî®ÂΩìÂâçÁöÑË°®ÂàóË°®ÈïøÂ∫¶‰Ωú‰∏∫Ë°®Êï∞Èáè
          databaseInfo.value = {
            name: selectedDatabase.value,
            tableCount: tableList.value?.length || 0,
            sizeDisplay: 'N/A'
          }
          console.log('‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÂ∫ì‰ø°ÊÅØ:', databaseInfo.value)
        }
      }

      const loadAvailableDatabases = async () => {
        try {
          const userInfo = userState.getUserInfo()
          
          // Â∞ùËØïËé∑ÂèñÊâÄÊúâÊï∞ÊçÆÂ∫ìÔºàÂåÖÊã¨Áî®Êà∑ÂàõÂª∫ÁöÑÔºâ
          const response = await api.get('/api/database/all', {
            params: {
              dataSource: 'login',
              userId: userInfo.userId,
              userType: userInfo.userType
            }
          })
          availableDatabases.value = response.data
        } catch (error) {
          console.error('Âä†ËΩΩÂÆåÊï¥Êï∞ÊçÆÂ∫ìÂàóË°®Â§±Ë¥•ÔºåÂ∞ùËØïËé∑ÂèñÈªòËÆ§ÂàóË°®:', error)
          
          // Â¶ÇÊûúËé∑ÂèñÂÆåÊï¥ÂàóË°®Â§±Ë¥•ÔºåÂ∞ùËØïËé∑ÂèñÈªòËÆ§Êï∞ÊçÆÂ∫ìÂàóË°®
          try {
            const fallbackResponse = await api.get('/api/database/databases')
            availableDatabases.value = fallbackResponse.data
          } catch (fallbackError) {
            console.error('Âä†ËΩΩÈªòËÆ§Êï∞ÊçÆÂ∫ìÂàóË°®‰πüÂ§±Ë¥•:', fallbackError)
            // Â¶ÇÊûúÈÉΩÂ§±Ë¥•Ôºå‰ΩøÁî®Á°¨ÁºñÁ†ÅÁöÑÈªòËÆ§Êï∞ÊçÆÂ∫ì
          availableDatabases.value = [
            { name: 'login', displayName: 'Login Database', description: 'Áî®Êà∑ÁôªÂΩïÊï∞ÊçÆÂ∫ìÔºà‰ªÖÁÆ°ÁêÜÂëòÔºâ' }
          ]
          }
        }
      }

      // =============================================================================
      // Âà†Èô§Ë°®Áõ∏ÂÖ≥ÊñπÊ≥ï
      // =============================================================================
      
      // Á°ÆËÆ§Âà†Èô§Ë°®
      const confirmDeleteTable = async (tableName) => {
        try {
          const userInfo = userState.getUserInfo()
          
          // ÊùÉÈôêÊ£ÄÊü•
          if (!canModifyCurrentDatabase.value) {
            ElMessage.error('ÊÇ®Ê≤°ÊúâÊùÉÈôêÂà†Èô§Ë°®')
            return
          }
          
          // Á°ÆËÆ§ÂØπËØùÊ°Ü
          const result = await ElMessageBox.confirm(
            `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°® "${tableName}" ÂêóÔºü\n\nË≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ë°®ÂèäÂÖ∂ÊâÄÊúâÊï∞ÊçÆÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ`,
            'Á°ÆËÆ§Âà†Èô§Ë°®',
            {
              confirmButtonText: 'Á°ÆÂÆöÂà†Èô§',
              cancelButtonText: 'ÂèñÊ∂à',
              type: 'warning',
              dangerouslyUseHTMLString: false
            }
          )

          if (result === 'confirm') {
            await deleteTable(tableName)
          }
        } catch (error) {
          // Áî®Êà∑ÂèñÊ∂àÂà†Èô§Ôºå‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
          if (error !== 'cancel') {
            console.error('Âà†Èô§Ë°®Á°ÆËÆ§Âá∫Èîô:', error)
          }
        }
      }

      // Âà†Èô§Ë°®
      const deleteTable = async (tableName) => {
        try {
          const userInfo = userState.getUserInfo()
          
          const requestData = {
            dataSource: 'login',
            databaseName: selectedDatabase.value,
            tableName: tableName,
            userId: userInfo.userId,
            userType: userInfo.userType
          }
          
          const response = await api.delete('/api/database/tables/drop', {
            data: requestData
          })
          
          if (response.data.success) {
            ElMessage.success(`Ë°® "${tableName}" Âà†Èô§ÊàêÂäü`)
            
            // Âà∑Êñ∞Ë°®ÂàóË°®
            await loadTables(false)
          } else {
            ElMessage.error(response.data.error || 'Âà†Èô§Ë°®Â§±Ë¥•')
          }
          
        } catch (error) {
          console.error('Âà†Èô§Ë°®Â§±Ë¥•:', error)
          const errorMsg = error.response?.data?.error || error.message
          ElMessage.error('Âà†Èô§Ë°®Â§±Ë¥•: ' + errorMsg)
        }
      }

      // ‰øÆÊîπË°®ÁªìÊûÑÁõ∏ÂÖ≥ÊñπÊ≥ï
      const showModifyColumnDialog = async (column) => {
        // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÁ±ªÂûã
        await loadDataTypes()
        
        modifyColumn.value = column
        modifyColumnForm.value = {
          columnName: column.COLUMN_NAME,
          currentType: column.DATA_TYPE,
          newDataType: column.DATA_TYPE,
          newLength: '',
          newDecimals: ''
        }
        modifyColumnDialogVisible.value = true
      }

      const confirmModifyColumn = async () => {
        try {
          // Ë°®ÂçïÈ™åËØÅ
          if (modifyColumnFormRef.value) {
            const valid = await modifyColumnFormRef.value.validate()
            if (!valid) return
          }

          modifyingColumn.value = true

          const userInfo = userState.getUserInfo()
          const requestData = {
            dataSource: selectedDatabase.value,
            databaseName: selectedDatabase.value,
            tableName: selectedTable.value,
            columnName: modifyColumnForm.value.columnName,
            newDataType: modifyColumnForm.value.newDataType,
            newLength: modifyColumnForm.value.newLength || null,
            newDecimals: modifyColumnForm.value.newDecimals || null,
            userId: userInfo.userId,
            userType: userInfo.userType
          }

          const response = await api.put('/api/database/tables/modify', requestData)

          if (response.data.success) {
            ElMessage.success('Ë°®ÁªìÊûÑ‰øÆÊîπÊàêÂäü')
            modifyColumnDialogVisible.value = false
            
            // ÈáçÊñ∞Âä†ËΩΩË°®ÁªìÊûÑ
            await viewTableStructure(selectedTable.value)
          } else {
            ElMessage.error(response.data.error || '‰øÆÊîπË°®ÁªìÊûÑÂ§±Ë¥•')
          }

        } catch (error) {
          console.error('‰øÆÊîπË°®ÁªìÊûÑÂ§±Ë¥•:', error)
          const errorMsg = error.response?.data?.error || error.message
          ElMessage.error('‰øÆÊîπË°®ÁªìÊûÑÂ§±Ë¥•: ' + errorMsg)
        } finally {
          modifyingColumn.value = false
        }
      }

      // ËÆ°ÁÆóÂ±ûÊÄßÔºöËøáÊª§ÂêéÁöÑË°®ÂàóË°®
      const filteredTableList = computed(() => {
        if (!searchQuery.value) {
          return tableList.value
        }
        return tableList.value.filter(table => 
          table.TABLE_NAME.toLowerCase().includes(searchQuery.value.toLowerCase())
        )
      })
      
      // ËÆ°ÁÆóÊúÄÂ∞èÂåñÂØπËØùÊ°ÜÁöÑ‰ΩçÁΩÆ
      const getMinimizedDialogPosition = (dialogId) => {
        const minimizedDialogs = searchDialogsState.searchDialogs.filter(d => d.minimized)
        const index = minimizedDialogs.findIndex(d => d.id === dialogId)
        return 20 + (index * 60)
      }

      onMounted(() => {
        // ÂàùÂßãÂåñÊùÉÈôêÁä∂ÊÄÅ
        updatePermissionState()
        loadAvailableDatabases()
        
        // ÂàùÂßãÂåñË°®Ê†ºÈ´òÂ∫¶
        updateTableHeight()
        
        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', updateTableHeight)
        
        // Ê∏ÖÁêÜËøáÊúüÁöÑË°®Ë°åÊï∞ÁºìÂ≠ò
        cleanExpiredRowCountCache()
        
            // ÊÅ¢Â§çÊêúÁ¥¢ÂØπËØùÊ°ÜÊï∞ÊçÆ
    searchDialogsState.loadFromStorage()
        
        // Âè™ÊúâÂú®Áî®Êà∑Â∑≤ÁôªÂΩïÊó∂ÊâçÂä†ËΩΩÊï∞ÊçÆ
        const userInfo = userState.getUserInfo()
        if (userInfo.userId && userInfo.userType) {
          loadTables(false)
          loadDatabaseInfo()
        }
      })
      
      // ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñÔºåÂΩì‰ªéÂÖ∂‰ªñÈ°µÈù¢ËøîÂõûÊó∂Ê£ÄÊü•Êï∞ÊçÆÊõ¥Êñ∞
      watch(() => route.path, (newPath, oldPath) => {
        // ÂΩìË∑ØÁî±ÂàáÊç¢Âà∞ÂΩìÂâçÈ°µÈù¢Êó∂ÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂà∑Êñ∞Êï∞ÊçÆ
        if (newPath === '/tables' && oldPath && oldPath !== '/tables') {
          if (checkDataUpdate()) {
            console.log('Ê£ÄÊµãÂà∞Êï∞ÊçÆÊõ¥Êñ∞ÔºåËá™Âä®Âà∑Êñ∞Ë°®ÂàóË°®')
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆöË°®ÈúÄË¶ÅÊõ¥Êñ∞Ë°åÊï∞
            try {
              const updatedTables = JSON.parse(localStorage.getItem('updatedTables') || '[]')
              if (updatedTables.length > 0) {
                console.log('Ê£ÄÊµãÂà∞ÁâπÂÆöË°®Êõ¥Êñ∞ÔºåÂè™Êõ¥Êñ∞Ëøô‰∫õË°®ÁöÑË°åÊï∞:', updatedTables)
                
                // Âè™Êõ¥Êñ∞ÁâπÂÆöË°®ÁöÑË°åÊï∞ÔºåËÄå‰∏çÊòØÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™Ë°®ÂàóË°®
                updatedTables.forEach(tableName => {
                  updateTableRowCount(tableName)
                })
                
                // Ê∏ÖÁ©∫Â∑≤Êõ¥Êñ∞ÁöÑË°®ÂàóË°®
                localStorage.removeItem('updatedTables')
              } else {
                // Ê≤°ÊúâÁâπÂÆöË°®Êõ¥Êñ∞ÔºåÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™Ë°®ÂàóË°®
                loadTables(false)
                loadDatabaseInfo()
              }
            } catch (error) {
              console.error('Ê£ÄÊü•ÁâπÂÆöË°®Êõ¥Êñ∞Â§±Ë¥•:', error)
              // Âá∫ÈîôÊó∂ÂõûÈÄÄÂà∞ÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™Ë°®ÂàóË°®
              loadTables(false)
              loadDatabaseInfo()
            }
          }
        }
      })
      
      onActivated(() => {
        // ÂΩìÁªÑ‰ª∂Ë¢´ÊøÄÊ¥ªÊó∂Ôºà‰ªéÂÖ∂‰ªñÈ°µÈù¢ËøîÂõûÔºâÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂà∑Êñ∞Êï∞ÊçÆ
        if (checkDataUpdate()) {
          console.log('Ê£ÄÊµãÂà∞Êï∞ÊçÆÊõ¥Êñ∞ÔºåËá™Âä®Âà∑Êñ∞Ë°®ÂàóË°®')
          loadTables(false)
          loadDatabaseInfo()
        }
      })
      
      onUnmounted(() => {
        // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
        window.removeEventListener('resize', updateTableHeight)
      })

    return {
      tableList,
      selectedTable,
      structureDialogVisible,
      dataDialogVisible,
      addDataDialogVisible,
      editDataDialogVisible,
      tableColumns,
      tableData,
      dataLimit,
      newRowData,
      editRowData,
      originalRowData,
      submitting,
      hasPrimaryKey,
      tableDataLoading,
      pagination,
      loadTables,
      selectTable,
      viewTableStructure,
      viewTableData,
      loadTableData,
      loadTableDataWithPagination,
      loadSearchResultDataWithPagination,
      handleSizeChange,
      handleCurrentChange,
      changePageSize,
      showAddDataDialog,
      submitNewData,
      editRow,
      submitEditData,
      getColumnPlaceholder,
      getColumnTagType,
      getColumnDescription,
      isEnumType,
      getEnumValues,
      confirmDeleteRow,
      deleteRow,
      formatBytes,
      formatDate,
      getColumnWidth,
      Delete,
      Edit,
      searchQuery,
      loadingTables,
      databaseInfo,
      selectedDatabase,
      availableDatabases,
      switchDatabase,
      selectDatabase,
      getSelectedDatabaseInfo,
      getTableMaxHeight,
      tableMaxHeight,
      updateTableHeight,
      filteredTableList,
      loadAvailableDatabases,
      // Êñ∞Âª∫Êï∞ÊçÆÂ∫ìÁõ∏ÂÖ≥
      createDatabaseDialogVisible,
      creatingDatabase,
      databaseFormRef,
      newDatabaseForm,
      databaseRules,
      showCreateDatabaseDialog,
      createDatabase,
      // Âà†Èô§Êï∞ÊçÆÂ∫ìÁõ∏ÂÖ≥
      deleteDatabaseDialogVisible,
      deletingDatabase,
      databaseToDelete,
      deleteConfirmText,
      canDeleteDatabase,
      showDeleteDatabaseDialog,
      cancelDeleteDatabase,
      confirmDeleteDatabase,
      // Ë°®ËÆæËÆ°Âô®Áõ∏ÂÖ≥
      createTableDialogVisible,
      creatingTable,
      tableFormRef,
      tableDesign,
      tableRules,
      modifyColumnRules,
      availableDataTypes,
      groupedDataTypes,
      generatedSQL,
      isUserDatabase,
      showCreateTableDialog,
      addColumn,
      removeColumn,
      moveColumnUp,
      moveColumnDown,
      validateColumnName,
      onDataTypeChange,
      onPrimaryKeyChange,
      needsLength,
      needsDecimals,
      canAutoIncrement,
      updateSQL,
      previewSQL,
      canGenerateSQL,
      canCreateTable,
      confirmCreateTable,
      // Â§ñÈîÆÁõ∏ÂÖ≥
      hasAnyForeignKey,
      availableTables,
      referencedTableColumns,
      onForeignKeyChange,
      onReferenceTableChange,
      onReferenceColumnChange,
      getTableColumns,
      loadAvailableTables,
      loadTableColumns,
      validateDataTypeMatch,
      checkDataTypeCompatibility,
      cancelCreateTable,
      // ÊùÉÈôêÁõ∏ÂÖ≥
      canAccessCurrentDatabase,
      canModifyCurrentDatabase,
      canCreateDatabase,
      permissionMessage,
      checkDatabasePermission,
      updatePermissionState,
      // Êï∞ÊçÆÊõ¥Êñ∞Ê£ÄÊµãÁõ∏ÂÖ≥
      checkDataUpdate,
      markDataUpdated,
      markTableUpdated,
      updateTableRowCount,
      getTableRowCount,
      refreshTableRowCount,
      loadTableRowCountFromCache,
      saveTableRowCountToCache,
      // Âà†Èô§Ë°®Áõ∏ÂÖ≥
      confirmDeleteTable,
      deleteTable,
      // Â≠óÊÆµÊêúÁ¥¢Áõ∏ÂÖ≥
      fieldSearchQuery,
      searchMode,
      currentSearchType,
      fieldSearching,
      fieldSearchResult,
      fieldSearchError,
      fieldSearchResultDialogVisible,
      handleSearchCommand,
      searchTablesByFieldValue,
      viewSearchResultData,
      clearFieldSearch,
      cellContainsSearchValue,
      // Â§öÂºπÁ™óÁÆ°ÁêÜ
      searchDialogs,
      createNewSearchDialog,
      minimizeDialog,
      restoreDialog,
      closeDialog,
      clearSingleSearch,
      clearAllSearches,
      clearSearchesByDatabase,
      getMinimizedDialogPosition,
      // ÊêúÁ¥¢ËøõÂ∫¶Áõ∏ÂÖ≥
      searchProgressDialogVisible,
      currentSearchValue,
      searchProgressPercentage,
      searchProgressText,
      currentSearchingTable,
      foundTablesCount,
      totalTablesCount,
      searchElapsedTime,
      cancelling,
      showSearchProgressDialog,
      closeSearchProgressDialog,
      formatElapsedTime,
      cancelSearch,
      getSelectedDatabaseInfo,
      getDatabaseColor,
      // ‰øÆÊîπË°®ÁªìÊûÑÁõ∏ÂÖ≥
      modifyColumnDialogVisible,
      modifyingColumn,
      modifyColumnFormRef,
      modifyColumn,
      modifyColumnForm,
      dataTypeGroups,
      primaryKeyColumns,
      showModifyColumnDialog,
      confirmModifyColumn,
      // ÂØºÂá∫Áõ∏ÂÖ≥
      exportDialogVisible,
      exportTableName,
      showExportDialog,
      closeExportDialog
    }
  }
}
</script>

<style scoped>
.database-view {
  padding: 20px 15px 20px 10px;
  height: calc(100vh - 120px);
}

.database-layout {
  display: flex;
  height: 100%;
  gap: 25px;
}

/* Â∑¶‰æßÊï∞ÊçÆÂ∫ìÂØºËà™Ê†è */
.database-sidebar {
  width: 240px;
  flex-shrink: 0;
}

.sidebar-card {
  height: 100%;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: #303133;
}

.sidebar-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.database-list {
  max-height: calc(100vh - 250px);
  overflow-y: auto;
  padding-bottom: 8px;
}

.database-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  margin-bottom: 8px;
  border-radius: 6px;
  transition: all 0.2s;
  border: 1px solid transparent;
  position: relative;
}

.database-item:last-child {
  margin-bottom: 0;
}

.database-item:hover {
  background-color: #f5f7fa;
  border-color: #e4e7ed;
}

.database-item.active {
  background-color: #ecf5ff;
  border-color: #409eff;
  color: #409eff;
}

.database-content {
  display: flex;
  align-items: center;
  flex: 1;
  cursor: pointer;
  min-width: 0;
}

.database-actions {
  display: flex;
  align-items: center;
  opacity: 0;
  transition: opacity 0.2s;
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
}

.database-item:hover .database-actions {
  opacity: 1;
}

.database-icon {
  margin-right: 12px;
  font-size: 18px;
  color: #909399;
}

.card-title {
  display: flex;
  align-items: center;
}

/* Ë°®ËÆæËÆ°Âô®Ê†∑Âºè */
.table-designer {
  max-height: 70vh;
  overflow-y: auto;
}

.basic-info-card,
.columns-card,
.sql-preview-card {
  border: 1px solid #e4e7ed;
}

.empty-columns {
  text-align: center;
  padding: 40px 0;
}

.columns-editor {
  max-height: 400px;
  overflow-y: auto;
}

.database-item.active .database-icon {
  color: #409eff;
}

.database-info {
  flex: 1;
  min-width: 0;
  text-align: center;
}

.database-name {
  font-weight: 500;
  font-size: 14px;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.database-desc {
  font-size: 12px;
  color: #909399;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.database-item.active .database-desc {
  color: #73b3ff;
}

/* Âè≥‰æßÂÜÖÂÆπÂå∫Âüü */
.database-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 15px;
  min-width: 0;
  overflow: hidden;
  width: 100%;
  max-width: none;
}

.database-content-layout {
  display: flex;
  flex-direction: column;
  gap: 15px;
  height: 100%;
  overflow: hidden;
  width: 100%;
  max-width: none;
}

/* Êï∞ÊçÆÂ∫ì‰ø°ÊÅØÂç°Áâá */
.database-info-card {
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  width: 100%;
  max-width: none;
  flex-shrink: 0;
}

.database-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #303133;
}

.tables-card {
  flex: 1;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  width: 100%;
  max-width: none;
}

.tables-card .el-card__body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
  max-height: calc(100vh - 320px);
  width: 100%;
  max-width: none;
}

.tables-card .el-table {
  flex: 1;
  width: 100% !important;
}

.el-table {
  width: 100% !important;
}

.el-row {
  width: 100%;
}

.el-col {
  width: 100%;
}

.table-container {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: none;
}

.table-container .el-table {
  flex: 1;
  width: 100%;
}

.welcome-card {
  flex: 1;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: none;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: none;
}

.el-table .el-table__row {
  cursor: pointer;
}

.el-table .el-table__row:hover {
  background-color: #f5f7fa;
}

.table-actions {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.action-btn {
  margin: 0 !important;
  min-width: 60px;
  height: 28px;
  font-size: 12px;
  border-radius: 4px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.action-btn .el-icon {
  margin-right: 4px;
}

/* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
.database-list::-webkit-scrollbar,
.tables-card .el-card__body::-webkit-scrollbar,
.el-table__body-wrapper::-webkit-scrollbar {
  width: 6px;
}

/* Êï∞ÊçÆÂ∫ìÂØºËà™Ê†èÈªòËÆ§ÈöêËóèÊªöÂä®Êù° */
.database-list::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 3px;
}

.database-list::-webkit-scrollbar-thumb {
  background: transparent;
  border-radius: 3px;
}

/* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Êï∞ÊçÆÂ∫ìÂØºËà™Ê†èÊªöÂä®Êù° */
.database-list:hover::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.database-list:hover::-webkit-scrollbar-thumb {
  background: #c1c1c1;
}

.database-list:hover::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* ÂÖ∂‰ªñÂå∫ÂüüÁöÑÊªöÂä®Êù°Ê†∑Âºè‰øùÊåÅ‰∏çÂèò */
.tables-card .el-card__body::-webkit-scrollbar-track,
.el-table__body-wrapper::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.tables-card .el-card__body::-webkit-scrollbar-thumb,
.el-table__body-wrapper::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.tables-card .el-card__body::-webkit-scrollbar-thumb:hover,
.el-table__body-wrapper::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Á°Æ‰øùÊªöÂä®Êù°‰∏ç‰ºöÈÅÆÊå°ÂÜÖÂÆπ */
.database-list {
  scrollbar-gutter: stable;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .database-sidebar {
    width: 210px;
  }
  
  .database-info-card {
    width: 100%;
    max-width: none;
  }
  
  .database-name {
    font-size: 13px;
  }
  
  .database-desc {
    font-size: 11px;
  }
}

@media (max-width: 900px) {
  .database-layout {
    flex-direction: column;
    height: auto;
    gap: 10px;
  }
  
  .database-sidebar {
    width: 100%;
    height: auto;
  }
  
  .database-list {
    max-height: 300px;
    padding-bottom: 8px;
  }
  
  .database-info-card {
    width: 100%;
    max-width: none;
  }
  
  .tables-card {
    width: 100%;
    max-width: none;
  }
  
  .welcome-card {
    width: 100%;
    max-width: none;
  }
  
  .database-view {
    height: auto;
  }
}

.minimized-dialog {
  position: fixed;
  background-color: #fff;
  border: 1px solid #dcdfe6;
  border-radius: 8px;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
  z-index: 2000;
  min-width: 250px;
  max-width: 350px;
}

.minimized-dialog:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  transform: translateY(-2px);
}

.minimized-content {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.search-value {
  font-weight: 500;
  color: #303133;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100px;
}

.search-result-database-info {
  font-size: 11px;
  color: #909399;
  background-color: #f4f4f5;
  padding: 2px 4px;
  border-radius: 4px;
  white-space: nowrap;
  margin: 0 2px;
}

.match-count {
  font-size: 12px;
  color: #fff;
  background-color: #e6a23c;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 500;
  white-space: nowrap;
}

.close-btn {
  margin-left: 8px;
  flex-shrink: 0;
}

.dialog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.dialog-header h4 {
  margin: 0;
  font-size: 16px;
  color: #303133;
  flex: 1;
}

.dialog-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.minimize-btn {
  color: #606266 !important;
  transition: color 0.2s ease;
  border: none !important;
  background: transparent !important;
  padding: 4px 5px 15px 10px !important;
  box-shadow: none !important;
  outline: none !important;
}

.minimize-btn:hover {
  color: #409eff !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  outline: none !important;
}

.minimize-btn:focus {
  border: none !important;
  box-shadow: none !important;
  outline: none !important;
}

.minimize-btn .el-icon {
  font-size: 16px;
}

.search-progress-content {
  padding: 20px;
  text-align: center;
}

.progress-header {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 10px;
}

.spinning-icon {
  margin-right: 10px;
}

.progress-title {
  font-size: 16px;
  font-weight: 600;
}

.progress-info {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.search-info {
  margin-bottom: 15px;
}

.progress-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.progress-text {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.current-progress {
  font-size: 14px;
  color: #303133;
}

.time-info {
  font-size: 12px;
  color: #909399;
}

.current-table {
  margin-top: 10px;
  text-align: left;
}

.found-info {
  margin-top: 10px;
  text-align: left;
}

.cancel-search {
  margin-top: 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.spinning-icon {
  animation: spin 2s linear infinite;
  color: #409eff;
  font-size: 20px;
}
</style> 